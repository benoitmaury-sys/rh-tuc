<!DOCTYPE html>
<html lang="fr">
<script>
        // ============================================
        // API CLIENT - Connexion au backend Railway
        // ============================================
        const ApiClient = {
            baseURL: API_CONFIG.baseURL,
            token: null,

            setToken(token) {
                this.token = token;
                if (token) {
                    localStorage.setItem('authToken', token);
                } else {
                    localStorage.removeItem('authToken');
                }
            },

            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (this.token) {
                    headers['Authorization'] = `Bearer ${this.token}`;
                }

                const config = {
                    ...options,
                    headers
                };

                try {
                    const response = await fetch(url, config);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || data.message || 'Erreur réseau');
                    }

                    return data;
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            },

            async login(email, password) {
                const data = await this.request('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                if (data.token) {
                    this.setToken(data.token);
                }

                return data;
            },

            async register(userData) {
                const data = await this.request('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });

                if (data.token) {
                    this.setToken(data.token);
                }

                return data;
            }
        };

        // Charger le token au démarrage
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            if (token) {
                ApiClient.setToken(token);
            }
        });
    </script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RH TUC - Gestion RH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
     <script src="config.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .transition-all {
            transition: all 0.3s ease;
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 260px;
            background: white;
            border-right: 1px solid #e5e7eb;
            z-index: 40;
            transition: transform 0.3s ease;
        }

        .dark .sidebar {
            background: #1f2937;
            border-right-color: #374151;
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 30;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Mobile: sidebar hidden by default */
        @media (max-width: 767px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
        }

        /* Desktop: sidebar always visible */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0) !important;
            }
            .sidebar-overlay {
                display: none !important;
            }
        }

        .main-content {
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }

        @media (min-width: 768px) {
            .main-content {
                margin-left: 260px;
            }
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: #f3f4f6;
            color: #111827;
        }

        .dark .nav-item:hover {
            background: #374151;
            color: #f9fafb;
        }

        .nav-item.active {
            background: #5D5CDE;
            color: white;
        }

        .nav-item.active:hover {
            background: #4a49c5;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div id="app"></div>

    <script>
        // Initialisation du mode sombre
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Système de stockage en mémoire (remplace storage)
        const storage = {
            data: {},
            getItem(key) {
                return this.data[key] || null;
            },
            setItem(key, value) {
                this.data[key] = value;
            },
            removeItem(key) {
                delete this.data[key];
            }
        };

        // Fonction pour générer les jours fériés français pour une année donnée
        function getFrenchPublicHolidays(year) {
            const holidays = [];

            // Jours fériés fixes
            holidays.push(`${year}-01-01`); // Jour de l'an
            holidays.push(`${year}-05-01`); // Fête du travail
            holidays.push(`${year}-05-08`); // Victoire 1945
            holidays.push(`${year}-07-14`); // Fête nationale
            holidays.push(`${year}-08-15`); // Assomption
            holidays.push(`${year}-11-01`); // Toussaint
            holidays.push(`${year}-11-11`); // Armistice 1918
            holidays.push(`${year}-12-25`); // Noël

            // Calcul de Pâques (algorithme de Meeus/Jones/Butcher)
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31);
            const day = ((h + l - 7 * m + 114) % 31) + 1;

            const easter = new Date(year, month - 1, day);

            // Lundi de Pâques (Pâques + 1 jour)
            const easterMonday = new Date(easter);
            easterMonday.setDate(easter.getDate() + 1);
            holidays.push(easterMonday.toISOString().split('T')[0]);

            // Ascension (Pâques + 39 jours)
            const ascension = new Date(easter);
            ascension.setDate(easter.getDate() + 39);
            holidays.push(ascension.toISOString().split('T')[0]);

            // Lundi de Pentecôte (Pâques + 50 jours)
            const pentecostMonday = new Date(easter);
            pentecostMonday.setDate(easter.getDate() + 50);
            holidays.push(pentecostMonday.toISOString().split('T')[0]);

            return holidays.sort();
        }

        // Fonction pour calculer les jours OUVRÉS (lun-ven, sans weekends ni fériés) - Pour RTT
        function calculateWorkingDays(startDate, endDate, duration = 'full') {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let workingDays = 0;

            // Récupérer les jours fériés pour les années concernées
            const startYear = start.getFullYear();
            const endYear = end.getFullYear();
            let publicHolidays = [];

            for (let year = startYear; year <= endYear; year++) {
                publicHolidays = publicHolidays.concat(getFrenchPublicHolidays(year));
            }

            // Parcourir chaque jour de la période
            const currentDate = new Date(start);
            // eslint-disable-next-line no-unmodified-loop-condition
            while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay();
                const dateStr = currentDate.toISOString().split('T')[0];

                // Exclure les samedis (6), dimanches (0) et les jours fériés
                if (dayOfWeek !== 0 && dayOfWeek !== 6 && !publicHolidays.includes(dateStr)) {
                    workingDays++;
                }

                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Ajuster selon la durée (demi-journée)
            if (duration === 'morning' || duration === 'afternoon') {
                workingDays = workingDays * 0.5;
            }

            return workingDays;
        }

        // Fonction pour calculer les jours OUVRABLES (lun-sam, sans dimanches ni fériés) - Pour Congés Payés
        function calculateBusinessDays(startDate, endDate, duration = 'full') {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let businessDays = 0;

            // Récupérer les jours fériés pour les années concernées
            const startYear = start.getFullYear();
            const endYear = end.getFullYear();
            let publicHolidays = [];

            for (let year = startYear; year <= endYear; year++) {
                publicHolidays = publicHolidays.concat(getFrenchPublicHolidays(year));
            }

            // Parcourir chaque jour de la période
            const currentDate = new Date(start);
            // eslint-disable-next-line no-unmodified-loop-condition
            while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay();
                const dateStr = currentDate.toISOString().split('T')[0];

                // Exclure seulement les dimanches (0) et les jours fériés (on garde les samedis)
                if (dayOfWeek !== 0 && !publicHolidays.includes(dateStr)) {
                    businessDays++;
                }

                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Ajuster selon la durée (demi-journée)
            if (duration === 'morning' || duration === 'afternoon') {
                businessDays = businessDays * 0.5;
            }

            return businessDays;
        }

        // Fonction pour calculer les congés acquis selon le système N-1 et N
        // Système: 30 jours annuels, avec calcul N-1 (date entrée -> 31/08) et N (01/09 -> 31/08)
        function calculateAcquiredLeave(dateEntree, referencePeriod = 'september-august', acquisitionPerMonth = 2.5) {
            if (!dateEntree) return { acquired: 30, acquiredN1: 0, acquiredN: 30, total: 30, isFirstYear: false };

            const entryDate = new Date(dateEntree);
            const today = new Date();
            const currentYear = today.getFullYear();

            // Déterminer l'année de référence N actuelle (période de septembre à août)
            const refYear = today.getMonth() >= 8 ? currentYear : currentYear - 1;

            // Période N : du 01/09/année N au 31/08/année N+1
            const periodNStart = new Date(refYear, 8, 1);
            const periodNEnd = new Date(refYear + 1, 7, 31);

            // Période N-1 : de la date d'entrée au 31/08 de l'année N
            const periodN1End = new Date(refYear, 7, 31);

            // Calcul N-1 : jours acquis depuis l'entrée jusqu'à la fin période N-1 (31/08)
            let acquiredN1 = 0;
            if (entryDate <= periodN1End) {
                const endDateN1 = today < periodN1End ? today : periodN1End;
                const monthsWorkedN1 = Math.max(0, (endDateN1 - entryDate) / (1000 * 60 * 60 * 24 * 30.44));
                acquiredN1 = Math.min(30, Math.round(monthsWorkedN1 * acquisitionPerMonth * 100) / 100);
            }

            // Calcul N : jours acquis sur période actuelle (01/09 -> 31/08)
            let acquiredN = 0;
            if (today >= periodNStart) {
                const startDate = entryDate > periodNStart ? entryDate : periodNStart;
                const endDate = today < periodNEnd ? today : periodNEnd;
                const monthsWorkedN = Math.max(0, (endDate - startDate) / (1000 * 60 * 60 * 24 * 30.44));
                acquiredN = Math.min(30, Math.round(monthsWorkedN * acquisitionPerMonth * 100) / 100);
            }

            const isFirstYear = entryDate >= periodNStart;

            return {
                acquired: acquiredN1 + acquiredN,
                acquiredN1,
                acquiredN,
                total: 30,
                isFirstYear,
                monthsWorked: Math.floor((today - entryDate) / (1000 * 60 * 60 * 24 * 30.44))
            };
        }

        // Gestion de l'état de l'application
        class AppState {
            constructor() {
                this.currentUser = null;
                this.currentView = 'login';
                this.viewMode = null; // 'admin' ou 'collaborateur' pour les admins qui basculent
                this.init();
            }

            init() {
                // Initialiser les données par défaut si nécessaire
                if (!storage.getItem('users')) {
                    const defaultUsers = [
                        {
                            id: 1,
                            email: 'admin@entreprise.fr',
                            password: 'admin123',
                            nom: 'Administrateur',
                            prenom: 'Système',
                            role: 'admin',
                            roles: ['admin', 'manager', 'collaborateur'], // Admin a tous les rôles
                            managerId: null,
                            contractType: 'permanent_tuc',
                            soldeConges: 25,
                            soldeRTT: 0,
                            hasRTT: false,
                            phone: '',
                            address: '',
                            poste: 'Administrateur Système',
                            documents: [],
                            documentRequests: [],
                            showEmail: true,
                            showPhone: true,
                            teams: []
                        },
                        {
                            id: 2,
                            email: 'jean.dupont@entreprise.fr',
                            password: 'user123',
                            nom: 'Dupont',
                            prenom: 'Jean',
                            role: 'collaborateur',
                            roles: ['collaborateur', 'manager'], // Multi-profils
                            managerId: null,
                            contractType: 'permanent_tuc',
                            dateEntree: '2020-01-15',
                            soldeConges: 25,
                            soldeRTT: 12,
                            hasRTT: true,
                            phone: '06 12 34 56 78',
                            address: '123 Rue de Toulouse, 31000 Toulouse',
                            poste: 'Responsable Développement',
                            documents: [],
                            documentRequests: [],
                            showEmail: true,
                            showPhone: true,
                            teams: ['développement']
                        },
                        {
                            id: 3,
                            email: 'manager@entreprise.fr',
                            password: 'manager123',
                            nom: 'Dubois',
                            prenom: 'Sophie',
                            role: 'manager',
                            roles: ['manager', 'collaborateur'],
                            managerId: null,
                            contractType: 'permanent_tuc',
                            dateEntree: '2019-06-01',
                            soldeConges: 25,
                            soldeRTT: 8,
                            hasRTT: true,
                            phone: '06 45 67 89 01',
                            address: '789 Boulevard TUC, 31200 Toulouse',
                            poste: 'Responsable RH',
                            documents: [],
                            documentRequests: [],
                            showEmail: true,
                            showPhone: false,
                            teams: ['rh', 'management']
                        },
                        {
                            id: 4,
                            email: 'marie.martin@entreprise.fr',
                            password: 'user123',
                            nom: 'Martin',
                            prenom: 'Marie',
                            role: 'collaborateur',
                            roles: ['collaborateur'],
                            managerId: 3, // Géré par Sophie Dubois
                            contractType: 'permanent_tuc_vacances',
                            dateEntree: '2024-03-01',
                            soldeConges: 0,
                            soldeRTT: 0,
                            hasRTT: false,
                            phone: '06 98 76 54 32',
                            address: '456 Avenue du TUC, 31100 Toulouse',
                            poste: 'Animateur Vacances',
                            documents: [],
                            documentRequests: [],
                            recoveryHours: [],
                            showEmail: true,
                            showPhone: true,
                            teams: ['animation']
                        },
                        {
                            id: 5,
                            email: 'pierre.bernard@entreprise.fr',
                            password: 'user123',
                            nom: 'Bernard',
                            prenom: 'Pierre',
                            role: 'collaborateur',
                            roles: ['collaborateur'],
                            managerId: 2, // Géré par Jean Dupont
                            contractType: 'permanent_tuc',
                            dateEntree: '2023-09-01',
                            soldeConges: 25,
                            soldeRTT: 5,
                            hasRTT: true,
                            phone: '06 23 45 67 89',
                            address: '321 Rue du Sport, 31000 Toulouse',
                            poste: 'Développeur Junior',
                            documents: [],
                            documentRequests: [],
                            showEmail: false,
                            showPhone: false,
                            teams: ['développement']
                        }
                    ];
                    storage.setItem('users', JSON.stringify(defaultUsers));
                }

                if (!storage.getItem('leaveRequests')) {
                    storage.setItem('leaveRequests', JSON.stringify([]));
                }

                if (!storage.getItem('settings')) {
                    const defaultSettings = {
                        leaveTypes: [
                            { id: 1, name: 'Congés payés', color: '#5D5CDE', category: 'regular', requiresDocument: false, isConventionCollective: false },
                            { id: 2, name: 'RTT', color: '#10B981', category: 'regular', requiresDocument: false, isConventionCollective: false },
                            { id: 3, name: 'Congé Maladie', color: '#EF4444', category: 'special', requiresDocument: true, isConventionCollective: false },
                            { id: 4, name: 'Congé Sans Solde', color: '#F59E0B', category: 'special', requiresDocument: false, isConventionCollective: false },
                            { id: 5, name: 'Congé Maternité/Paternité', color: '#EC4899', category: 'special', requiresDocument: true, isConventionCollective: false },
                            { id: 6, name: 'Congés pour événement familial', color: '#8B5CF6', category: 'special', requiresDocument: true, isConventionCollective: true }
                        ],
                        eventLeaveConfig: {
                            mariage: { label: 'Mariage', days: 4 },
                            pacs: { label: 'PACS', days: 4 },
                            naissance: { label: 'Naissance/Adoption', days: 3 },
                            deces_enfant: { label: 'Décès d\'un enfant', days: 5 },
                            deces_conjoint: { label: 'Décès du conjoint', days: 3 },
                            deces_parent: { label: 'Décès d\'un parent', days: 3 },
                            deces_frere_soeur: { label: 'Décès d\'un frère/sœur', days: 3 },
                            demenagement: { label: 'Déménagement', days: 1 }
                        },
                        publicHolidays: [
                            '2024-01-01',
                            '2024-05-01',
                            '2024-05-08',
                            '2024-07-14',
                            '2024-08-15',
                            '2024-11-01',
                            '2024-11-11',
                            '2024-12-25'
                        ],
                        annualLeaveDays: 30,
                        referencePeriod: 'september-august', // Année N : du 01/09 au 31/08
                        acquisitionPerMonth: 2.5,
                        extraHolidays: [], // Jours fériés supplémentaires (ex: lundi de Pentecôte)
                        doubleValidation: false, // Validation manager + admin
                        documentTypes: [
                            { id: 1, name: 'Carte d\'identité', validityMonths: 120, required: true },
                            { id: 2, name: 'Carte vitale', validityMonths: 12, required: true },
                            { id: 3, name: 'RIB', validityMonths: null, required: true },
                            { id: 4, name: 'Attestation d\'assurance', validityMonths: 12, required: true },
                            { id: 5, name: 'Justificatif de domicile', validityMonths: 3, required: true },
                            { id: 6, name: 'Diplôme', validityMonths: null, required: true }
                        ],
                        contractConfigs: {
                            permanent_tuc: {
                                label: 'Permanent TUC',
                                hasLeave: true,
                                hasRTT: true,
                                hasRecovery: false,
                                requiredDocuments: [1, 2, 3, 4, 5, 6]
                            },
                            permanent_tuc_vacances: {
                                label: 'Permanent TUC VACANCES',
                                hasLeave: false,
                                hasRTT: false,
                                hasRecovery: true,
                                requiredDocuments: [1, 2, 3, 4, 5, 6]
                            }
                        },
                        reminders: {
                            email: true,
                            app: true
                        },
                        rttReminders: {
                            enabled: true,
                            startMonth: 9, // Septembre
                            endMonth: 12,  // Décembre
                            frequency: 'monthly'
                        }
                    };
                    storage.setItem('settings', JSON.stringify(defaultSettings));
                }

                // Vérifier si un utilisateur est connecté
                const savedUser = storage.getItem('currentUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.viewMode = this.currentUser.role; // Initialiser le mode de vue
                    this.currentView = this.currentUser.role === 'admin' ? 'admin-dashboard' : 'user-dashboard';
                }
            }

            async login(email, password) {
    try {
        const data = await ApiClient.login(email, password);

        // Convertir l'utilisateur backend en format frontend
        this.currentUser = {
            id: data.user.id,
            email: data.user.email,
            nom: data.user.lastName,
            prenom: data.user.firstName,
            role: data.user.roles[0] || 'collaborateur',
            roles: data.user.roles,
            poste: data.user.position || '',
            department: data.user.department || ''
        };

        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
        this.viewMode = this.currentUser.role;
        this.currentView = this.currentUser.role === 'admin' ? 'admin-dashboard' : 'user-dashboard';

        return true;
    } catch (error) {
        console.error('Login error:', error);
        return false;
    }
}


            logout() {
                this.currentUser = null;
                this.viewMode = null;
                storage.removeItem('currentUser');
                this.currentView = 'login';
                this.render();
            }

            switchViewMode(mode) {
                if (this.currentUser && this.currentUser.role === 'admin') {
                    this.viewMode = mode;
                    this.currentView = mode === 'admin' ? 'admin-dashboard' : 'user-dashboard';
                    this.render();
                }
            }

            setView(view) {
                this.currentView = view;
                this.render();
            }

            toggleSidebar() {
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            }

            renderSidebar() {
                if (!this.currentUser) return '';

                const isAdmin = this.currentUser.roles.includes('admin');
                const isManager = this.currentUser.roles.includes('manager');

                const navItems = [
                    {
                        id: 'dashboard',
                        label: 'Tableau de bord',
                        icon: `<svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>`,
                        view: isAdmin ? 'admin-dashboard' : 'user-dashboard',
                        show: true
                    },
                    {
                        id: 'profile',
                        label: 'Mon Profil',
                        icon: `<svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>`,
                        view: 'user-profile',
                        show: true
                    },
                    {
                        id: 'users-management',
                        label: 'Gestion Collaborateurs',
                        icon: `<svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>`,
                        view: 'users-management',
                        show: isAdmin
                    },
                    {
                        id: 'manager-space',
                        label: 'Gestion documentaire',
                        icon: `<svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>`,
                        view: 'manager-space',
                        show: isAdmin || isManager
                    },
                    {
                        id: 'leave-management',
                        label: 'Gestion des congés',
                        icon: `<svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>`,
                        view: 'user-dashboard',
                        show: true
                    },
                    {
                        id: 'directory',
                        label: 'Annuaire',
                        icon: `<svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>`,
                        view: 'directory',
                        show: true
                    },
                    {
                        id: 'settings',
                        label: 'Paramètres',
                        icon: `<svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>`,
                        view: 'admin-settings',
                        show: isAdmin || isManager
                    }
                ];

                return `
                    <!-- Mobile overlay -->
                    <div class="sidebar-overlay" onclick="appState.toggleSidebar()"></div>

                    <!-- Sidebar -->
                    <aside class="sidebar">
                        <div class="flex flex-col h-full">
                            <!-- Logo & Close button -->
                            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <svg class="w-16 h-16" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="50" cy="50" r="45" fill="#5D5CDE"/>
                                            <text x="50" y="60" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="white" text-anchor="middle">TUC</text>
                                        </svg>
                                        <div>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Gestion RH</p>
                                        </div>
                                    </div>
                                    <!-- Mobile close button -->
                                    <button onclick="appState.toggleSidebar()" class="md:hidden text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Navigation -->
                            <nav class="flex-1 overflow-y-auto py-4">
                                ${navItems.filter(item => {
                                    // Vérifier d'abord si l'item est visible par défaut
                                    if (!item.show) return false;

                                    // La Gestion documentaire ne peut jamais être désactivée pour les managers/admins
                                    if (item.id === 'manager-space') return true;

                                    // Vérifier les permissions utilisateur
                                    const userMenuPermissions = this.currentUser.menuPermissions || {};
                                    // Si pas de permission définie, afficher par défaut
                                    if (userMenuPermissions[item.id] === undefined) return true;
                                    // Sinon respecter la permission
                                    return userMenuPermissions[item.id];
                                }).map(item => `
                                    <div class="nav-item ${this.currentView === item.view ? 'active' : ''}"
                                         onclick="appState.setView('${item.view}'); if(window.innerWidth < 768) appState.toggleSidebar();">
                                        ${item.icon}
                                        <span>${item.label}</span>
                                    </div>
                                `).join('')}
                            </nav>

                            <!-- User profile -->
                            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                                <button onclick="appState.setView('user-profile'); if(window.innerWidth < 768) appState.toggleSidebar();"
                                    class="w-full flex items-center space-x-3 mb-3 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                    <div class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                                        ${this.currentUser.prenom[0]}${this.currentUser.nom[0]}
                                    </div>
                                    <div class="flex-1 min-w-0 text-left">
                                        <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                                            ${this.currentUser.prenom} ${this.currentUser.nom}
                                        </p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate">
                                            ${this.currentUser.poste || 'Collaborateur'}
                                        </p>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                                <button onclick="appState.logout()"
                                    class="w-full flex items-center justify-center px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900 dark:hover:bg-opacity-20 rounded-lg transition-all">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Déconnexion
                                </button>
                            </div>
                        </div>
                    </aside>
                `;
            }

            render() {
                const app = document.getElementById('app');

                // Views without sidebar
                const noSidebarViews = ['login', 'register'];

                if (noSidebarViews.includes(this.currentView)) {
                    switch(this.currentView) {
                        case 'login':
                            app.innerHTML = this.renderLogin();
                            break;
                        case 'register':
                            app.innerHTML = this.renderRegister();
                            break;
                    }
                } else {
                    // Views with sidebar - wrap content
                    let content = '';
                    switch(this.currentView) {
                        case 'user-dashboard':
                            content = this.renderUserDashboard();
                            break;
                        case 'user-history':
                            content = this.renderUserHistory();
                            break;
                        case 'user-profile':
                            content = this.renderUserProfile();
                            break;
                        case 'admin-dashboard':
                            content = this.renderAdminDashboard();
                            break;
                        case 'admin-settings':
                            content = this.renderAdminSettings();
                            break;
                        case 'manager-space':
                            content = this.renderManagerSpace();
                            break;
                        case 'directory':
                            content = this.renderDirectory();
                            break;
                        case 'users-management':
                            content = this.renderUsersManagement();
                            break;
                        default:
                            content = this.renderUserDashboard();
                    }

                    // Wrap content with sidebar
                    app.innerHTML = `
                        ${this.renderSidebar()}
                        <div class="main-content min-h-screen">
                            <!-- Mobile hamburger button -->
                            <div class="md:hidden fixed top-4 left-4 z-20">
                                <button onclick="appState.toggleSidebar()"
                                    class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                    </svg>
                                </button>
                            </div>
                            ${content}
                        </div>
                    `;
                }
            }

            renderLogin() {
                return `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
                            <div class="text-center mb-8">
                                <svg class="w-24 h-24 mx-auto mb-4" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="50" cy="50" r="45" fill="#5D5CDE"/>
                                    <text x="50" y="60" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="white" text-anchor="middle">TUC</text>
                                </svg>
                                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">RH TUC</h1>
                                <p class="text-gray-600 dark:text-gray-400 mt-2">Plateforme de Gestion des Ressources Humaines</p>
                            </div>

                            <form id="loginForm" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                                    <input type="email" id="email" required
                                        class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                        placeholder="votre.email@entreprise.fr">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mot de passe</label>
                                    <input type="password" id="password" required
                                        class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                        placeholder="••••••••">
                                </div>

                                <div id="loginError" class="hidden text-red-500 text-sm text-center"></div>

                                <button type="submit"
                                    class="w-full bg-primary hover:bg-opacity-90 text-white font-semibold py-3 px-4 rounded-lg transition-all transform hover:scale-105">
                                    Se connecter
                                </button>
                            </form>

                            <div class="mt-6 text-center">
                                <p class="text-gray-600 dark:text-gray-400">
                                    Pas encore de compte ?
                                    <button onclick="appState.setView('register')" class="text-primary hover:underline font-semibold">
                                        S'inscrire
                                    </button>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderRegister() {
                return `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-2xl fade-in">
                            <div class="text-center mb-8">
                                <svg class="w-24 h-24 mx-auto mb-4" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="50" cy="50" r="45" fill="#5D5CDE"/>
                                    <text x="50" y="60" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="white" text-anchor="middle">TUC</text>
                                </svg>
                                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Créer un compte</h1>
                                <p class="text-gray-600 dark:text-gray-400 mt-2">Rejoignez la plateforme de gestion des congés</p>
                            </div>

                            <form id="registerForm" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prénom *</label>
                                        <input type="text" id="registerFirstName" required
                                            class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                            placeholder="Jean">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom *</label>
                                        <input type="text" id="registerLastName" required
                                            class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                            placeholder="Dupont">
                                    </div>

                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email *</label>
                                        <input type="email" id="registerEmail" required
                                            class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                            placeholder="votre.email@entreprise.fr">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mot de passe *</label>
                                        <input type="password" id="registerPassword" required minlength="6"
                                            class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                            placeholder="Minimum 6 caractères">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confirmer mot de passe *</label>
                                        <input type="password" id="registerPasswordConfirm" required minlength="6"
                                            class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                            placeholder="Confirmer le mot de passe">
                                    </div>
                                </div>

                                <div class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
                                    <div class="flex items-start">
                                        <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                        </svg>
                                        <p class="text-sm text-blue-800 dark:text-blue-200">
                                            Votre type de contrat (congés, RTT) sera configuré par l'administrateur après validation de votre inscription. Vous recevrez un email de confirmation.
                                        </p>
                                    </div>
                                </div>

                                <div id="registerError" class="hidden text-red-500 text-sm text-center"></div>
                                <div id="registerSuccess" class="hidden text-green-500 text-sm text-center"></div>

                                <div class="flex gap-4">
                                    <button type="button" onclick="appState.setView('login')"
                                        class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-semibold py-3 px-4 rounded-lg transition-all">
                                        Annuler
                                    </button>
                                    <button type="submit"
                                        class="flex-1 bg-primary hover:bg-opacity-90 text-white font-semibold py-3 px-4 rounded-lg transition-all transform hover:scale-105">
                                        Créer mon compte
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }

            renderUserDashboard() {
                const settings = JSON.parse(storage.getItem('settings'));
                const leaveRequests = JSON.parse(storage.getItem('leaveRequests'));
                const userRequests = leaveRequests.filter(r => r.userId === this.currentUser.id);
                const pendingRequests = userRequests.filter(r => r.status === 'pending').length;

                // Vérifier si nous sommes en octobre, novembre ou décembre et si l'utilisateur a des RTT
                const currentMonth = new Date().getMonth(); // 0 = Janvier, 9 = Octobre, etc.
                const showRTTReminder = (currentMonth >= 9) && this.currentUser.hasRTT && this.currentUser.soldeRTT > 0;

                return `
                    <div class="max-w-7xl mx-auto p-4 md:p-6 fade-in">
                        ${showRTTReminder ? `
                            <div class="mb-6 bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-xl shadow-lg fade-in">
                                <div class="flex items-start">
                                    <svg class="w-8 h-8 mr-4 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                    </svg>
                                    <div class="flex-1">
                                        <h3 class="text-xl font-bold mb-2">⚠️ Rappel important - RTT restants</h3>
                                        <p class="text-white text-opacity-95 mb-2">
                                            Attention ! Il vous reste <strong class="text-2xl">${this.currentUser.soldeRTT} jour${this.currentUser.soldeRTT > 1 ? 's' : ''} de RTT</strong> à prendre avant la fin de l'année.
                                        </p>
                                        <p class="text-white text-opacity-90 text-sm">
                                            <strong>Important :</strong> Les RTT non pris ne sont pas rémunérés et ne sont pas reportables sur l'année suivante. Pensez à les poser dès que possible.
                                        </p>
                                        ${currentMonth === 11 ? `
                                            <div class="mt-3 p-3 bg-red-600 bg-opacity-50 rounded-lg border border-white border-opacity-30">
                                                <p class="font-bold">🚨 URGENT - Dernière ligne droite !</p>
                                                <p class="text-sm">Nous sommes en décembre. Posez vos RTT rapidement pour ne pas les perdre !</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <button onclick="this.closest('.bg-gradient-to-r').style.display='none'"
                                        class="ml-4 text-white hover:text-gray-200 transition-colors">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        ${(() => {
                            // Vérifier les documents manquants/en attente/refusés
                            const userDocuments = this.currentUser.documents || [];
                            const requiredDocs = settings.documentTypes.filter(dt => {
                                if (dt.requiredForRoles) {
                                    return this.currentUser.roles?.some(role => dt.requiredForRoles.includes(role));
                                }
                                return dt.required === true;
                            });
                            const uploadedDocTypes = userDocuments.map(d => d.type);
                            const missingDocs = requiredDocs.filter(dt => !uploadedDocTypes.includes(dt.name));
                            const pendingOrRejectedDocs = userDocuments.filter(d =>
                                d.validationStatus === 'pending' || d.validationStatus === 'rejected'
                            );

                            // Ajouter les demandes de documents en attente
                            const documentRequests = this.currentUser.documentRequests || [];
                            const pendingRequests = documentRequests.filter(req => req.status === 'pending');

                            const totalIssues = missingDocs.length + pendingOrRejectedDocs.length + pendingRequests.length;

                            if (totalIssues === 0) return '';

                            return `
                                <div class="mb-6 bg-gradient-to-r from-red-500 to-orange-500 text-white p-6 rounded-xl shadow-lg fade-in">
                                    <div class="flex items-start">
                                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0 mr-4 mt-1">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-xl font-bold mb-2">📄 Documents incomplets</h3>
                                            <p class="text-white text-opacity-95 mb-3">
                                                Vous avez <strong class="text-2xl">${totalIssues} document${totalIssues > 1 ? 's' : ''}</strong> qui nécessite${totalIssues > 1 ? 'nt' : ''} votre attention.
                                            </p>

                                            ${missingDocs.length > 0 ? `
                                                <div class="mb-3">
                                                    <p class="text-white text-opacity-90 text-sm font-semibold mb-2">📋 Documents manquants (${missingDocs.length}) :</p>
                                                    <div class="flex flex-wrap gap-2">
                                                        ${missingDocs.map(dt => `
                                                            <span class="inline-flex items-center px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs">
                                                                ${dt.name}
                                                            </span>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}

                                            ${pendingOrRejectedDocs.length > 0 ? `
                                                <div class="mb-3">
                                                    <p class="text-white text-opacity-90 text-sm font-semibold mb-2">⏳ Documents en attente ou refusés (${pendingOrRejectedDocs.length}) :</p>
                                                    <div class="flex flex-wrap gap-2">
                                                        ${pendingOrRejectedDocs.map(doc => `
                                                            <span class="inline-flex items-center px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs">
                                                                ${doc.type} ${doc.validationStatus === 'rejected' ? '✗' : '⏳'}
                                                            </span>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}

                                            ${pendingRequests.length > 0 ? `
                                                <div class="mb-3">
                                                    <p class="text-white text-opacity-90 text-sm font-semibold mb-2">📩 Documents demandés par votre manager (${pendingRequests.length}) :</p>
                                                    <div class="flex flex-wrap gap-2">
                                                        ${pendingRequests.map(req => `
                                                            <button onclick="uploadDocumentForRequest(${req.id})"
                                                                class="inline-flex items-center px-3 py-1 bg-yellow-500 bg-opacity-90 hover:bg-opacity-100 rounded-full text-xs font-semibold transition-colors cursor-pointer">
                                                                ${req.documentType} 📤
                                                            </button>
                                                        `).join('')}
                                                    </div>
                                                    <p class="text-white text-opacity-80 text-xs mt-2 italic">
                                                        💡 Cliquez sur un document pour le déposer
                                                    </p>
                                                </div>
                                            ` : ''}

                                            <button onclick="appState.setView('user-profile'); setTimeout(() => showProfileTab('documents'), 300)"
                                                class="mt-2 px-4 py-2 bg-white text-orange-600 rounded-lg hover:bg-opacity-90 transition-colors font-medium text-sm">
                                                📁 Compléter mes documents
                                            </button>
                                        </div>
                                        <button onclick="this.closest('.bg-gradient-to-r').style.display='none'"
                                            class="ml-4 text-white hover:text-gray-200 transition-colors">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            `;
                        })()}

                        <!-- En-tête avec statistiques -->
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
                                Bonjour, ${this.currentUser.prenom} ${this.currentUser.nom}
                            </h1>
                            <p class="text-gray-600 dark:text-gray-400">Gérez vos demandes de congés</p>
                        </div>

                        <!-- Statistiques -->
                        <div class="grid grid-cols-1 md:grid-cols-${this.currentUser.hasRTT ? '4' : '3'} gap-6 mb-8">
                            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Congés payés</p>
                                        <p class="text-3xl font-bold text-primary mt-1">${this.currentUser.soldeConges} jours</p>
                                    </div>
                                    <div class="w-12 h-12 bg-primary bg-opacity-10 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                ${this.currentUser.dateEntree ? (() => {
                                    const settings = JSON.parse(storage.getItem('settings'));
                                    const leaveInfo = calculateAcquiredLeave(this.currentUser.dateEntree, settings.referencePeriod, settings.acquisitionPerMonth);
                                    return `
                                        <div class="pt-3 border-t border-gray-200 dark:border-gray-700">
                                            <div class="flex justify-between text-xs">
                                                <span class="text-gray-500 dark:text-gray-400">N-1 (acquis):</span>
                                                <span class="font-semibold text-gray-700 dark:text-gray-300">${leaveInfo.acquiredN1.toFixed(2)} j</span>
                                            </div>
                                            <div class="flex justify-between text-xs mt-1">
                                                <span class="text-gray-500 dark:text-gray-400">N (acquis):</span>
                                                <span class="font-semibold text-gray-700 dark:text-gray-300">${leaveInfo.acquiredN.toFixed(2)} j</span>
                                            </div>
                                        </div>
                                    `;
                                })() : ''}
                            </div>

                            ${this.currentUser.hasRTT ? `
                                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">Solde RTT</p>
                                            <p class="text-3xl font-bold text-green-500 mt-1">${this.currentUser.soldeRTT} jours</p>
                                        </div>
                                        <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                            <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Demandes en attente</p>
                                        <p class="text-3xl font-bold text-orange-500 mt-1">${pendingRequests}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Total demandes</p>
                                        <p class="text-3xl font-bold text-green-500 mt-1">${userRequests.length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formulaire de demande -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Nouvelle demande de congé</h2>

                            <form id="leaveRequestForm" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type de congé</label>
                                        <select id="leaveType" required
                                            class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                                            ${settings.leaveTypes.map(type => `
                                                <option value="${type.id}">${type.name}</option>
                                            `).join('')}
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Durée</label>
                                        <select id="duration" required
                                            class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                                            <option value="full">Journée complète</option>
                                            <option value="morning">Matin uniquement</option>
                                            <option value="afternoon">Après-midi uniquement</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date de début</label>
                                        <input type="date" id="startDate" required
                                            class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date de fin</label>
                                        <input type="date" id="endDate" required
                                            class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Commentaire (optionnel)</label>
                                    <textarea id="comment" rows="3"
                                        class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all"
                                        placeholder="Ajoutez un commentaire..."></textarea>
                                </div>

                                <!-- Justificatif (si requis) -->
                                <div id="documentUploadSection" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Justificatif <span class="text-red-500">*</span>
                                    </label>
                                    <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-primary transition-all cursor-pointer" onclick="document.getElementById('documentFile').click()">
                                        <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Cliquez pour sélectionner un fichier</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">PDF, JPG, PNG (max 5MB)</p>
                                        <input type="file" id="documentFile" class="hidden" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentSelect(this)">
                                    </div>
                                    <div id="selectedFileName" class="mt-2 text-sm text-gray-600 dark:text-gray-400"></div>
                                </div>

                                <div id="formError" class="hidden text-red-500 text-sm"></div>
                                <div id="formSuccess" class="hidden text-green-500 text-sm"></div>

                                <button type="submit"
                                    class="w-full md:w-auto bg-primary hover:bg-opacity-90 text-white font-semibold py-3 px-8 rounded-lg transition-all transform hover:scale-105">
                                    Soumettre la demande
                                </button>
                            </form>
                        </div>

                        <!-- Dernières demandes -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Dernières demandes</h2>
                                <button onclick="appState.setView('user-history')"
                                    class="text-primary hover:underline font-medium">
                                    Voir tout l'historique →
                                </button>
                            </div>

                            <div class="space-y-4">
                                ${this.renderRecentRequests(userRequests.slice(-5).reverse())}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderUserHistory() {
                const leaveRequests = JSON.parse(storage.getItem('leaveRequests'));
                const userRequests = leaveRequests.filter(r => r.userId === this.currentUser.id);
                const settings = JSON.parse(storage.getItem('settings'));

                // Filtres
                const statusFilter = {
                    all: userRequests,
                    pending: userRequests.filter(r => r.status === 'pending'),
                    approved: userRequests.filter(r => r.status === 'approved'),
                    rejected: userRequests.filter(r => r.status === 'rejected')
                };

                return `
                    <div class="max-w-7xl mx-auto p-4 md:p-6 fade-in">
                        <div class="mb-8">
                            <button onclick="appState.setView('user-dashboard')"
                                class="text-primary hover:underline mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                                Retour au tableau de bord
                            </button>
                            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Historique des demandes</h1>
                        </div>

                        <!-- Filtres -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
                            <div class="flex flex-wrap gap-3">
                                <button onclick="filterHistory('all')" id="filter-all"
                                    class="filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-primary text-white">
                                    Toutes (${statusFilter.all.length})
                                </button>
                                <button onclick="filterHistory('pending')" id="filter-pending"
                                    class="filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                                    En attente (${statusFilter.pending.length})
                                </button>
                                <button onclick="filterHistory('approved')" id="filter-approved"
                                    class="filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                                    Approuvées (${statusFilter.approved.length})
                                </button>
                                <button onclick="filterHistory('rejected')" id="filter-rejected"
                                    class="filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                                    Refusées (${statusFilter.rejected.length})
                                </button>
                            </div>
                        </div>

                        <!-- Liste des demandes -->
                        <div id="historyList" class="space-y-4">
                            ${this.renderRequestsList(userRequests.reverse(), settings)}
                        </div>
                    </div>
                `;
            }

            renderAdminDashboard() {
                const leaveRequests = JSON.parse(storage.getItem('leaveRequests'));
                const users = JSON.parse(storage.getItem('users'));
                const settings = JSON.parse(storage.getItem('settings'));

                const pendingRequests = leaveRequests.filter(r => r.status === 'pending');
                const totalUsers = users.filter(u => u.role === 'collaborateur').length;

                // Vérifier si nous sommes en octobre, novembre ou décembre
                const currentMonth = new Date().getMonth();
                const usersWithRTT = users.filter(u => u.hasRTT && u.soldeRTT > 0);
                const showRTTAlert = currentMonth >= 9 && usersWithRTT.length > 0;

                return `
                    <div class="max-w-7xl mx-auto p-4 md:p-6 fade-in">
                        ${showRTTAlert ? `
                            <div class="mb-6 bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-xl shadow-lg fade-in">
                                <div class="flex items-start">
                                    <svg class="w-8 h-8 mr-4 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                    </svg>
                                    <div class="flex-1">
                                        <h3 class="text-xl font-bold mb-3">⚠️ Alerte RTT - Fin d'année approche</h3>
                                        <p class="text-white text-opacity-95 mb-3">
                                            <strong>${usersWithRTT.length} collaborateur${usersWithRTT.length > 1 ? 's ont' : ' a'}</strong> encore des RTT à prendre avant la fin de l'année.
                                        </p>
                                        <div class="bg-white bg-opacity-20 rounded-lg p-4 max-h-48 overflow-y-auto">
                                            <table class="w-full text-sm">
                                                <thead>
                                                    <tr class="border-b border-white border-opacity-30">
                                                        <th class="text-left py-2 text-white font-semibold">Collaborateur</th>
                                                        <th class="text-right py-2 text-white font-semibold">RTT restants</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${usersWithRTT.map(u => `
                                                        <tr class="border-b border-white border-opacity-10">
                                                            <td class="py-2">${u.prenom} ${u.nom}</td>
                                                            <td class="text-right font-bold">${u.soldeRTT} jour${u.soldeRTT > 1 ? 's' : ''}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                        <p class="text-white text-opacity-90 text-sm mt-3">
                                            <strong>Rappel :</strong> Les RTT non pris ne sont pas rémunérés. Pensez à rappeler aux collaborateurs de poser leurs jours restants.
                                        </p>
                                    </div>
                                    <button onclick="this.closest('.bg-gradient-to-r').style.display='none'"
                                        class="ml-4 text-white hover:text-gray-200 transition-colors">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                        <!-- En-tête -->
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
                                Tableau de bord Administrateur
                            </h1>
                            <p class="text-gray-600 dark:text-gray-400">Gérez les demandes de congés de vos collaborateurs</p>
                        </div>

                        <!-- Statistiques -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Demandes en attente</p>
                                        <p class="text-3xl font-bold text-orange-500 mt-1">${pendingRequests.length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Total demandes</p>
                                        <p class="text-3xl font-bold text-primary mt-1">${leaveRequests.length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-primary bg-opacity-10 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Collaborateurs</p>
                                        <p class="text-3xl font-bold text-green-500 mt-1">${totalUsers}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Demandes à valider -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Demandes à valider</h2>

                            ${pendingRequests.length === 0 ? `
                                <div class="text-center py-12">
                                    <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <p class="text-gray-500 dark:text-gray-400 text-lg">Aucune demande en attente</p>
                                </div>
                            ` : `
                                <div class="space-y-4">
                                    ${this.renderAdminRequestsList(pendingRequests, users, settings)}
                                </div>
                            `}
                        </div>

                        <!-- Toutes les demandes -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mt-8">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Toutes les demandes</h2>
                            <div class="space-y-4">
                                ${this.renderAdminRequestsList(leaveRequests.reverse(), users, settings)}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderAdminSettings() {
                const settings = JSON.parse(storage.getItem('settings'));
                const users = JSON.parse(storage.getItem('users')).filter(u => u.role === 'collaborateur');

                return `
                    <div class="max-w-7xl mx-auto p-4 md:p-6 fade-in">
                        <div class="mb-8">
                            <button onclick="appState.setView('admin-dashboard')"
                                class="text-primary hover:underline mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                                Retour au tableau de bord
                            </button>
                            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Paramètres</h1>
                        </div>

                        <!-- Types de congés -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-6">
                            <button onclick="toggleSettingsSection('leaveTypes')" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 flex items-center justify-between hover:from-purple-600 hover:to-purple-700 transition-all">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="font-bold text-xl">Types de congés</span>
                                </div>
                                <svg id="leaveTypesChevron" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>

                            <div id="leaveTypesContent" class="p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- CONGÉS HABITUELS -->
                                <div class="border-2 border-gray-200 dark:border-gray-600 rounded-xl overflow-hidden">
                                    <button onclick="toggleLeaveCategory('regular')" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 flex items-center justify-between hover:from-blue-600 hover:to-blue-700 transition-all">
                                        <div class="flex items-center space-x-3">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                            <span class="font-bold text-lg">CONGÉS HABITUELS</span>
                                        </div>
                                        <svg id="regularChevron" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="regularLeaves" class="p-4 space-y-2">
                                        ${settings.leaveTypes.filter(type => ['Congés payés', 'RTT'].includes(type.name)).map(type => `
                                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="w-4 h-4 rounded-full" style="background-color: ${type.color}"></div>
                                                    <span class="text-gray-900 dark:text-white font-medium">${type.name}</span>
                                                </div>
                                                <span class="text-xs text-gray-500 dark:text-gray-400">Type standard</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- CONGÉS SPÉCIAUX -->
                                <div class="border-2 border-gray-200 dark:border-gray-600 rounded-xl overflow-hidden">
                                    <button onclick="toggleLeaveCategory('special')" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 flex items-center justify-between hover:from-purple-600 hover:to-purple-700 transition-all">
                                        <div class="flex items-center space-x-3">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            <span class="font-bold text-lg">CONGÉS SPÉCIAUX</span>
                                        </div>
                                        <svg id="specialChevron" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="specialLeaves" class="p-4 space-y-2">
                                        ${settings.leaveTypes.filter(type => !['Congés payés', 'RTT'].includes(type.name)).map(type => `
                                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                                <div class="flex items-center space-x-2 flex-1">
                                                    <div class="w-4 h-4 rounded-full" style="background-color: ${type.color}"></div>
                                                    <span class="text-gray-900 dark:text-white font-medium">${type.name}</span>
                                                    ${type.requiresDocument ? `
                                                        <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Justificatif requis">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                        </svg>
                                                    ` : ''}
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    ${type.name === 'Congés pour événement familial' ? `
                                                        <button onclick="configureEventLeave()" class="text-blue-500 hover:text-blue-700" title="Configurer">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                            </svg>
                                                        </button>
                                                    ` : ''}
                                                    <button onclick="deleteLeaveType(${type.id})" class="text-red-500 hover:text-red-700">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                        ${settings.leaveTypes.filter(type => !['Congés payés', 'RTT'].includes(type.name)).length === 0 ? `
                                            <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Aucun congé spécial configuré</p>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>

                            <!-- Formulaire d'ajout -->
                            <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-xl">
                                <h3 class="font-semibold text-gray-900 dark:text-white mb-4">Ajouter un nouveau type de congé</h3>
                                <form id="addLeaveTypeForm" class="space-y-3">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <input type="text" id="newLeaveTypeName" required
                                            class="px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all"
                                            placeholder="Nom du type de congé">
                                        <div class="flex gap-3">
                                            <input type="color" id="newLeaveTypeColor" value="#5D5CDE"
                                                class="w-20 h-12 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer">
                                            <select id="newLeaveTypeCategory"
                                                class="flex-1 px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                                <option value="regular">Congé habituel</option>
                                                <option value="special">Congé spécial</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" id="requiresDocument"
                                                class="w-5 h-5 text-primary rounded focus:ring-primary">
                                            <span class="text-sm text-gray-700 dark:text-gray-300">Justificatif obligatoire</span>
                                        </label>
                                    </div>
                                    <button type="submit"
                                        class="w-full bg-primary hover:bg-opacity-90 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                        Ajouter le type de congé
                                    </button>
                                </form>
                            </div>
                            </div>
                        </div>

                        <!-- Jours fériés -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-6">
                            <button onclick="toggleHolidaysSection()" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-6 flex items-center justify-between hover:from-green-600 hover:to-green-700 transition-all">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="font-bold text-xl">Jours fériés</span>
                                </div>
                                <svg id="holidaysChevron" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>

                            <div id="holidaysContent" class="p-6">
                                <div class="flex items-center justify-end space-x-3 mb-6">
                                    <label class="text-sm text-gray-700 dark:text-gray-300 font-medium">Année :</label>
                                    <select id="yearSelector" onchange="updatePublicHolidaysYear(this.value)"
                                        class="px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                        ${(() => {
                                            const currentYear = new Date().getFullYear();
                                            const selectedYear = settings.selectedHolidayYear || currentYear;
                                            let options = '';
                                            for (let year = currentYear - 1; year <= currentYear + 3; year++) {
                                                options += `<option value="${year}" ${year == selectedYear ? 'selected' : ''}>${year}</option>`;
                                            }
                                            return options;
                                        })()}
                                    </select>
                                    <button onclick="loadDefaultHolidays()"
                                        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded-lg transition-all flex items-center space-x-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        <span>Charger les jours fériés</span>
                                    </button>
                                </div>

                                <div id="holidaysList" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                                    ${(() => {
                                        const selectedYear = settings.selectedHolidayYear || new Date().getFullYear();
                                        const yearHolidays = settings.publicHolidays.filter(date => date.startsWith(String(selectedYear)));
                                        return yearHolidays.map(date => `
                                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                                <span class="text-gray-900 dark:text-white text-sm">${new Date(date).toLocaleDateString('fr-FR')}</span>
                                                <button onclick="deletePublicHoliday('${date}')"
                                                    class="text-red-500 hover:text-red-700">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        `).join('');
                                    })()}
                                </div>

                                <form id="addPublicHolidayForm" class="flex gap-3">
                                    <input type="date" id="newPublicHoliday" required
                                        class="flex-1 px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                                    <button type="submit"
                                        class="bg-primary hover:bg-opacity-90 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                        Ajouter
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Période de référence -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-6">
                            <button onclick="toggleSettingsSection('referencePeriod')" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 flex items-center justify-between hover:from-blue-600 hover:to-blue-700 transition-all">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="font-bold text-xl">Période de référence des congés</span>
                                </div>
                                <svg id="referencePeriodChevron" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>

                            <div id="referencePeriodContent" class="p-6">
                            <div class="space-y-4">
                                <label class="flex items-center p-4 border-2 ${settings.referencePeriod === 'january-december' ? 'border-primary bg-primary bg-opacity-5' : 'border-gray-200 dark:border-gray-600'} rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                                    <input type="radio" name="referencePeriod" value="january-december" ${settings.referencePeriod === 'january-december' ? 'checked' : ''}
                                        onchange="updateReferencePeriod(this.value)"
                                        class="w-5 h-5 text-primary focus:ring-2 focus:ring-primary">
                                    <div class="ml-4">
                                        <p class="font-semibold text-gray-900 dark:text-white">Année civile (Janvier - Décembre)</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Période du 1er janvier au 31 décembre</p>
                                    </div>
                                </label>

                                <label class="flex items-center p-4 border-2 ${settings.referencePeriod === 'may-may' ? 'border-primary bg-primary bg-opacity-5' : 'border-gray-200 dark:border-gray-600'} rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                                    <input type="radio" name="referencePeriod" value="may-may" ${settings.referencePeriod === 'may-may' ? 'checked' : ''}
                                        onchange="updateReferencePeriod(this.value)"
                                        class="w-5 h-5 text-primary focus:ring-2 focus:ring-primary">
                                    <div class="ml-4">
                                        <p class="font-semibold text-gray-900 dark:text-white">Mai à Mai</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Période du 1er mai au 30 avril</p>
                                    </div>
                                </label>

                                <label class="flex items-center p-4 border-2 ${settings.referencePeriod === 'september-september' ? 'border-primary bg-primary bg-opacity-5' : 'border-gray-200 dark:border-gray-600'} rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                                    <input type="radio" name="referencePeriod" value="september-september" ${settings.referencePeriod === 'september-september' ? 'checked' : ''}
                                        onchange="updateReferencePeriod(this.value)"
                                        class="w-5 h-5 text-primary focus:ring-2 focus:ring-primary">
                                    <div class="ml-4">
                                        <p class="font-semibold text-gray-900 dark:text-white">Septembre à Septembre</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Période du 1er septembre au 31 août</p>
                                    </div>
                                </label>
                            </div>

                            <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                    <p class="text-sm text-blue-800 dark:text-blue-200">
                                        Les collaborateurs acquièrent <strong>${settings.acquisitionPerMonth} jours ouvrables</strong> par mois travaillé. La première année est calculée au prorata de leur date d'entrée.
                                    </p>
                                </div>
                            </div>
                            </div>
                        </div>

                        <!-- Configuration des rappels -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-6">
                            <button onclick="toggleSettingsSection('reminders')" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 flex items-center justify-between hover:from-orange-600 hover:to-orange-700 transition-all">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                                    </svg>
                                    <span class="font-bold text-xl">Configuration des rappels</span>
                                </div>
                                <svg id="remindersChevron" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>

                            <div id="remindersContent" class="p-6">
                                <div class="space-y-6">
                                    <!-- Types de rappels -->
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Types de rappels</h3>
                                        <div class="space-y-3">
                                            <label class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                                    </svg>
                                                    <span class="text-gray-900 dark:text-white font-medium">Rappels par email</span>
                                                </div>
                                                <input type="checkbox" id="enableEmailReminders" ${settings.reminders?.email ? 'checked' : ''}
                                                    onchange="updateReminderSetting('email', this.checked)"
                                                    class="w-5 h-5 text-primary focus:ring-2 focus:ring-primary rounded">
                                            </label>
                                            <label class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                                                    </svg>
                                                    <span class="text-gray-900 dark:text-white font-medium">Notifications à l'ouverture de l'app</span>
                                                </div>
                                                <input type="checkbox" id="enableAppReminders" ${settings.reminders?.app ? 'checked' : ''}
                                                    onchange="updateReminderSetting('app', this.checked)"
                                                    class="w-5 h-5 text-primary focus:ring-2 focus:ring-primary rounded">
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Rappels RTT programmés -->
                                    <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                                        <div class="flex items-center justify-between mb-4">
                                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Rappels RTT automatiques</h3>
                                            <button onclick="showRTTRemindersModal()"
                                                class="px-4 py-2 bg-primary hover:bg-opacity-90 text-white text-sm font-semibold rounded-lg transition-all">
                                                Configurer
                                            </button>
                                        </div>
                                        <div class="p-4 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg">
                                            <div class="flex items-start">
                                                <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                                </svg>
                                                <p class="text-sm text-blue-800 dark:text-blue-200">
                                                    Rappel automatique des jours de RTT restants programmé de septembre au 31 décembre de chaque année.
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Rappels personnalisés -->
                                    <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                                        <div class="flex items-center justify-between mb-4">
                                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Rappels personnalisés</h3>
                                            <button onclick="showAddReminderModal()"
                                                class="px-4 py-2 bg-primary hover:bg-opacity-90 text-white text-sm font-semibold rounded-lg transition-all flex items-center space-x-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                </svg>
                                                <span>Ajouter</span>
                                            </button>
                                        </div>
                                        <div class="space-y-3">
                                            ${(settings.customReminders || []).length === 0 ? `
                                                <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Aucun rappel personnalisé configuré</p>
                                            ` : settings.customReminders.map(reminder => `
                                                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                                    <div class="flex-1">
                                                        <h4 class="font-medium text-gray-900 dark:text-white">${reminder.title}</h4>
                                                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${reminder.message}</p>
                                                        <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500 dark:text-gray-400">
                                                            <span>📅 ${reminder.frequency === 'daily' ? 'Quotidien' : reminder.frequency === 'weekly' ? 'Hebdomadaire' : 'Mensuel'}</span>
                                                            ${reminder.targetRoles.length > 0 ? `<span>👥 ${reminder.targetRoles.join(', ')}</span>` : ''}
                                                        </div>
                                                    </div>
                                                    <button onclick="deleteReminder(${reminder.id})" class="ml-4 text-red-500 hover:text-red-700">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gestion des documents obligatoires -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-6">
                            <button onclick="toggleSettingsSection('documents')" class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white p-6 flex items-center justify-between hover:from-red-600 hover:to-red-700 transition-all">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span class="font-bold text-xl">Gestion des documents obligatoires</span>
                                </div>
                                <svg id="documentsChevron" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>

                            <div id="documentsContent" class="p-6">
                                <div class="space-y-6">
                                    <!-- Documents par type de responsabilité -->
                                    <div>
                                        <div class="flex items-center justify-between mb-4">
                                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Documents requis par niveau de responsabilité</h3>
                                            <button onclick="showAddDocumentModal()"
                                                class="px-4 py-2 bg-primary hover:bg-opacity-90 text-white text-sm font-semibold rounded-lg transition-all flex items-center space-x-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                </svg>
                                                <span>Ajouter un document</span>
                                            </button>
                                        </div>
                                        <div class="space-y-4">
                                            ${settings.documentTypes.map(doc => `
                                                <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-5 hover:border-primary dark:hover:border-primary transition-all">
                                                    <div class="flex items-start justify-between mb-4">
                                                        <div class="flex items-center space-x-3">
                                                            <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center flex-shrink-0">
                                                                <svg class="w-5 h-5 text-blue-600 dark:text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                                </svg>
                                                            </div>
                                                            <div>
                                                                <h4 class="font-semibold text-lg text-gray-900 dark:text-white">${doc.name}</h4>
                                                                ${doc.templateFile ? `
                                                                    <div class="flex items-center space-x-1 mt-1">
                                                                        <svg class="w-3.5 h-3.5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                                        </svg>
                                                                        <span class="text-xs text-blue-600 dark:text-blue-400">Template disponible</span>
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                        <div class="flex space-x-2">
                                                            <button onclick="editDocumentType(${doc.id})"
                                                                class="p-2 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900 rounded-lg transition-all"
                                                                title="Modifier">
                                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                </svg>
                                                            </button>
                                                            <button onclick="deleteDocumentType(${doc.id})"
                                                                class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900 rounded-lg transition-all"
                                                                title="Supprimer">
                                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div class="flex items-start space-x-3">
                                                            <div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                                                                <svg class="w-4 h-4 text-green-600 dark:text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                            </div>
                                                            <div class="flex-1">
                                                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Validité</p>
                                                                <p class="text-sm font-medium text-gray-900 dark:text-white">
                                                                    ${doc.validityMonths ? doc.validityMonths + ' mois' : 'Illimitée'}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-start space-x-3">
                                                            <div class="w-8 h-8 bg-red-100 dark:bg-red-900 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                                                                <svg class="w-4 h-4 text-red-600 dark:text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                </svg>
                                                            </div>
                                                            <div class="flex-1">
                                                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Destruction auto</p>
                                                                <p class="text-sm font-medium text-gray-900 dark:text-white">
                                                                    ${doc.autoDeleteMonths ? doc.autoDeleteMonths + ' mois après expiration' : 'Manuelle'}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-start space-x-3">
                                                            <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                                                                <svg class="w-4 h-4 text-purple-600 dark:text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                            </div>
                                                            <div class="flex-1">
                                                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Validation</p>
                                                                ${doc.validationRequired !== false ? `
                                                                    <p class="text-sm font-medium text-gray-900 dark:text-white">
                                                                        ${doc.validationLevel === 'manager' ? '👔 Manager' : '👑 Admin'}
                                                                    </p>
                                                                ` : `
                                                                    <p class="text-sm font-medium text-green-600 dark:text-green-400">
                                                                        ✓ Auto-validé
                                                                    </p>
                                                                `}
                                                            </div>
                                                        </div>
                                                        <div class="flex items-start space-x-3">
                                                            <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                                                                <svg class="w-4 h-4 text-purple-600 dark:text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                                                </svg>
                                                            </div>
                                                            <div class="flex-1">
                                                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">À qui demander</p>
                                                                <div class="flex flex-wrap gap-1.5 mt-1">
                                                                    ${(doc.requiredForRoles || ['collaborateur', 'manager', 'admin']).map(role => {
                                                                        const roleConfig = {
                                                                            admin: { bg: 'bg-red-100 dark:bg-red-900', text: 'text-red-800 dark:text-red-200', label: 'Admin' },
                                                                            manager: { bg: 'bg-blue-100 dark:bg-blue-900', text: 'text-blue-800 dark:text-blue-200', label: 'Manager' },
                                                                            collaborateur: { bg: 'bg-green-100 dark:bg-green-900', text: 'text-green-800 dark:text-green-200', label: 'Collaborateur' }
                                                                        };
                                                                        const config = roleConfig[role];
                                                                        return `<span class="px-2 py-1 text-xs font-medium rounded-full ${config.bg} ${config.text}">${config.label}</span>`;
                                                                    }).join('')}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-start space-x-3">
                                                            <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                                                                <svg class="w-4 h-4 text-yellow-600 dark:text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                                </svg>
                                                            </div>
                                                            <div class="flex-1">
                                                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-2 font-medium">Permissions par rôle :</p>
                                                                ${(() => {
                                                                    const perms = doc.permissions || {
                                                                        admin: { canView: true, canDownload: true, canSeeDepositDate: false },
                                                                        manager: { canView: false, canDownload: false, canSeeDepositDate: true },
                                                                        collaborateur: { canView: true, canDownload: true, canSeeDepositDate: false }
                                                                    };

                                                                    const roleConfigs = [
                                                                        { role: 'admin', label: '👑 Admin', data: perms.admin, color: 'red' },
                                                                        { role: 'manager', label: '👔 Manager', data: perms.manager, color: 'blue' },
                                                                        { role: 'collaborateur', label: '👤 Collab', data: perms.collaborateur, color: 'green' }
                                                                    ];

                                                                    return roleConfigs.map(({ role, label, data, color }) => {
                                                                        const permissions = [];
                                                                        if (data?.canView) permissions.push('👁️');
                                                                        if (data?.canDownload) permissions.push('📥');
                                                                        if (data?.canSeeDepositDate) permissions.push('📅');

                                                                        if (permissions.length === 0) {
                                                                            return `<div class="flex items-center space-x-2 mb-1">
                                                                                <span class="text-xs text-gray-400 dark:text-gray-500">${label}</span>
                                                                                <span class="text-xs text-gray-400 italic">Aucun accès</span>
                                                                            </div>`;
                                                                        }

                                                                        return `<div class="flex items-center space-x-2 mb-1">
                                                                            <span class="text-xs font-medium text-gray-700 dark:text-gray-300">${label}</span>
                                                                            <span class="text-xs">${permissions.join(' ')}</span>
                                                                        </div>`;
                                                                    }).join('');
                                                                })()}
                                                                <p class="text-xs text-gray-400 dark:text-gray-500 mt-2 italic">
                                                                    👁️ = Consultation • 📥 = Téléchargement • 📅 = Date dépôt uniquement
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderManagerSpace() {
                const isAdmin = this.currentUser.roles && this.currentUser.roles.includes('admin');
                const isManager = this.currentUser.roles && this.currentUser.roles.includes('manager');

                if (!isAdmin && !isManager) {
                    return '<div class="p-8 text-center"><p class="text-red-500">Accès refusé</p></div>';
                }

                const users = JSON.parse(storage.getItem('users')) || [];
                const settings = JSON.parse(storage.getItem('settings'));

                // Récupérer les collaborateurs sous responsabilité
                let managedUsers = [];
                if (isAdmin) {
                    managedUsers = users.filter(u => u.id !== this.currentUser.id);
                } else if (isManager) {
                    managedUsers = users.filter(u => u.managerId === this.currentUser.id);
                }

                // OPTIMISATION: Créer un Map pour les types de documents pour un accès O(1)
                const documentTypesMap = new Map(settings.documentTypes.map(dt => [dt.name, dt]));

                // OPTIMISATION: Calculer toutes les statistiques en un seul passage
                const stats = {
                    pending: 0,
                    validated: 0,
                    rejected: 0,
                    pendingDocuments: [],
                    userStats: new Map()
                };

                managedUsers.forEach(user => {
                    const userDocs = user.documents || [];
                    let userPending = 0, userValidated = 0, userRejected = 0;

                    userDocs.forEach(doc => {
                        const status = doc.validationStatus;

                        // Comptabiliser par statut
                        if (status === 'validated') {
                            stats.validated++;
                            userValidated++;
                        } else if (status === 'rejected') {
                            stats.rejected++;
                            userRejected++;
                        } else if (status === 'pending') {
                            const documentType = documentTypesMap.get(doc.type);
                            const canValidate = (isAdmin && documentType?.validationLevel === 'admin') || (isManager && documentType?.validationLevel === 'manager');

                            if (canValidate && documentType) {
                                stats.pending++;
                                userPending++;
                                stats.pendingDocuments.push({
                                    ...doc,
                                    userName: `${user.prenom} ${user.nom}`,
                                    userEmail: user.email,
                                    userId: user.id,
                                    userPhoto: user.photo,
                                    documentType: documentType
                                });
                            }
                        }
                    });

                    // Stocker les stats par utilisateur
                    stats.userStats.set(user.id, {
                        user,
                        pending: userPending,
                        validated: userValidated,
                        rejected: userRejected,
                        total: userDocs.length
                    });
                });

                return `
                    <div class="max-w-7xl mx-auto p-4 md:p-6 fade-in">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Gestion documentaire</h1>
                            <p class="text-gray-600 dark:text-gray-400">Validez les documents de vos collaborateurs et gérez leur dossier</p>
                        </div>

                        <!-- Statistiques optimisées -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white shadow-lg cursor-pointer hover:shadow-xl transition-shadow" onclick="filterDocumentsByStatus('pending')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-orange-100 text-sm font-medium">En attente</p>
                                        <p class="text-3xl font-bold mt-1">${stats.pending}</p>
                                        <p class="text-orange-100 text-xs mt-2">Cliquez pour filtrer</p>
                                    </div>
                                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white shadow-lg cursor-pointer hover:shadow-xl transition-shadow" onclick="filterDocumentsByStatus('validated')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-green-100 text-sm font-medium">Validés</p>
                                        <p class="text-3xl font-bold mt-1">${stats.validated}</p>
                                        <p class="text-green-100 text-xs mt-2">Cliquez pour filtrer</p>
                                    </div>
                                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-6 text-white shadow-lg cursor-pointer hover:shadow-xl transition-shadow" onclick="filterDocumentsByStatus('rejected')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-red-100 text-sm font-medium">Refusés</p>
                                        <p class="text-3xl font-bold mt-1">${stats.rejected}</p>
                                        <p class="text-red-100 text-xs mt-2">Cliquez pour filtrer</p>
                                    </div>
                                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section Documents à valider avec filtres et recherche -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-8">
                            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Documents à valider (${stats.pending})</h2>

                                    <!-- Barre de recherche et filtres -->
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <input type="text" id="searchDocuments" placeholder="Rechercher..."
                                            class="px-4 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                                            onkeyup="filterDocuments()">
                                        <select id="filterDocType" onchange="filterDocuments()"
                                            class="px-4 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                            <option value="">Tous les types</option>
                                            ${settings.documentTypes.map(dt => `<option value="${dt.name}">${dt.name}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6">
                                ${stats.pending === 0 ? `
                                    <div class="text-center py-12">
                                        <svg class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <p class="text-gray-500 dark:text-gray-400 text-lg">Aucun document en attente de validation</p>
                                    </div>
                                ` : `
                                    <div id="documentsList" class="space-y-4">
                                        ${stats.pendingDocuments.map(doc => `
                                            <div class="document-item border border-gray-200 dark:border-gray-600 rounded-lg p-5 hover:border-primary transition-colors"
                                                 data-user-name="${doc.userName.toLowerCase()}"
                                                 data-doc-type="${doc.type.toLowerCase()}"
                                                 data-status="pending">
                                                <div class="flex items-start justify-between">
                                                    <div class="flex items-start space-x-4 flex-1">
                                                        ${doc.userPhoto ? `
                                                            <img src="${doc.userPhoto}" class="w-12 h-12 rounded-full object-cover">
                                                        ` : `
                                                            <div class="w-12 h-12 bg-gradient-to-br from-primary to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                                                ${doc.userName.split(' ').map(n => n[0]).join('')}
                                                            </div>
                                                        `}
                                                        <div class="flex-1">
                                                            <div class="flex items-center gap-2">
                                                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${doc.type}</h3>
                                                                ${doc.documentType.validationLevel === 'admin' ? `
                                                                    <span class="px-2 py-0.5 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs rounded-full">Admin requis</span>
                                                                ` : ''}
                                                            </div>
                                                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                                                👤 ${doc.userName} • 📅 ${new Date(doc.uploadDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}
                                                            </p>
                                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">📧 ${doc.userEmail}</p>
                                                        </div>
                                                    </div>
                                                    <div class="flex space-x-2">
                                                        <button onclick="viewDocument(${doc.userId}, ${doc.id})"
                                                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                            </svg>
                                                            Voir
                                                        </button>
                                                        <button onclick="validateDocument(${doc.userId}, ${doc.id}, 'validated')"
                                                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                            </svg>
                                                            Valider
                                                        </button>
                                                        <button onclick="validateDocument(${doc.userId}, ${doc.id}, 'rejected')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                            </svg>
                                                            Refuser
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                <h2 class="text-xl font-bold text-gray-900 dark:text-white">Mes Collaborateurs (${managedUsers.length})</h2>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Collaborateur</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Manager</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Documents</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Statut</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                        ${managedUsers.map(user => {
                                            const userDocs = user.documents || [];
                                            // Calculer le nombre de documents requis pour cet utilisateur
                                            // Si requiredForRoles existe, l'utiliser, sinon utiliser required ou les documents du contrat
                                            const totalDocs = settings.documentTypes.filter(dt => {
                                                if (dt.requiredForRoles) {
                                                    return user.roles?.some(role => dt.requiredForRoles.includes(role));
                                                }
                                                // Sinon, utiliser la propriété required (compatibilité avec l'ancien système)
                                                return dt.required === true;
                                            }).length;
                                            const uploadedDocs = userDocs.length;
                                            const pendingDocs = userDocs.filter(d => d.validationStatus === 'pending').length;
                                            const validatedDocs = userDocs.filter(d => d.validationStatus === 'validated').length;
                                            const manager = user.managerId ? users.find(u => u.id === user.managerId) : null;
                                            return `
                                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                    <td class="px-6 py-4">
                                                        <div class="flex items-center">
                                                            <div class="h-10 w-10 bg-primary rounded-full flex items-center justify-center text-white font-bold">
                                                                ${user.prenom[0]}${user.nom[0]}
                                                            </div>
                                                            <div class="ml-4">
                                                                <div class="text-sm font-medium text-gray-900 dark:text-white">${user.prenom} ${user.nom}</div>
                                                                <div class="text-sm text-gray-500">${user.email}</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        ${manager ? `
                                                            <div class="flex items-center">
                                                                <div class="h-8 w-8 bg-gradient-to-br from-purple-500 to-primary rounded-full flex items-center justify-center text-white font-bold text-xs mr-2">
                                                                    ${manager.prenom[0]}${manager.nom[0]}
                                                                </div>
                                                                <div>
                                                                    <div class="text-sm font-medium text-gray-900 dark:text-white">${manager.prenom} ${manager.nom}</div>
                                                                    <div class="text-xs text-gray-500">${manager.roles.includes('admin') ? 'Admin' : 'Manager'}</div>
                                                                </div>
                                                            </div>
                                                        ` : `
                                                            <span class="text-sm text-gray-400 dark:text-gray-500 italic">Aucun manager</span>
                                                        `}
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="text-sm text-gray-900 dark:text-white">${uploadedDocs}/${totalDocs} déposés</div>
                                                        <div class="text-xs text-gray-500">${validatedDocs} validés</div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        ${pendingDocs > 0 ? `<span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200">${pendingDocs} en attente</span>` : `<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">✓ OK</span>`}
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <button onclick="manageUserDocuments(${user.id})"
                                                            class="inline-flex items-center px-3 py-2 text-sm font-medium text-purple-600 dark:text-purple-400 hover:text-purple-900 dark:hover:text-purple-300 hover:bg-purple-50 dark:hover:bg-purple-900 dark:hover:bg-opacity-20 rounded-lg transition-colors">
                                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                            </svg>
                                                            Gérer
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderUserProfile() {
                const contractTypeLabels = {
                    'permanent_tuc': 'Permanent TUC',
                    'permanent_tuc_vacances': 'Permanent TUC VACANCES'
                };

                const pendingDocRequests = (this.currentUser.documentRequests || []).filter(r => r.status === 'pending').length;

                return `
                    <div class="max-w-7xl mx-auto p-4 md:p-6 fade-in">
                        <div class="mb-8">
                            <button onclick="appState.setView('user-dashboard')"
                                class="text-primary hover:underline mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                                Retour au tableau de bord
                            </button>
                        </div>

                        <!-- En-tête profil -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 mb-6">
                            <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                                <div class="relative">
                                    ${this.currentUser.photo ? `
                                        <img src="${this.currentUser.photo}" alt="Photo de profil" class="w-32 h-32 rounded-full object-cover">
                                    ` : `
                                        <div class="w-32 h-32 bg-gradient-to-br from-primary to-purple-600 rounded-full flex items-center justify-center text-white text-4xl font-bold">
                                            ${this.currentUser.prenom[0]}${this.currentUser.nom[0]}
                                        </div>
                                    `}
                                    <button onclick="updateProfilePhoto()" class="absolute bottom-0 right-0 w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center hover:bg-opacity-90 transition-all shadow-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="flex-1 text-center md:text-left">
                                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
                                        ${this.currentUser.prenom} ${this.currentUser.nom}
                                    </h1>
                                    <p class="text-xl text-gray-600 dark:text-gray-400 mb-3">${this.currentUser.poste || 'Collaborateur'}</p>
                                    <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                                        <span class="px-3 py-1 bg-primary bg-opacity-10 text-primary rounded-full text-sm font-medium">
                                            ${contractTypeLabels[this.currentUser.contractType] || 'Non défini'}
                                        </span>
                                        ${this.currentUser.hasRTT ? `
                                            <span class="px-3 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-full text-sm font-medium">
                                                ✓ RTT
                                            </span>
                                        ` : ''}
                                        ${pendingDocRequests > 0 ? `
                                            <span class="px-3 py-1 bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 rounded-full text-sm font-medium">
                                                ${pendingDocRequests} document${pendingDocRequests > 1 ? 's' : ''} demandé${pendingDocRequests > 1 ? 's' : ''}
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Onglets -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg mb-6">
                            <div class="border-b border-gray-200 dark:border-gray-700">
                                <div class="flex overflow-x-auto">
                                    <button onclick="showProfileTab('overview')" id="tab-overview"
                                        class="profile-tab px-6 py-4 text-sm font-medium border-b-2 border-primary text-primary">
                                        Aperçu
                                    </button>
                                    <button onclick="showProfileTab('personal')" id="tab-personal"
                                        class="profile-tab px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-primary">
                                        Données Personnelles
                                    </button>
                                    <button onclick="showProfileTab('documents')" id="tab-documents"
                                        class="profile-tab px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-primary relative">
                                        Documents
                                        ${pendingDocRequests > 0 ? `
                                            <span class="absolute top-2 right-2 w-5 h-5 bg-orange-500 text-white text-xs rounded-full flex items-center justify-center">
                                                ${pendingDocRequests}
                                            </span>
                                        ` : ''}
                                    </button>
                                    ${this.currentUser.contractType === 'permanent_tuc_vacances' ? `
                                        <button onclick="showProfileTab('recovery')" id="tab-recovery"
                                            class="profile-tab px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-primary">
                                            Récupérations
                                        </button>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Contenu de l'onglet Aperçu -->
                            <div id="tab-content-overview" class="tab-content p-6">
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Informations générales</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Email</p>
                                        <p class="text-gray-900 dark:text-white font-medium">${this.currentUser.email}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Téléphone</p>
                                        <p class="text-gray-900 dark:text-white font-medium">${this.currentUser.phone || 'Non renseigné'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Structure de rattachement</p>
                                        <p class="text-gray-900 dark:text-white font-medium">${this.currentUser.structure || 'Non renseignée'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Type de contrat</p>
                                        <p class="text-gray-900 dark:text-white font-medium">${this.currentUser.typeContrat || 'Non défini'}</p>
                                    </div>
                                    <div class="md:col-span-2">
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Adresse complète</p>
                                        <p class="text-gray-900 dark:text-white font-medium">
                                            ${this.currentUser.address ? this.currentUser.address : ''}
                                            ${this.currentUser.postalCode || this.currentUser.city ? `<br>${this.currentUser.postalCode || ''} ${this.currentUser.city || ''}` : ''}
                                            ${!this.currentUser.address && !this.currentUser.postalCode && !this.currentUser.city ? 'Non renseignée' : ''}
                                        </p>
                                    </div>
                                    ${this.currentUser.dateEntree ? `
                                        <div>
                                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Date d'entrée</p>
                                            <p class="text-gray-900 dark:text-white font-medium">${new Date(this.currentUser.dateEntree).toLocaleDateString('fr-FR')}</p>
                                        </div>
                                    ` : ''}
                                    <div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Statut du contrat</p>
                                        <p class="text-gray-900 dark:text-white font-medium">${contractTypeLabels[this.currentUser.contractType] || 'Non défini'}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Contenu de l'onglet Données Personnelles -->
                            <div id="tab-content-personal" class="tab-content p-6 hidden">
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Modifier mes informations</h3>
                                <form id="updateProfileForm" class="space-y-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prénom</label>
                                            <input type="text" id="updatePrenom" value="${this.currentUser.prenom}" required
                                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom</label>
                                            <input type="text" id="updateNom" value="${this.currentUser.nom}" required
                                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Téléphone</label>
                                            <input type="tel" id="updatePhone" value="${this.currentUser.phone || ''}"
                                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Poste
                                                <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">(Modifiable uniquement par l'administrateur)</span>
                                            </label>
                                            <input type="text" id="updatePoste" value="${this.currentUser.poste || ''}" readonly
                                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 cursor-not-allowed">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Structure de rattachement
                                                <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">(Modifiable uniquement par l'administrateur)</span>
                                            </label>
                                            <input type="text" value="${this.currentUser.structure || 'Non définie'}" readonly
                                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 cursor-not-allowed">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Type de contrat
                                                <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">(Modifiable uniquement par l'administrateur)</span>
                                            </label>
                                            <input type="text" value="${this.currentUser.typeContrat || 'Non défini'}" readonly
                                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 cursor-not-allowed">
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Adresse</label>
                                            <input type="text" id="updateAddress" value="${this.currentUser.address || ''}" placeholder="Numéro et nom de rue"
                                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Code postal</label>
                                            <input type="text" id="updatePostalCode" value="${this.currentUser.postalCode || ''}" pattern="[0-9]{5}" placeholder="31000"
                                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ville</label>
                                            <input type="text" id="updateCity" value="${this.currentUser.city || ''}" placeholder="Toulouse"
                                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                        </div>
                                    </div>
                                    <button type="submit"
                                        class="bg-primary hover:bg-opacity-90 text-white font-semibold py-3 px-8 rounded-lg transition-all">
                                        Enregistrer les modifications
                                    </button>
                                </form>
                            </div>

                            <!-- Contenu de l'onglet Documents -->
                            <div id="tab-content-documents" class="tab-content p-6 hidden">
                                ${this.renderDocumentsTab()}
                            </div>

                            ${this.currentUser.contractType === 'permanent_tuc_vacances' ? `
                                <!-- Contenu de l'onglet Récupérations -->
                                <div id="tab-content-recovery" class="tab-content p-6 hidden">
                                    ${this.renderRecoveryTab()}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            renderDocumentsTab() {
                const documents = this.currentUser.documents || [];
                const documentRequests = this.currentUser.documentRequests || [];
                const pendingRequests = documentRequests.filter(r => r.status === 'pending');

                return `
                    <div class="space-y-6">
                        ${pendingRequests.length > 0 ? `
                            <div class="bg-orange-50 dark:bg-orange-900 border border-orange-200 dark:border-orange-700 rounded-lg p-4">
                                <h4 class="font-bold text-orange-800 dark:text-orange-200 mb-3">📋 Documents demandés (${pendingRequests.length})</h4>
                                <div class="space-y-3">
                                    ${pendingRequests.map(req => `
                                        <div class="bg-white dark:bg-orange-800 p-4 rounded-lg">
                                            <div class="flex justify-between items-start mb-2">
                                                <div>
                                                    <p class="font-semibold text-gray-900 dark:text-white">${req.documentType}</p>
                                                    <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">${req.description || 'Aucune description'}</p>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Demandé le ${new Date(req.requestDate).toLocaleDateString('fr-FR')}</p>
                                                </div>
                                                <button onclick="uploadDocumentForRequest(${req.id})"
                                                    class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                                    Déposer
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-gray-900 dark:text-white">📁 Mes documents</h4>
                                <button onclick="uploadNewDocument()"
                                    class="bg-primary hover:bg-opacity-90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Ajouter un document
                                </button>
                            </div>

                            ${documents.length === 0 ? `
                                <div class="text-center py-12 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <p class="text-gray-500 dark:text-gray-400">Aucun document déposé</p>
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${documents.map(doc => `
                                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-all">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <p class="font-semibold text-gray-900 dark:text-white">${doc.name}</p>
                                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${doc.type}</p>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                        Ajouté le ${new Date(doc.uploadDate).toLocaleDateString('fr-FR')}
                                                    </p>
                                                    ${doc.status === 'validated' ? `
                                                        <span class="inline-block mt-2 px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded text-xs">
                                                            ✓ Validé
                                                        </span>
                                                    ` : doc.status === 'pending' ? `
                                                        <span class="inline-block mt-2 px-2 py-1 bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 rounded text-xs">
                                                            En attente de validation
                                                        </span>
                                                    ` : ''}
                                                </div>
                                                <button onclick="deleteDocument(${doc.id})"
                                                    class="text-red-500 hover:text-red-700 transition-all">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            renderRecoveryTab() {
                const recoveryHours = this.currentUser.recoveryHours || [];
                const settings = JSON.parse(storage.getItem('settings'));
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                return `
                    <div class="space-y-6">
                        <div class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
                            <h4 class="font-bold text-blue-800 dark:text-blue-200 mb-2">ℹ️ Information</h4>
                            <p class="text-sm text-blue-700 dark:text-blue-300">
                                En tant que Permanent TUC VACANCES, vous devez saisir vos heures de récupération chaque mois.
                                Indiquez le delta horaire dépassé (heures supplémentaires effectuées).
                            </p>
                        </div>

                        <div>
                            <h4 class="font-bold text-gray-900 dark:text-white mb-4">Saisir les heures du mois en cours</h4>
                            <form id="addRecoveryForm" class="flex gap-3">
                                <input type="number" id="recoveryHours" step="0.5" min="0" required
                                    class="flex-1 px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                                    placeholder="Nombre d'heures (ex: 3.5)">
                                <button type="submit"
                                    class="bg-primary hover:bg-opacity-90 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                    Enregistrer
                                </button>
                            </form>
                        </div>

                        <div>
                            <h4 class="font-bold text-gray-900 dark:text-white mb-4">Historique des récupérations</h4>
                            ${recoveryHours.length === 0 ? `
                                <div class="text-center py-8 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <p class="text-gray-500 dark:text-gray-400">Aucune récupération enregistrée</p>
                                </div>
                            ` : `
                                <div class="space-y-2">
                                    ${recoveryHours.sort((a, b) => new Date(b.month) - new Date(a.month)).map(rec => `
                                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex justify-between items-center">
                                            <div>
                                                <p class="font-semibold text-gray-900 dark:text-white">
                                                    ${new Date(rec.month).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}
                                                </p>
                                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                                    Saisi le ${new Date(rec.recordDate).toLocaleDateString('fr-FR')}
                                                </p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-2xl font-bold text-primary">${rec.hours}h</p>
                                                ${rec.validated ? `
                                                    <span class="text-xs text-green-600 dark:text-green-400">✓ Validé</span>
                                                ` : `
                                                    <span class="text-xs text-orange-600 dark:text-orange-400">En attente</span>
                                                `}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            renderDirectory() {
                const users = JSON.parse(storage.getItem('users')) || [];
                const settings = JSON.parse(storage.getItem('settings')) || { showEmail: true, showPhone: true };
                const isAdmin = this.currentUser.roles.includes('admin');

                // Filter out system admin for directory view
                const collaborators = users.filter(u => u.id !== 1);

                return `
                    <div class="p-4 md:p-6 fade-in">
                        <div class="max-w-7xl mx-auto pt-16 md:pt-6">
                            <div class="mb-8">
                                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Annuaire des collaborateurs</h1>
                                <p class="text-gray-600 dark:text-gray-400">Liste complète de l'équipe TUC</p>
                            </div>

                            ${isAdmin ? `
                                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl shadow-lg p-6 mb-6">
                                    <div class="flex items-center space-x-3">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div>
                                            <h3 class="font-bold text-lg">Contrôle de visibilité</h3>
                                            <p class="text-sm text-blue-100">Cliquez sur les icônes 👁️ pour afficher/masquer les coordonnées de chaque collaborateur individuellement</p>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Directory Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${collaborators.map(user => {
                                    const manager = user.managerId ? users.find(u => u.id === user.managerId) : null;
                                    const contractType = user.contractType === 'permanent_tuc' ? 'Permanent TUC' :
                                                       user.contractType === 'permanent_tuc_vacances' ? 'Permanent TUC VACANCES' : 'Non défini';

                                    return `
                                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                                            <div class="flex flex-col items-center text-center">
                                                <div class="w-20 h-20 bg-gradient-to-br from-primary to-purple-600 rounded-full flex items-center justify-center text-white text-2xl font-bold mb-4">
                                                    ${user.prenom[0]}${user.nom[0]}
                                                </div>
                                                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-1">
                                                    ${user.prenom} ${user.nom}
                                                </h3>
                                                <p class="text-gray-600 dark:text-gray-400 mb-3">${user.poste || 'Collaborateur'}</p>

                                                <div class="w-full space-y-2 mb-4">
                                                    <div class="flex items-center justify-center space-x-2 text-sm">
                                                        <span class="px-3 py-1 bg-primary bg-opacity-10 text-primary rounded-full text-xs font-medium">
                                                            ${contractType}
                                                        </span>
                                                    </div>
                                                    ${manager ? `
                                                        <p class="text-sm text-gray-500 dark:text-gray-400">
                                                            Manager: ${manager.prenom} ${manager.nom}
                                                        </p>
                                                    ` : ''}
                                                </div>

                                                <div class="w-full border-t border-gray-200 dark:border-gray-700 pt-4 space-y-2">
                                                    ${(isAdmin || user.showEmail !== false) ? `
                                                        <div class="flex items-center justify-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                                            </svg>
                                                            <span class="truncate">${user.email}</span>
                                                            ${isAdmin ? `
                                                                <button onclick="toggleUserVisibility(${user.id}, 'email')" class="ml-2">
                                                                    <svg class="w-4 h-4 ${user.showEmail !== false ? 'text-green-500' : 'text-red-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${user.showEmail !== false ? 'M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' : 'M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21'}"></path>
                                                                    </svg>
                                                                </button>
                                                            ` : ''}
                                                        </div>
                                                    ` : ''}
                                                    ${(isAdmin || user.showPhone !== false) && user.phone ? `
                                                        <div class="flex items-center justify-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                                            </svg>
                                                            <span>${user.phone}</span>
                                                            ${isAdmin ? `
                                                                <button onclick="toggleUserVisibility(${user.id}, 'phone')" class="ml-2">
                                                                    <svg class="w-4 h-4 ${user.showPhone !== false ? 'text-green-500' : 'text-red-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${user.showPhone !== false ? 'M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' : 'M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21'}"></path>
                                                                    </svg>
                                                                </button>
                                                            ` : ''}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            calculateLeaveBreakdown(user) {
                // Calculer la répartition des congés entre N-1 et N
                const settings = JSON.parse(storage.getItem('settings'));
                const leaveRequests = JSON.parse(storage.getItem('leaveRequests')) || [];

                // Calculer les congés acquis N-1 et N
                const leaveInfo = calculateAcquiredLeave(user.dateEntree, settings.referencePeriod, settings.acquisitionPerMonth);

                // Calculer les jours consommés par les demandes validées
                const validatedRequests = leaveRequests.filter(r =>
                    r.userId === user.id &&
                    r.status === 'validé' &&
                    r.type === 'conges'
                );

                const totalUsed = validatedRequests.reduce((sum, req) => sum + (req.days || 0), 0);

                // Calculer le solde restant pour N-1 et N
                // On consomme d'abord les congés N-1 (ancienneté)
                let remainingN1 = leaveInfo.acquiredN1;
                let remainingN = leaveInfo.acquiredN;
                let usedDays = totalUsed;

                if (usedDays > 0) {
                    // Consommer d'abord N-1
                    if (remainingN1 >= usedDays) {
                        remainingN1 -= usedDays;
                        usedDays = 0;
                    } else {
                        usedDays -= remainingN1;
                        remainingN1 = 0;
                        // Consommer ensuite N
                        remainingN = Math.max(0, remainingN - usedDays);
                    }
                }

                return {
                    nMinus1: Math.round(remainingN1 * 100) / 100,
                    n: Math.round(remainingN * 100) / 100,
                    total: Math.round((remainingN1 + remainingN) * 100) / 100
                };
            }

            renderUsersManagement() {
                const users = JSON.parse(storage.getItem('users')) || [];
                const settings = JSON.parse(storage.getItem('settings'));

                // Exclure l'admin système de la liste
                const managedUsers = users.filter(u => u.id !== 1);

                return `
                    <div class="p-4 md:p-6 fade-in">
                        <div class="max-w-7xl mx-auto pt-16 md:pt-6">
                            <div class="mb-8 flex items-center justify-between">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Gestion des Collaborateurs</h1>
                                    <p class="text-gray-600 dark:text-gray-400">Ajoutez et gérez les utilisateurs du système</p>
                                </div>
                                <button onclick="showAddUserModal()"
                                    class="px-6 py-3 bg-primary hover:bg-opacity-90 text-white font-semibold rounded-lg transition-all flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    <span>Ajouter un utilisateur</span>
                                </button>
                            </div>

                            <!-- Statistiques -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-blue-100 text-sm font-medium">Total Utilisateurs</p>
                                            <p class="text-3xl font-bold mt-1">${managedUsers.length}</p>
                                        </div>
                                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white shadow-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-green-100 text-sm font-medium">Managers</p>
                                            <p class="text-3xl font-bold mt-1">${managedUsers.filter(u => u.roles.includes('manager')).length}</p>
                                        </div>
                                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-purple-100 text-sm font-medium">Collaborateurs</p>
                                            <p class="text-3xl font-bold mt-1">${managedUsers.filter(u => u.roles.includes('collaborateur')).length}</p>
                                        </div>
                                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white shadow-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-orange-100 text-sm font-medium">Contrat TUC</p>
                                            <p class="text-3xl font-bold mt-1">${managedUsers.filter(u => u.contractType === 'permanent_tuc').length}</p>
                                        </div>
                                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-xl p-6 text-white shadow-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-cyan-100 text-sm font-medium">Total RTT</p>
                                            <p class="text-3xl font-bold mt-1">${managedUsers.filter(u => u.hasRTT).reduce((sum, u) => sum + (u.soldeRTT || 0), 0)}</p>
                                        </div>
                                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Liste des utilisateurs -->
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Liste des utilisateurs</h2>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Utilisateur</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Rôles</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Contrat</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Documents</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Congés N-1</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Congés N</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">RTT</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Équipes</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            ${managedUsers.map(user => {
                                                // Calculer les congés N-1 et N
                                                const leaveBreakdown = this.calculateLeaveBreakdown(user);

                                                return `
                                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                                                ${user.prenom[0]}${user.nom[0]}
                                                            </div>
                                                            <div>
                                                                <div class="text-sm font-medium text-gray-900 dark:text-white">${user.prenom} ${user.nom}</div>
                                                                <div class="text-sm text-gray-500 dark:text-gray-400">${user.poste || 'Non défini'}</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="text-sm text-gray-900 dark:text-white">${user.email}</div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex flex-wrap gap-1">
                                                            ${user.roles.map(role => {
                                                                const roleColors = {
                                                                    admin: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                                                                    manager: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                                                                    collaborateur: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
                                                                };
                                                                return `<span class="px-2 py-1 text-xs font-semibold rounded-full ${roleColors[role] || 'bg-gray-100 text-gray-800'}">${role}</span>`;
                                                            }).join('')}
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-900 dark:text-white">
                                                            ${user.contractType === 'permanent_tuc' ? 'Permanent TUC' : 'TUC Vacances'}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        ${(() => {
                                                            // Calculer le nombre de documents déposés et requis
                                                            const uploadedDocs = (user.documents || []).length;

                                                            // Calculer le nombre total de documents requis pour ce rôle
                                                            const requiredDocs = settings.documentTypes.filter(dt => {
                                                                // Vérifier si le document est requis pour les rôles de l'utilisateur
                                                                return dt.requiredForRoles && user.roles.some(role => dt.requiredForRoles.includes(role));
                                                            }).length;

                                                            // Déterminer la couleur selon le statut
                                                            const percentage = requiredDocs > 0 ? (uploadedDocs / requiredDocs) * 100 : 100;
                                                            const color = percentage === 100 ? 'text-green-600 dark:text-green-400' :
                                                                         percentage >= 50 ? 'text-orange-600 dark:text-orange-400' :
                                                                         'text-red-600 dark:text-red-400';

                                                            return `
                                                                <div class="flex items-center space-x-2">
                                                                    <svg class="w-4 h-4 ${color}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                                    </svg>
                                                                    <span class="text-sm font-semibold ${color}">
                                                                        ${uploadedDocs}/${requiredDocs}
                                                                    </span>
                                                                </div>
                                                            `;
                                                        })()}
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <span class="text-sm font-semibold ${leaveBreakdown.nMinus1 > 0 ? 'text-orange-600 dark:text-orange-400' : 'text-gray-500 dark:text-gray-400'}">
                                                                ${leaveBreakdown.nMinus1} jours
                                                            </span>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <span class="text-sm font-semibold ${leaveBreakdown.n > 0 ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-400'}">
                                                                ${leaveBreakdown.n} jours
                                                            </span>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center space-x-2">
                                                            ${user.hasRTT ? `
                                                                <span class="text-sm font-semibold ${user.soldeRTT > 0 ? 'text-cyan-600 dark:text-cyan-400' : 'text-gray-500 dark:text-gray-400'}">
                                                                    ${user.soldeRTT || 0} jours
                                                                </span>
                                                            ` : `
                                                                <span class="text-xs text-gray-400 dark:text-gray-500">Non autorisé</span>
                                                            `}
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="flex flex-wrap gap-1">
                                                            ${(user.teams || []).map(team =>
                                                                `<span class="px-2 py-1 text-xs bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 rounded-full">${team}</span>`
                                                            ).join('')}
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                        <div class="flex space-x-2">
                                                            <button onclick="manageUserDocuments(${user.id})"
                                                                class="text-purple-600 hover:text-purple-900 dark:text-purple-400 dark:hover:text-purple-300"
                                                                title="Gérer les documents">
                                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                                </svg>
                                                            </button>
                                                            <button onclick="editUser(${user.id})"
                                                                class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300"
                                                                title="Modifier">
                                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                </svg>
                                                            </button>
                                                            <button onclick="deleteUser(${user.id})"
                                                                class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300"
                                                                title="Supprimer">
                                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `}).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderHeader() {
                return `
                    <header class="bg-white dark:bg-gray-800 shadow-sm">
                        <div class="max-w-7xl mx-auto px-4 md:px-6 py-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">Gestion des Congés</h1>
                                </div>

                                <div class="flex items-center space-x-4">
                                    ${this.viewMode === 'admin' ? `
                                        <button onclick="appState.setView('admin-dashboard')"
                                            class="hidden md:block text-gray-600 dark:text-gray-400 hover:text-primary transition-all">
                                            Tableau de bord
                                        </button>
                                        <button onclick="appState.setView('admin-settings')"
                                            class="hidden md:block text-gray-600 dark:text-gray-400 hover:text-primary transition-all">
                                            Paramètres
                                        </button>
                                    ` : `
                                        <button onclick="appState.setView('user-dashboard')"
                                            class="hidden md:block text-gray-600 dark:text-gray-400 hover:text-primary transition-all">
                                            Accueil
                                        </button>
                                        <button onclick="appState.setView('user-history')"
                                            class="hidden md:block text-gray-600 dark:text-gray-400 hover:text-primary transition-all">
                                            Historique
                                        </button>
                                        <button onclick="appState.setView('user-profile')"
                                            class="hidden md:block text-gray-600 dark:text-gray-400 hover:text-primary transition-all">
                                            Profil
                                        </button>
                                    `}

                                    <div class="flex items-center space-x-3">
                                        ${this.currentUser.role === 'admin' ? `
                                            <!-- Version desktop -->
                                            <div class="hidden md:block">
                                                <button onclick="appState.switchViewMode('${this.viewMode === 'admin' ? 'collaborateur' : 'admin'}')"
                                                    class="flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-primary text-white rounded-lg hover:opacity-90 transition-all shadow-md">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                                    </svg>
                                                    <span class="text-sm font-medium">Mode ${this.viewMode === 'admin' ? 'Collaborateur' : 'Admin'}</span>
                                                </button>
                                            </div>
                                            <!-- Version mobile -->
                                            <button onclick="appState.switchViewMode('${this.viewMode === 'admin' ? 'collaborateur' : 'admin'}')"
                                                class="md:hidden p-2 bg-gradient-to-r from-purple-500 to-primary text-white rounded-lg hover:opacity-90 transition-all">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                                </svg>
                                            </button>
                                        ` : ''}
                                        <div class="hidden md:block text-right">
                                            <p class="text-sm font-medium text-gray-900 dark:text-white">${this.currentUser.prenom} ${this.currentUser.nom}</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                                ${this.currentUser.role === 'admin'
                                                    ? `Administrateur <span class="text-primary">(Vue: ${this.viewMode === 'admin' ? 'Admin' : 'Collaborateur'})</span>`
                                                    : 'Collaborateur'}
                                            </p>
                                        </div>
                                        <button onclick="appState.logout()"
                                            class="p-2 text-gray-600 dark:text-gray-400 hover:text-red-500 transition-all">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>
                `;
            }

            renderRecentRequests(requests) {
                if (requests.length === 0) {
                    return `
                        <div class="text-center py-8">
                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                            </svg>
                            <p class="text-gray-500 dark:text-gray-400">Aucune demande pour le moment</p>
                        </div>
                    `;
                }

                const settings = JSON.parse(storage.getItem('settings'));

                return requests.map(request => {
                    const leaveType = settings.leaveTypes.find(t => t.id === request.leaveTypeId);
                    const statusConfig = {
                        pending: { color: 'orange', text: 'En attente', icon: 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
                        approved: { color: 'green', text: 'Approuvée', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' },
                        rejected: { color: 'red', text: 'Refusée', icon: 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z' }
                    };
                    const status = statusConfig[request.status];

                    return `
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:shadow-md transition-all">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <div class="w-3 h-3 rounded-full" style="background-color: ${leaveType.color}"></div>
                                        <h3 class="font-semibold text-gray-900 dark:text-white">${leaveType.name}</h3>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        Du ${new Date(request.startDate).toLocaleDateString('fr-FR')} au ${new Date(request.endDate).toLocaleDateString('fr-FR')}
                                        ${request.duration !== 'full' ? ` (${request.duration === 'morning' ? 'Matin' : 'Après-midi'})` : ''}
                                    </p>
                                    ${request.comment ? `<p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${request.comment}</p>` : ''}
                                </div>
                                <div class="mt-3 md:mt-0">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-${status.color}-100 dark:bg-${status.color}-900 text-${status.color}-800 dark:text-${status.color}-200">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${status.icon}"></path>
                                        </svg>
                                        ${status.text}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderRequestsList(requests, settings) {
                if (requests.length === 0) {
                    return `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                            </svg>
                            <p class="text-gray-500 dark:text-gray-400 text-lg">Aucune demande trouvée</p>
                        </div>
                    `;
                }

                return `<div class="space-y-4" id="requestsContainer">${requests.map(request => {
                    const leaveType = settings.leaveTypes.find(t => t.id === request.leaveTypeId);
                    const statusConfig = {
                        pending: { color: 'orange', text: 'En attente' },
                        approved: { color: 'green', text: 'Approuvée' },
                        rejected: { color: 'red', text: 'Refusée' }
                    };
                    const status = statusConfig[request.status];

                    return `
                        <div class="request-item bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg" data-status="${request.status}">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-3">
                                        <div class="w-4 h-4 rounded-full" style="background-color: ${leaveType.color}"></div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${leaveType.name}</h3>
                                        <span class="px-3 py-1 rounded-full text-sm font-medium bg-${status.color}-100 dark:bg-${status.color}-900 text-${status.color}-800 dark:text-${status.color}-200">
                                            ${status.text}
                                        </span>
                                    </div>
                                    <div class="space-y-2 text-sm">
                                        <p class="text-gray-600 dark:text-gray-400">
                                            <strong>Période :</strong> Du ${new Date(request.startDate).toLocaleDateString('fr-FR')} au ${new Date(request.endDate).toLocaleDateString('fr-FR')}
                                        </p>
                                        <p class="text-gray-600 dark:text-gray-400">
                                            <strong>Durée :</strong> ${request.duration === 'full' ? 'Journée complète' : request.duration === 'morning' ? 'Matin uniquement' : 'Après-midi uniquement'}
                                        </p>
                                        ${request.comment ? `<p class="text-gray-600 dark:text-gray-400"><strong>Commentaire :</strong> ${request.comment}</p>` : ''}
                                        <p class="text-gray-500 dark:text-gray-500 text-xs">
                                            Demandé le ${new Date(request.createdAt).toLocaleDateString('fr-FR')} à ${new Date(request.createdAt).toLocaleTimeString('fr-FR')}
                                        </p>
                                        ${request.adminComment ? `
                                            <div class="mt-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                                <p class="text-gray-700 dark:text-gray-300 text-sm"><strong>Commentaire administrateur :</strong> ${request.adminComment}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}</div>`;
            }

            renderAdminRequestsList(requests, users, settings) {
                if (requests.length === 0) {
                    return `
                        <div class="text-center py-8">
                            <p class="text-gray-500 dark:text-gray-400">Aucune demande</p>
                        </div>
                    `;
                }

                return requests.map(request => {
                    const user = users.find(u => u.id === request.userId);
                    const leaveType = settings.leaveTypes.find(t => t.id === request.leaveTypeId);
                    const statusConfig = {
                        pending: { color: 'orange', text: 'En attente' },
                        approved: { color: 'green', text: 'Approuvée' },
                        rejected: { color: 'red', text: 'Refusée' }
                    };
                    const status = statusConfig[request.status];

                    return `
                        <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-3">
                                        <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-semibold">
                                            ${user.prenom[0]}${user.nom[0]}
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-gray-900 dark:text-white">${user.prenom} ${user.nom}</h3>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">${user.email}</p>
                                        </div>
                                    </div>

                                    <div class="ml-13 space-y-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-3 h-3 rounded-full" style="background-color: ${leaveType.color}"></div>
                                            <span class="font-medium text-gray-900 dark:text-white">${leaveType.name}</span>
                                        </div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">
                                            Du ${new Date(request.startDate).toLocaleDateString('fr-FR')} au ${new Date(request.endDate).toLocaleDateString('fr-FR')}
                                            ${request.duration !== 'full' ? ` (${request.duration === 'morning' ? 'Matin' : 'Après-midi'})` : ''}
                                        </p>
                                        ${request.comment ? `<p class="text-sm text-gray-600 dark:text-gray-400"><em>"${request.comment}"</em></p>` : ''}
                                        <p class="text-xs text-gray-500 dark:text-gray-500">
                                            Demandé le ${new Date(request.createdAt).toLocaleDateString('fr-FR')}
                                        </p>
                                        ${request.adminComment ? `
                                            <div class="mt-2 p-3 bg-white dark:bg-gray-800 rounded-lg">
                                                <p class="text-sm text-gray-700 dark:text-gray-300"><strong>Votre commentaire :</strong> ${request.adminComment}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>

                                <div class="flex flex-col items-end space-y-3">
                                    <span class="px-3 py-1 rounded-full text-sm font-medium bg-${status.color}-100 dark:bg-${status.color}-900 text-${status.color}-800 dark:text-${status.color}-200">
                                        ${status.text}
                                    </span>

                                    ${request.status === 'pending' ? `
                                        <div class="flex space-x-2">
                                            <button onclick="approveRequest(${request.id})"
                                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                                Approuver
                                            </button>
                                            <button onclick="rejectRequest(${request.id})"
                                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                                Refuser
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Instance globale de l'application
        const appState = new AppState();

        // Gestion du formulaire de connexion
        document.addEventListener('submit', async (e) => {
    if (e.target.id === 'loginForm') {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');

        const success = await appState.login(email, password);
        if (success) {
                    appState.render();

                    // Afficher la notification de documents en attente pour manager/admin
                    setTimeout(() => {
                        checkPendingDocumentsNotification();
                    }, 500);

                    // Afficher la notification de documents manquants pour collaborateurs
                    setTimeout(() => {
                        checkMissingDocumentsNotification();
                    }, 500);
                } else {
                    errorDiv.textContent = 'Email ou mot de passe incorrect';
                    errorDiv.classList.remove('hidden');
                }
            }

            // Formulaire d'inscription
            if (e.target.id === 'registerForm') {
                e.preventDefault();
                const prenom = document.getElementById('registerFirstName').value;
                const nom = document.getElementById('registerLastName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

                const errorDiv = document.getElementById('registerError');
                const successDiv = document.getElementById('registerSuccess');

                // Validation
                if (password !== passwordConfirm) {
                    errorDiv.textContent = 'Les mots de passe ne correspondent pas';
                    errorDiv.classList.remove('hidden');
                    successDiv.classList.add('hidden');
                    return;
                }

                // Vérifier si l'email existe déjà
                const users = JSON.parse(storage.getItem('users'));
                if (users.find(u => u.email === email)) {
                    errorDiv.textContent = 'Un compte existe déjà avec cet email';
                    errorDiv.classList.remove('hidden');
                    successDiv.classList.add('hidden');
                    return;
                }

                // Créer le nouveau compte
                const newUser = {
                    id: Date.now(),
                    email,
                    password,
                    nom,
                    prenom,
                    role: 'collaborateur',
                    soldeConges: 25,
                    soldeRTT: 0,
                    hasRTT: false
                };

                users.push(newUser);
                storage.setItem('users', JSON.stringify(users));

                // Simuler l'envoi d'email de confirmation
                showEmailConfirmation(email, prenom, nom);

                // Réinitialiser le formulaire
                e.target.reset();
                errorDiv.classList.add('hidden');
            }

            // Formulaire de demande de congé
            if (e.target.id === 'leaveRequestForm') {
                e.preventDefault();
                const leaveTypeId = parseInt(document.getElementById('leaveType').value);
                const duration = document.getElementById('duration').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const comment = document.getElementById('comment').value;

                const errorDiv = document.getElementById('formError');
                const successDiv = document.getElementById('formSuccess');

                // Validation
                if (new Date(startDate) > new Date(endDate)) {
                    errorDiv.textContent = 'La date de fin doit être après la date de début';
                    errorDiv.classList.remove('hidden');
                    successDiv.classList.add('hidden');
                    return;
                }

                // Déterminer le type de congé pour utiliser le bon calcul
                const settings = JSON.parse(storage.getItem('settings'));
                const leaveType = settings.leaveTypes.find(t => t.id === leaveTypeId);

                // Vérifier si un justificatif est requis
                if (leaveType && leaveType.requiresDocument) {
                    const fileInput = document.getElementById('documentFile');
                    if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                        errorDiv.textContent = 'Un justificatif est requis pour ce type de congé';
                        errorDiv.classList.remove('hidden');
                        successDiv.classList.add('hidden');
                        return;
                    }
                }

                let daysCount = 0;
                if (leaveType && leaveType.name === 'RTT') {
                    // RTT = jours OUVRÉS (lun-ven)
                    daysCount = calculateWorkingDays(startDate, endDate, duration);
                } else {
                    // Congés Payés = jours OUVRABLES (lun-sam)
                    daysCount = calculateBusinessDays(startDate, endDate, duration);
                }

                // Créer la demande
                const leaveRequests = JSON.parse(storage.getItem('leaveRequests'));
                const newRequest = {
                    id: Date.now(),
                    userId: appState.currentUser.id,
                    leaveTypeId,
                    duration,
                    startDate,
                    endDate,
                    comment,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    document: null
                };

                // Ajouter le justificatif si fourni
                if (leaveType && leaveType.requiresDocument) {
                    const fileInput = document.getElementById('documentFile');
                    if (fileInput && fileInput.files && fileInput.files[0]) {
                        newRequest.document = {
                            name: fileInput.files[0].name,
                            size: fileInput.files[0].size,
                            type: fileInput.files[0].type,
                            uploadDate: new Date().toISOString()
                        };
                    }
                }

                leaveRequests.push(newRequest);
                storage.setItem('leaveRequests', JSON.stringify(leaveRequests));

                // Afficher l'email de confirmation
                showLeaveRequestConfirmationEmail(appState.currentUser, newRequest, daysCount);

                // Réinitialiser le formulaire
                e.target.reset();

                // Recharger la page après un court délai
                setTimeout(() => {
                    appState.render();
                }, 500);
            }

            // Formulaire d'ajout de type de congé
            if (e.target.id === 'addLeaveTypeForm') {
                e.preventDefault();
                const name = document.getElementById('newLeaveTypeName').value;
                const color = document.getElementById('newLeaveTypeColor').value;
                const category = document.getElementById('newLeaveTypeCategory').value;
                const requiresDocument = document.getElementById('requiresDocument').checked;

                const settings = JSON.parse(storage.getItem('settings'));
                const newId = Math.max(...settings.leaveTypes.map(t => t.id), 0) + 1;
                settings.leaveTypes.push({
                    id: newId,
                    name,
                    color,
                    category,
                    requiresDocument
                });
                storage.setItem('settings', JSON.stringify(settings));

                showNotification('Type de congé ajouté avec succès', 'success');
                appState.render();
            }

            // Formulaire d'ajout de jour férié
            if (e.target.id === 'addPublicHolidayForm') {
                e.preventDefault();
                const date = document.getElementById('newPublicHoliday').value;

                const settings = JSON.parse(storage.getItem('settings'));
                if (!settings.publicHolidays.includes(date)) {
                    settings.publicHolidays.push(date);
                    settings.publicHolidays.sort();
                    storage.setItem('settings', JSON.stringify(settings));
                }

                appState.render();
            }
        });

        // Fonction pour afficher la confirmation d'envoi d'email
        function showEmailConfirmation(email, prenom, nom) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-lg w-full">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Compte créé avec succès !</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            Un email de confirmation a été envoyé à <strong>${email}</strong>
                        </p>
                    </div>

                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                        <div class="flex items-start mb-3">
                            <svg class="w-5 h-5 text-primary mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-gray-900 dark:text-white mb-1">Objet : Bienvenue sur la plateforme de gestion des congés TUC</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">De : noreply@tuc.fr</p>
                                <div class="text-sm text-gray-700 dark:text-gray-300 space-y-2">
                                    <p>Bonjour ${prenom} ${nom},</p>
                                    <p>Votre compte a été créé avec succès sur la plateforme de gestion des congés du Toulouse Université Club.</p>
                                    <p>Vos informations de connexion :</p>
                                    <ul class="list-disc list-inside ml-4 space-y-1">
                                        <li>Email : ${email}</li>
                                        <li>Mot de passe : celui que vous avez choisi</li>
                                    </ul>
                                    <p class="font-semibold text-primary">Important : Votre type de contrat (congés payés, RTT) sera configuré par l'administrateur dans les prochaines 24-48 heures.</p>
                                    <p>Vous pouvez dès maintenant vous connecter à la plateforme.</p>
                                    <p class="mt-2">Cordialement,<br>L'équipe TUC</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="this.closest('.fixed').remove(); appState.setView('login')"
                        class="w-full bg-primary hover:bg-opacity-90 text-white font-semibold py-3 px-4 rounded-lg transition-all">
                        Se connecter maintenant
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Fonction pour afficher l'email de confirmation de demande de congé
        function showLeaveRequestConfirmationEmail(user, request, workingDays) {
            const settings = JSON.parse(storage.getItem('settings'));
            const leaveType = settings.leaveTypes.find(t => t.id === request.leaveTypeId);

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Email de confirmation envoyé !</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            Un récapitulatif a été envoyé à <strong>${user.email}</strong>
                        </p>
                    </div>

                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                        <div class="flex items-start mb-3">
                            <svg class="w-5 h-5 text-primary mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-gray-900 dark:text-white mb-1">Objet : Confirmation de votre demande de congé</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">De : rh@tuc.fr</p>
                                <div class="text-sm text-gray-700 dark:text-gray-300 space-y-2">
                                    <p>Bonjour ${user.prenom} ${user.nom},</p>
                                    <p>Nous avons bien reçu votre demande de congé. Voici le récapitulatif :</p>
                                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg my-3">
                                        <ul class="space-y-2">
                                            <li><strong>Type :</strong> ${leaveType.name}</li>
                                            <li><strong>Période :</strong> Du ${new Date(request.startDate).toLocaleDateString('fr-FR')} au ${new Date(request.endDate).toLocaleDateString('fr-FR')}</li>
                                            <li><strong>Durée :</strong> ${request.duration === 'full' ? 'Journée complète' : request.duration === 'morning' ? 'Matin' : 'Après-midi'}</li>
                                            <li><strong>Nombre de jours ouvrés :</strong> ${workingDays} jour${workingDays > 1 ? 's' : ''}</li>
                                            ${request.comment ? `<li><strong>Commentaire :</strong> ${request.comment}</li>` : ''}
                                        </ul>
                                    </div>
                                    <p class="font-semibold text-orange-600 dark:text-orange-400">Statut : En attente de validation</p>
                                    <p>Vous recevrez un email dès que votre demande sera traitée par un administrateur.</p>
                                    <p class="mt-2">Cordialement,<br>Le service RH - TUC</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="this.closest('.fixed').remove()"
                        class="w-full bg-primary hover:bg-opacity-90 text-white font-semibold py-3 px-4 rounded-lg transition-all">
                        Fermer
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Fonction pour afficher l'email de notification (validation ou refus)
        function showEmailNotification(user, request, action, adminComment, workingDays) {
            const settings = JSON.parse(storage.getItem('settings'));
            const leaveType = settings.leaveTypes.find(t => t.id === request.leaveTypeId);
            const isApproved = action === 'approved';

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-${isApproved ? 'green' : 'red'}-100 dark:bg-${isApproved ? 'green' : 'red'}-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-12 h-12 text-${isApproved ? 'green' : 'red'}-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Email de ${isApproved ? 'validation' : 'refus'} envoyé !</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            Une notification a été envoyée à <strong>${user.email}</strong>
                        </p>
                    </div>

                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                        <div class="flex items-start mb-3">
                            <svg class="w-5 h-5 text-primary mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-gray-900 dark:text-white mb-1">Objet : ${isApproved ? 'Validation' : 'Refus'} de votre demande de congé</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">De : directeur@toulouseuniversiteclub.fr</p>
                                <div class="text-sm text-gray-700 dark:text-gray-300 space-y-2">
                                    <p>Bonjour ${user.prenom} ${user.nom},</p>
                                    <p>Votre demande de congé a été <strong class="text-${isApproved ? 'green' : 'red'}-600 dark:text-${isApproved ? 'green' : 'red'}-400">${isApproved ? 'approuvée' : 'refusée'}</strong>.</p>
                                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg my-3">
                                        <p class="font-semibold mb-2">Récapitulatif de la demande :</p>
                                        <ul class="space-y-2">
                                            <li><strong>Type :</strong> ${leaveType.name}</li>
                                            <li><strong>Période :</strong> Du ${new Date(request.startDate).toLocaleDateString('fr-FR')} au ${new Date(request.endDate).toLocaleDateString('fr-FR')}</li>
                                            <li><strong>Durée :</strong> ${request.duration === 'full' ? 'Journée complète' : request.duration === 'morning' ? 'Matin' : 'Après-midi'}</li>
                                            ${isApproved ? `<li><strong>Nombre de jours ouvrés déduits :</strong> ${workingDays} jour${workingDays > 1 ? 's' : ''}</li>` : ''}
                                            ${request.comment ? `<li><strong>Votre commentaire :</strong> ${request.comment}</li>` : ''}
                                        </ul>
                                    </div>
                                    ${adminComment ? `
                                        <div class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 p-3 rounded-lg">
                                            <p class="font-semibold text-blue-800 dark:text-blue-200">Commentaire de l'administrateur :</p>
                                            <p class="text-blue-700 dark:text-blue-300 mt-1">${adminComment}</p>
                                        </div>
                                    ` : ''}
                                    ${isApproved ? `
                                        <p class="text-green-600 dark:text-green-400 font-semibold">✓ Votre absence a été enregistrée dans le système.</p>
                                        <p>Solde restant : <strong>${leaveType.name === 'RTT' ? user.soldeRTT : user.soldeConges} jours</strong></p>
                                    ` : `
                                        <p class="text-gray-600 dark:text-gray-400">Vous pouvez soumettre une nouvelle demande si nécessaire.</p>
                                    `}
                                    <p class="mt-2">Cordialement,<br>Le service RH - TUC</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="this.closest('.fixed').remove()"
                        class="w-full bg-primary hover:bg-opacity-90 text-white font-semibold py-3 px-4 rounded-lg transition-all">
                        Fermer
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Fonctions globales pour les actions admin
        function approveRequest(requestId) {
            showAdminCommentDialog(requestId, 'approved');
        }

        function rejectRequest(requestId) {
            showAdminCommentDialog(requestId, 'rejected');
        }

        function showAdminCommentDialog(requestId, action) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                        ${action === 'approved' ? 'Approuver' : 'Refuser'} la demande
                    </h3>
                    <textarea id="adminCommentInput" rows="3"
                        class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all mb-4"
                        placeholder="Commentaire (optionnel)"></textarea>
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()"
                            class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all">
                            Annuler
                        </button>
                        <button onclick="confirmAction(${requestId}, '${action}', document.getElementById('adminCommentInput').value); this.closest('.fixed').remove()"
                            class="px-4 py-2 ${action === 'approved' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'} text-white rounded-lg transition-all">
                            Confirmer
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmAction(requestId, action, adminComment) {
            const leaveRequests = JSON.parse(storage.getItem('leaveRequests'));
            const request = leaveRequests.find(r => r.id === requestId);

            if (request) {
                request.status = action;
                if (adminComment) {
                    request.adminComment = adminComment;
                }
                request.processedAt = new Date().toISOString();

                // Si approuvé, déduire du solde de congés
                if (action === 'approved') {
                    const users = JSON.parse(storage.getItem('users'));
                    const user = users.find(u => u.id === request.userId);
                    if (user) {
                        // Déterminer le type de congé pour utiliser le bon calcul
                        const settings = JSON.parse(storage.getItem('settings'));
                        const leaveType = settings.leaveTypes.find(t => t.id === request.leaveTypeId);

                        let daysToDeduct = 0;

                        if (leaveType && leaveType.name === 'RTT') {
                            // RTT = jours OUVRÉS (lun-ven, sans samedi/dimanche/fériés)
                            daysToDeduct = calculateWorkingDays(request.startDate, request.endDate, request.duration);
                            user.soldeRTT -= daysToDeduct;
                        } else {
                            // Congés Payés = jours OUVRABLES (lun-sam, sans dimanche/fériés)
                            daysToDeduct = calculateBusinessDays(request.startDate, request.endDate, request.duration);
                            user.soldeConges -= daysToDeduct;
                        }

                        storage.setItem('users', JSON.stringify(users));

                        // Envoyer l'email de validation
                        showEmailNotification(user, request, action, adminComment, daysToDeduct);
                    }
                } else if (action === 'rejected') {
                    // Envoyer l'email de refus
                    const users = JSON.parse(storage.getItem('users'));
                    const user = users.find(u => u.id === request.userId);
                    if (user) {
                        showEmailNotification(user, request, action, adminComment, 0);
                    }
                }

                storage.setItem('leaveRequests', JSON.stringify(leaveRequests));
                appState.render();
            }
        }

        function toggleDirectoryField(field) {
            const settings = JSON.parse(storage.getItem('settings'));
            if (field === 'email') {
                settings.showEmail = !settings.showEmail;
            } else if (field === 'phone') {
                settings.showPhone = !settings.showPhone;
            }
            storage.setItem('settings', JSON.stringify(settings));
            appState.render();
        }

        function toggleUserVisibility(userId, field) {
            const users = JSON.parse(storage.getItem('users'));
            const user = users.find(u => u.id === userId);
            if (user) {
                if (field === 'email') {
                    user.showEmail = !user.showEmail;
                } else if (field === 'phone') {
                    user.showPhone = !user.showPhone;
                }
                storage.setItem('users', JSON.stringify(users));
                appState.render();
            }
        }

        function handleDocumentSelect(input) {
            const fileName = document.getElementById('selectedFileName');
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                if (file.size > 5 * 1024 * 1024) {
                    fileName.innerHTML = '<span class="text-red-500">❌ Fichier trop volumineux (max 5MB)</span>';
                    input.value = '';
                } else {
                    fileName.innerHTML = `<span class="text-green-600 dark:text-green-400">✓ ${file.name} (${fileSizeMB} MB)</span>`;
                }
            } else {
                fileName.textContent = '';
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                info: 'bg-blue-500',
                warning: 'bg-orange-500',
                error: 'bg-red-500',
                success: 'bg-green-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function showAddUserModal() {
            const users = JSON.parse(storage.getItem('users'));
            const settings = JSON.parse(storage.getItem('settings'));

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Ajouter un utilisateur</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <form id="addUserForm" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Prénom -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prénom <span class="text-red-500">*</span></label>
                                <input type="text" id="newUserPrenom" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Nom -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom <span class="text-red-500">*</span></label>
                                <input type="text" id="newUserNom" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Email -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email <span class="text-red-500">*</span></label>
                                <input type="email" id="newUserEmail" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Mot de passe -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mot de passe <span class="text-red-500">*</span></label>
                                <input type="password" id="newUserPassword" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Poste -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Poste</label>
                                <input type="text" id="newUserPoste"
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Téléphone -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Téléphone</label>
                                <input type="tel" id="newUserPhone"
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Type de contrat -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type de contrat <span class="text-red-500">*</span></label>
                                <select id="newUserContract" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                    <option value="permanent_tuc">Permanent TUC</option>
                                    <option value="permanent_tuc_vacances">Permanent TUC VACANCES</option>
                                </select>
                            </div>

                            <!-- Date d'entrée -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date d'entrée <span class="text-red-500">*</span></label>
                                <input type="date" id="newUserDateEntree" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>
                        </div>

                        <!-- Rôles -->
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Rôles <span class="text-red-500">*</span></label>
                            <div class="flex flex-wrap gap-4">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="roleCollaborateur" value="collaborateur" checked
                                        class="w-5 h-5 text-primary rounded focus:ring-primary">
                                    <span class="text-gray-700 dark:text-gray-300">Collaborateur</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="roleManager" value="manager"
                                        class="w-5 h-5 text-primary rounded focus:ring-primary">
                                    <span class="text-gray-700 dark:text-gray-300">Manager</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="roleAdmin" value="admin"
                                        class="w-5 h-5 text-primary rounded focus:ring-primary">
                                    <span class="text-gray-700 dark:text-gray-300">Admin</span>
                                </label>
                            </div>
                        </div>

                        <!-- Équipes -->
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Équipes (séparées par des virgules)</label>
                            <input type="text" id="newUserTeams" placeholder="développement, animation, rh"
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                        </div>

                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()"
                                class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                                Annuler
                            </button>
                            <button type="submit"
                                class="px-6 py-3 bg-primary hover:bg-opacity-90 text-white font-semibold rounded-lg transition-all">
                                Créer l'utilisateur
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            // Gestionnaire de soumission
            document.getElementById('addUserForm').addEventListener('submit', (e) => {
                e.preventDefault();

                const prenom = document.getElementById('newUserPrenom').value;
                const nom = document.getElementById('newUserNom').value;
                const email = document.getElementById('newUserEmail').value;
                const password = document.getElementById('newUserPassword').value;
                const poste = document.getElementById('newUserPoste').value;
                const phone = document.getElementById('newUserPhone').value;
                const contractType = document.getElementById('newUserContract').value;
                const dateEntree = document.getElementById('newUserDateEntree').value;
                const teamsInput = document.getElementById('newUserTeams').value;

                // Vérifier si l'email existe déjà
                if (users.some(u => u.email === email)) {
                    showNotification('Cet email est déjà utilisé', 'error');
                    return;
                }

                // Collecter les rôles
                const roles = [];
                if (document.getElementById('roleCollaborateur').checked) roles.push('collaborateur');
                if (document.getElementById('roleManager').checked) roles.push('manager');
                if (document.getElementById('roleAdmin').checked) roles.push('admin');

                if (roles.length === 0) {
                    showNotification('Sélectionnez au moins un rôle', 'error');
                    return;
                }

                // Parser les équipes
                const teams = teamsInput ? teamsInput.split(',').map(t => t.trim()).filter(t => t) : [];

                // Calculer les congés
                const leaveInfo = calculateAcquiredLeave(dateEntree, settings.referencePeriod, settings.acquisitionPerMonth);

                // Créer le nouvel utilisateur
                const newUser = {
                    id: Date.now(),
                    email,
                    password,
                    nom,
                    prenom,
                    role: roles[0],
                    roles,
                    managerId: null,
                    contractType,
                    dateEntree,
                    soldeConges: leaveInfo.acquired || 30,
                    soldeRTT: 0,
                    hasRTT: contractType === 'permanent_tuc',
                    phone,
                    address: '',
                    poste,
                    documents: [],
                    documentRequests: [],
                    recoveryHours: contractType === 'permanent_tuc_vacances' ? [] : undefined,
                    showEmail: true,
                    showPhone: true,
                    teams
                };

                users.push(newUser);
                storage.setItem('users', JSON.stringify(users));

                showNotification('Utilisateur créé avec succès', 'success');
                modal.remove();
                appState.render();
            });
        }

        function editUser(userId) {
            const users = JSON.parse(storage.getItem('users'));
            const settings = JSON.parse(storage.getItem('settings'));
            const user = users.find(u => u.id === userId);

            if (!user) {
                showNotification('Utilisateur non trouvé', 'error');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Modifier l'utilisateur</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <form id="editUserForm" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Prénom -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prénom <span class="text-red-500">*</span></label>
                                <input type="text" id="editUserPrenom" value="${user.prenom}" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Nom -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom <span class="text-red-500">*</span></label>
                                <input type="text" id="editUserNom" value="${user.nom}" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Email -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email <span class="text-red-500">*</span></label>
                                <input type="email" id="editUserEmail" value="${user.email}" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Mot de passe -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nouveau mot de passe (laisser vide pour ne pas modifier)</label>
                                <input type="password" id="editUserPassword"
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Poste -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Poste</label>
                                <input type="text" id="editUserPoste" value="${user.poste || ''}"
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Téléphone -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Téléphone</label>
                                <input type="tel" id="editUserPhone" value="${user.phone || ''}"
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Structure de rattachement -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Structure de rattachement <span class="text-red-500">*</span></label>
                                <select id="editUserStructure" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                    <option value="TUC" ${(user.structure || '') === 'TUC' ? 'selected' : ''}>TUC</option>
                                    <option value="TUC VACANCES" ${(user.structure || '') === 'TUC VACANCES' ? 'selected' : ''}>TUC VACANCES</option>
                                </select>
                            </div>

                            <!-- Type de contrat -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type de contrat <span class="text-red-500">*</span></label>
                                <select id="editUserTypeContrat" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                    <option value="CDI" ${(user.typeContrat || '') === 'CDI' ? 'selected' : ''}>CDI</option>
                                    <option value="CDD" ${(user.typeContrat || '') === 'CDD' ? 'selected' : ''}>CDD</option>
                                    <option value="CEE" ${(user.typeContrat || '') === 'CEE' ? 'selected' : ''}>CEE</option>
                                </select>
                            </div>

                            <!-- Statut du contrat (ancien champ contractType) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Statut du contrat <span class="text-red-500">*</span></label>
                                <select id="editUserContract" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                    <option value="permanent_tuc" ${user.contractType === 'permanent_tuc' ? 'selected' : ''}>Permanent TUC</option>
                                    <option value="permanent_tuc_vacances" ${user.contractType === 'permanent_tuc_vacances' ? 'selected' : ''}>Permanent TUC VACANCES</option>
                                </select>
                            </div>

                            <!-- Date d'entrée -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date d'entrée <span class="text-red-500">*</span></label>
                                <input type="date" id="editUserDateEntree" value="${user.dateEntree}" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <!-- Manager/Responsable -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Manager / Responsable hiérarchique
                                    <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">(optionnel)</span>
                                </label>
                                <select id="editUserManager"
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                    <option value="">Aucun manager</option>
                                    ${users.filter(u => u.id !== user.id && (u.roles.includes('manager') || u.roles.includes('admin'))).map(manager => `
                                        <option value="${manager.id}" ${user.managerId === manager.id ? 'selected' : ''}>
                                            ${manager.prenom} ${manager.nom} ${manager.roles.includes('admin') ? '(Admin)' : '(Manager)'}
                                        </option>
                                    `).join('')}
                                </select>
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    💡 Le manager validera les documents de niveau "Manager" de ce collaborateur
                                </p>
                            </div>
                        </div>

                        <!-- Rôles -->
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Rôles <span class="text-red-500">*</span></label>
                            <div class="flex flex-wrap gap-4">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="editRoleCollaborateur" value="collaborateur" ${user.roles.includes('collaborateur') ? 'checked' : ''}
                                        class="w-5 h-5 text-primary rounded focus:ring-primary">
                                    <span class="text-gray-700 dark:text-gray-300">Collaborateur</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="editRoleManager" value="manager" ${user.roles.includes('manager') ? 'checked' : ''}
                                        class="w-5 h-5 text-primary rounded focus:ring-primary">
                                    <span class="text-gray-700 dark:text-gray-300">Manager</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="editRoleAdmin" value="admin" ${user.roles.includes('admin') ? 'checked' : ''}
                                        class="w-5 h-5 text-primary rounded focus:ring-primary">
                                    <span class="text-gray-700 dark:text-gray-300">Admin</span>
                                </label>
                            </div>
                        </div>

                        <!-- Équipes -->
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Équipes (séparées par des virgules)</label>
                            <input type="text" id="editUserTeams" value="${user.teams ? user.teams.join(', ') : ''}" placeholder="développement, animation, rh"
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                        </div>

                        <!-- RTT -->
                        <div class="mt-6 p-4 bg-cyan-50 dark:bg-cyan-900 border border-cyan-200 dark:border-cyan-700 rounded-lg">
                            <div class="flex items-center justify-between mb-4">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="editUserHasRTT" ${user.hasRTT ? 'checked' : ''}
                                        onchange="document.getElementById('editUserRTTSolde').disabled = !this.checked"
                                        class="w-5 h-5 text-primary focus:ring-2 focus:ring-primary rounded">
                                    <span class="text-sm font-semibold text-gray-900 dark:text-white">Autoriser les RTT pour cet utilisateur</span>
                                </label>
                            </div>
                            <div id="editRTTFieldContainer" class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nombre de jours RTT</label>
                                    <input type="number" id="editUserRTTSolde" value="${user.soldeRTT || 0}" min="0"
                                        ${!user.hasRTT ? 'disabled' : ''}
                                        class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed">
                                </div>
                            </div>
                        </div>

                        <!-- Permissions de menu -->
                        <div class="mt-6 p-4 bg-purple-50 dark:bg-purple-900 dark:bg-opacity-20 border border-purple-200 dark:border-purple-700 rounded-lg">
                            <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                                </svg>
                                Permissions des menus
                            </h4>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-4">Activez ou désactivez l'accès aux différents menus pour cet utilisateur. La Gestion documentaire ne peut pas être désactivée pour les managers et administrateurs.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                ${[
                                    { id: 'dashboard', label: 'Tableau de bord', icon: '🏠' },
                                    { id: 'profile', label: 'Mon Profil', icon: '👤' },
                                    { id: 'leave-management', label: 'Gestion des congés', icon: '📅' },
                                    { id: 'manager-space', label: 'Gestion documentaire', icon: '📄' },
                                    { id: 'document-validation', label: 'Validation document', icon: '✅' },
                                    { id: 'directory', label: 'Annuaire', icon: '📖' },
                                    { id: 'settings', label: 'Paramètres', icon: '⚙️' }
                                ].map(menu => {
                                    const isChecked = user.menuPermissions ? (user.menuPermissions[menu.id] !== false) : true;
                                    // La Gestion documentaire et la Validation document ne peuvent jamais être désactivées pour les managers et admins
                                    const isManagerOrAdmin = user.roles && (user.roles.includes('manager') || user.roles.includes('admin'));
                                    const isDisabled = ((menu.id === 'manager-space' || menu.id === 'document-validation') && isManagerOrAdmin);
                                    const isForceChecked = isDisabled || isChecked;

                                    return `
                                        <label class="flex items-center space-x-3 p-3 bg-white dark:bg-gray-800 rounded-lg ${isDisabled ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700'} transition-colors">
                                            <input type="checkbox" id="menu_${menu.id}" ${isForceChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}
                                                class="w-4 h-4 text-primary rounded focus:ring-primary ${isDisabled ? 'cursor-not-allowed' : ''}">
                                            <span class="text-sm text-gray-700 dark:text-gray-300">${menu.icon} ${menu.label}${isDisabled ? ' <span class="text-xs text-gray-500">(Toujours actif)</span>' : ''}</span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                            <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20 rounded-lg">
                                <p class="text-xs text-blue-800 dark:text-blue-300">
                                    💡 <strong>Note :</strong> La Gestion documentaire et la Validation document ne peuvent pas être désactivées et s'affichent automatiquement pour les utilisateurs ayant le rôle Manager ou Admin.
                                </p>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()"
                                class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                                Annuler
                            </button>
                            <button type="submit"
                                class="px-6 py-3 bg-primary hover:bg-opacity-90 text-white font-semibold rounded-lg transition-all">
                                Enregistrer les modifications
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            // Gestionnaire de soumission
            document.getElementById('editUserForm').addEventListener('submit', (e) => {
                e.preventDefault();

                const prenom = document.getElementById('editUserPrenom').value;
                const nom = document.getElementById('editUserNom').value;
                const email = document.getElementById('editUserEmail').value;
                const password = document.getElementById('editUserPassword').value;
                const poste = document.getElementById('editUserPoste').value;
                const phone = document.getElementById('editUserPhone').value;
                const structure = document.getElementById('editUserStructure').value;
                const typeContrat = document.getElementById('editUserTypeContrat').value;
                const contractType = document.getElementById('editUserContract').value;
                const dateEntree = document.getElementById('editUserDateEntree').value;
                const managerIdValue = document.getElementById('editUserManager').value;
                const managerId = managerIdValue ? parseInt(managerIdValue) : null;
                const teamsInput = document.getElementById('editUserTeams').value;

                // Vérifier si l'email existe déjà (sauf si c'est le même utilisateur)
                if (users.some(u => u.email === email && u.id !== userId)) {
                    showNotification('Cet email est déjà utilisé par un autre utilisateur', 'error');
                    return;
                }

                // Collecter les rôles
                const roles = [];
                if (document.getElementById('editRoleCollaborateur').checked) roles.push('collaborateur');
                if (document.getElementById('editRoleManager').checked) roles.push('manager');
                if (document.getElementById('editRoleAdmin').checked) roles.push('admin');

                if (roles.length === 0) {
                    showNotification('Sélectionnez au moins un rôle', 'error');
                    return;
                }

                // Parser les équipes
                const teams = teamsInput ? teamsInput.split(',').map(t => t.trim()).filter(t => t) : [];

                // Récupérer les valeurs RTT
                const hasRTT = document.getElementById('editUserHasRTT').checked;
                const soldeRTT = hasRTT ? parseInt(document.getElementById('editUserRTTSolde').value) || 0 : 0;

                // Collecter les permissions de menu
                const menuPermissions = {};
                ['dashboard', 'profile', 'leave-management', 'manager-space', 'document-validation', 'directory', 'settings'].forEach(menuId => {
                    const checkbox = document.getElementById(`menu_${menuId}`);
                    if (checkbox) {
                        menuPermissions[menuId] = checkbox.checked;
                    }
                });

                // Recalculer les congés si la date d'entrée a changé
                let soldeConges = user.soldeConges;
                if (dateEntree !== user.dateEntree) {
                    const leaveInfo = calculateAcquiredLeave(dateEntree, settings.referencePeriod, settings.acquisitionPerMonth);
                    soldeConges = leaveInfo.acquired || 30;
                }

                // Mettre à jour l'utilisateur
                const updatedUser = {
                    ...user,
                    prenom,
                    nom,
                    email,
                    poste,
                    phone,
                    structure,
                    typeContrat,
                    contractType,
                    dateEntree,
                    managerId,
                    roles,
                    role: roles[0], // Le rôle principal est le premier dans la liste
                    teams,
                    soldeConges,
                    hasRTT,
                    soldeRTT,
                    menuPermissions,
                    recoveryHours: contractType === 'permanent_tuc_vacances' ? (user.recoveryHours || []) : undefined
                };

                // Mettre à jour le mot de passe uniquement s'il a été modifié
                if (password) {
                    updatedUser.password = password;
                }

                // Remplacer l'utilisateur dans la liste
                const userIndex = users.findIndex(u => u.id === userId);
                users[userIndex] = updatedUser;
                storage.setItem('users', JSON.stringify(users));

                showNotification('Utilisateur modifié avec succès', 'success');
                modal.remove();
                appState.render();
            });
        }

        function manageUserDocuments(userId) {
            const users = JSON.parse(storage.getItem('users'));
            const settings = JSON.parse(storage.getItem('settings'));
            const user = users.find(u => u.id === userId);

            if (!user) {
                showNotification('Utilisateur non trouvé', 'error');
                return;
            }

            // Calculer les documents requis et manquants
            const requiredDocs = settings.documentTypes.filter(dt => {
                return dt.requiredForRoles && user.roles.some(role => dt.requiredForRoles.includes(role));
            });

            const uploadedDocTypes = (user.documents || []).map(d => d.type);
            const missingDocs = requiredDocs.filter(dt => !uploadedDocTypes.includes(dt.name));

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Gérer les documents</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${user.prenom} ${user.nom} - ${user.email}</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="p-6 space-y-6">
                        <!-- Récapitulatif -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                                <p class="text-blue-100 text-sm font-medium">Documents requis</p>
                                <p class="text-3xl font-bold mt-1">${requiredDocs.length}</p>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-4 text-white">
                                <p class="text-green-100 text-sm font-medium">Documents déposés</p>
                                <p class="text-3xl font-bold mt-1">${(user.documents || []).length}</p>
                            </div>
                            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg p-4 text-white">
                                <p class="text-red-100 text-sm font-medium">Documents manquants</p>
                                <p class="text-3xl font-bold mt-1">${missingDocs.length}</p>
                            </div>
                        </div>

                        <!-- Documents manquants -->
                        ${missingDocs.length > 0 ? `
                            <div class="bg-red-50 dark:bg-red-900 dark:bg-opacity-20 border border-red-200 dark:border-red-700 rounded-lg p-4">
                                <h4 class="font-bold text-red-800 dark:text-red-200 mb-3 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                    Documents manquants (${missingDocs.length})
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    ${missingDocs.map(dt => `
                                        <div class="flex items-center justify-between bg-white dark:bg-gray-800 rounded p-3">
                                            <span class="text-sm text-gray-900 dark:text-white font-medium">📄 ${dt.name}</span>
                                            <button onclick="uploadDocumentForUser(${userId}, '${dt.name}')"
                                                class="text-xs px-3 py-1 bg-primary text-white rounded hover:bg-opacity-90 transition-colors">
                                                + Ajouter
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : `
                            <div class="bg-green-50 dark:bg-green-900 dark:bg-opacity-20 border border-green-200 dark:border-green-700 rounded-lg p-4">
                                <p class="text-green-800 dark:text-green-200 text-center font-medium">
                                    ✓ Tous les documents requis ont été déposés
                                </p>
                            </div>
                        `}

                        <!-- Récapitulatif de tous les documents requis -->
                        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                            <h4 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                </svg>
                                Récapitulatif des documents requis
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                ${requiredDocs.map(dt => {
                                    const isUploaded = uploadedDocTypes.includes(dt.name);
                                    const uploadedDoc = isUploaded ? (user.documents || []).find(d => d.type === dt.name) : null;
                                    const validationStatus = uploadedDoc ? (uploadedDoc.validationStatus || uploadedDoc.status) : null;

                                    return `
                                        <div class="border ${isUploaded ? 'border-green-200 dark:border-green-700 bg-green-50 dark:bg-green-900 dark:bg-opacity-20' : 'border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700'} rounded-lg p-4">
                                            <div class="flex items-start justify-between mb-2">
                                                <div class="flex items-start space-x-2 flex-1">
                                                    ${isUploaded ? `
                                                        <svg class="w-5 h-5 text-green-600 dark:text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                    ` : `
                                                        <svg class="w-5 h-5 text-red-600 dark:text-red-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                    `}
                                                    <div class="flex-1 min-w-0">
                                                        <p class="text-sm font-semibold ${isUploaded ? 'text-green-900 dark:text-green-100' : 'text-gray-900 dark:text-white'} truncate">${dt.name}</p>
                                                        ${isUploaded ? `
                                                            <p class="text-xs ${validationStatus === 'validated' ? 'text-green-700 dark:text-green-300' : validationStatus === 'rejected' ? 'text-red-700 dark:text-red-300' : 'text-orange-700 dark:text-orange-300'} mt-1">
                                                                ${validationStatus === 'validated' ? '✓ Validé' : validationStatus === 'rejected' ? '✗ Refusé' : '⏳ En attente'}
                                                            </p>
                                                            ${uploadedDoc && uploadedDoc.validatedBy ? `
                                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                                                                    ${uploadedDoc.validatedBy === 'auto' ? 'Validation automatique' : `Validé par: ${(() => {
                                                                        const users = JSON.parse(storage.getItem('users'));
                                                                        const validator = users.find(u => u.id === uploadedDoc.validatedBy);
                                                                        return validator ? validator.prenom + ' ' + validator.nom : 'Inconnu';
                                                                    })()}`}
                                                                </p>
                                                            ` : ''}
                                                        ` : `
                                                            <p class="text-xs text-red-700 dark:text-red-300 mt-1">Manquant</p>
                                                        `}
                                                    </div>
                                                </div>
                                            </div>
                                            ${!isUploaded ? `
                                                <button onclick="uploadDocumentForUser(${userId}, '${dt.name}')"
                                                    class="w-full text-xs px-3 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition-colors flex items-center justify-center mt-2">
                                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                    </svg>
                                                    Ajouter
                                                </button>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Boutons pour gérer les documents -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <button onclick="requestDocumentFromUser(${userId})"
                                class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-4 rounded-lg transition-all flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                                </svg>
                                Demander un document
                            </button>
                            <button onclick="uploadDocumentForUser(${userId})"
                                class="bg-primary hover:bg-opacity-90 text-white font-semibold py-3 px-4 rounded-lg transition-all flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Ajouter un document
                            </button>
                        </div>

                        <!-- Liste des documents -->
                        <div>
                            <h4 class="font-bold text-gray-900 dark:text-white mb-4">Documents déposés (${(user.documents || []).length})</h4>
                            ${(user.documents || []).length === 0 ? `
                                <div class="text-center py-12 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <p class="text-gray-500 dark:text-gray-400">Aucun document déposé</p>
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${(user.documents || []).map(doc => {
                                        const statusColors = {
                                            pending: 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
                                            validated: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                                            rejected: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                                        };
                                        const statusLabels = {
                                            pending: '⏳ En attente',
                                            validated: '✓ Validé',
                                            rejected: '✗ Refusé'
                                        };
                                        const status = doc.validationStatus || doc.status || 'pending';
                                        return `
                                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                                                <div class="flex justify-between items-start">
                                                    <div class="flex-1">
                                                        <p class="font-semibold text-gray-900 dark:text-white">${doc.name}</p>
                                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${doc.type}</p>
                                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                            Ajouté le ${new Date(doc.uploadDate).toLocaleDateString('fr-FR')}
                                                        </p>
                                                        <span class="inline-block mt-2 px-2 py-1 rounded text-xs ${statusColors[status] || statusColors.pending}">
                                                            ${statusLabels[status] || statusLabels.pending}
                                                        </span>
                                                        ${doc.validationComment ? `
                                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                                                <strong>Commentaire:</strong> ${doc.validationComment}
                                                            </p>
                                                        ` : ''}
                                                    </div>
                                                    <button onclick="deleteUserDocument(${userId}, ${doc.id})"
                                                        class="text-red-500 hover:text-red-700 transition-all">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function uploadDocumentForUser(userId, preselectedType = null) {
            const users = JSON.parse(storage.getItem('users'));
            const settings = JSON.parse(storage.getItem('settings'));
            const user = users.find(u => u.id === userId);

            if (!user) {
                showNotification('Utilisateur non trouvé', 'error');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Ajouter un document</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Pour ${user.prenom} ${user.nom}</p>
                    </div>
                    <form id="addDocumentForUserForm" class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom du document <span class="text-red-500">*</span></label>
                                <input type="text" id="adminDocName" required value="${preselectedType || ''}"
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                                    placeholder="Ex: RIB">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type de document <span class="text-red-500">*</span></label>
                                <select id="adminDocType" required
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                    <option value="">Sélectionnez un type</option>
                                    ${settings.documentTypes.map(dt =>
                                        `<option value="${dt.name}" ${preselectedType === dt.name ? 'selected' : ''}>${dt.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()"
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                                Annuler
                            </button>
                            <button type="submit"
                                class="px-4 py-2 bg-primary hover:bg-opacity-90 text-white font-semibold rounded-lg transition-all">
                                Ajouter
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('addDocumentForUserForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const docName = document.getElementById('adminDocName').value;
                const docType = document.getElementById('adminDocType').value;

                // Récupérer les infos du type de document pour déterminer le statut
                const documentType = settings.documentTypes.find(dt => dt.name === docType);
                const initialStatus = documentType && documentType.validationRequired === false ? 'validated' : 'pending';

                const newDoc = {
                    id: Date.now(),
                    name: docName,
                    type: docType,
                    uploadDate: new Date().toISOString(),
                    validationStatus: initialStatus,
                    validatedBy: initialStatus === 'validated' ? 'auto' : null,
                    validatedAt: initialStatus === 'validated' ? new Date().toISOString() : null,
                    validationComment: null,
                    uploadedBy: `admin:${appState.currentUser.id}`, // Marquer que c'est l'admin qui a uploadé
                    status: 'pending'
                };

                if (!user.documents) user.documents = [];
                user.documents.push(newDoc);

                const userIndex = users.findIndex(u => u.id === userId);
                users[userIndex] = user;
                storage.setItem('users', JSON.stringify(users));

                showNotification('Document ajouté avec succès', 'success');
                modal.remove();
                // Fermer le modal parent et rouvrir manageUserDocuments
                document.querySelectorAll('.fixed').forEach(m => m.remove());
                manageUserDocuments(userId);
            });
        }

        function deleteUserDocument(userId, documentId) {
            const users = JSON.parse(storage.getItem('users'));
            const userIndex = users.findIndex(u => u.id === userId);

            if (userIndex === -1) {
                showNotification('Utilisateur non trouvé', 'error');
                return;
            }

            const user = users[userIndex];
            user.documents = (user.documents || []).filter(d => d.id !== documentId);
            users[userIndex] = user;
            storage.setItem('users', JSON.stringify(users));

            showNotification('Document supprimé', 'success');
            // Fermer tous les modals et rouvrir manageUserDocuments
            document.querySelectorAll('.fixed').forEach(m => m.remove());
            manageUserDocuments(userId);
        }

        function deleteUser(userId) {
            const users = JSON.parse(storage.getItem('users'));
            const user = users.find(u => u.id === userId);

            if (!user) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Confirmer la suppression</h3>
                        <p class="text-gray-600 dark:text-gray-400">
                            Êtes-vous sûr de vouloir supprimer <strong>${user.prenom} ${user.nom}</strong> ?
                        </p>
                        <p class="text-sm text-red-600 dark:text-red-400 mt-2">
                            Cette action est irréversible.
                        </p>
                    </div>

                    <div class="flex space-x-3">
                        <button onclick="this.closest('.fixed').remove()"
                            class="flex-1 px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                            Annuler
                        </button>
                        <button onclick="confirmDeleteUser(${userId})"
                            class="flex-1 px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition-all">
                            Supprimer
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function confirmDeleteUser(userId) {
            const users = JSON.parse(storage.getItem('users'));
            const updatedUsers = users.filter(u => u.id !== userId);
            storage.setItem('users', JSON.stringify(updatedUsers));

            // Supprimer aussi les demandes de congés de l'utilisateur
            const leaveRequests = JSON.parse(storage.getItem('leaveRequests'));
            const updatedRequests = leaveRequests.filter(r => r.userId !== userId);
            storage.setItem('leaveRequests', JSON.stringify(updatedRequests));

            document.querySelector('.fixed.inset-0').remove();
            showNotification('Utilisateur supprimé avec succès', 'success');
            appState.render();
        }

        // Event listener pour afficher/masquer le champ justificatif selon le type de congé
        document.addEventListener('change', (e) => {
            if (e.target.id === 'leaveType') {
                const settings = JSON.parse(storage.getItem('settings'));
                const leaveTypeId = parseInt(e.target.value);
                const leaveType = settings.leaveTypes.find(t => t.id === leaveTypeId);
                const documentSection = document.getElementById('documentUploadSection');
                const documentFile = document.getElementById('documentFile');

                if (documentSection) {
                    if (leaveType && leaveType.requiresDocument) {
                        documentSection.classList.remove('hidden');
                        if (documentFile) documentFile.setAttribute('required', 'required');
                    } else {
                        documentSection.classList.add('hidden');
                        if (documentFile) {
                            documentFile.removeAttribute('required');
                            documentFile.value = '';
                        }
                        const fileName = document.getElementById('selectedFileName');
                        if (fileName) fileName.textContent = '';
                    }
                }
            }
        });

        function deleteLeaveType(typeId) {
            const settings = JSON.parse(storage.getItem('settings'));
            settings.leaveTypes = settings.leaveTypes.filter(t => t.id !== typeId);
            storage.setItem('settings', JSON.stringify(settings));
            appState.render();
        }

        function toggleLeaveCategory(category) {
            const element = document.getElementById(category === 'regular' ? 'regularLeaves' : 'specialLeaves');
            const chevron = document.getElementById(category === 'regular' ? 'regularChevron' : 'specialChevron');

            if (element.style.display === 'none') {
                element.style.display = 'block';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                element.style.display = 'none';
                chevron.style.transform = 'rotate(-90deg)';
            }
        }

        function toggleHolidaysSection() {
            const element = document.getElementById('holidaysContent');
            const chevron = document.getElementById('holidaysChevron');

            if (element.style.display === 'none') {
                element.style.display = 'block';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                element.style.display = 'none';
                chevron.style.transform = 'rotate(-90deg)';
            }
        }

        function toggleSettingsSection(sectionName) {
            const element = document.getElementById(sectionName + 'Content');
            const chevron = document.getElementById(sectionName + 'Chevron');

            if (element.style.display === 'none') {
                element.style.display = 'block';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                element.style.display = 'none';
                chevron.style.transform = 'rotate(-90deg)';
            }
        }

        function updateReminderSetting(type, enabled) {
            const settings = JSON.parse(storage.getItem('settings'));
            if (!settings.reminders) settings.reminders = {};
            settings.reminders[type] = enabled;
            storage.setItem('settings', JSON.stringify(settings));
            showNotification(`Rappels ${type === 'email' ? 'email' : 'app'} ${enabled ? 'activés' : 'désactivés'}`, 'success');
        }

        function showAddReminderModal() {
            const settings = JSON.parse(storage.getItem('settings'));

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Ajouter un rappel personnalisé</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <form id="addReminderForm" class="p-6 space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Titre du rappel <span class="text-red-500">*</span></label>
                            <input type="text" id="reminderTitle" required
                                placeholder="Ex: Mise à jour des documents"
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Message du rappel <span class="text-red-500">*</span></label>
                            <textarea id="reminderMessage" required rows="3"
                                placeholder="Ex: N'oubliez pas de mettre à jour vos documents avant la fin du mois"
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fréquence <span class="text-red-500">*</span></label>
                            <select id="reminderFrequency" required
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                <option value="daily">Quotidien</option>
                                <option value="weekly">Hebdomadaire</option>
                                <option value="monthly">Mensuel</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Destinataires</label>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="collaborateur" checked class="reminder-role-checkbox w-4 h-4 text-primary rounded">
                                    <span class="text-gray-700 dark:text-gray-300">Collaborateurs</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="manager" class="reminder-role-checkbox w-4 h-4 text-primary rounded">
                                    <span class="text-gray-700 dark:text-gray-300">Managers</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="admin" class="reminder-role-checkbox w-4 h-4 text-primary rounded">
                                    <span class="text-gray-700 dark:text-gray-300">Administrateurs</span>
                                </label>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()"
                                class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                                Annuler
                            </button>
                            <button type="submit"
                                class="px-6 py-3 bg-primary hover:bg-opacity-90 text-white font-semibold rounded-lg transition-all">
                                Ajouter le rappel
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            document.getElementById('addReminderForm').addEventListener('submit', (e) => {
                e.preventDefault();

                const title = document.getElementById('reminderTitle').value;
                const message = document.getElementById('reminderMessage').value;
                const frequency = document.getElementById('reminderFrequency').value;

                const targetRoles = [];
                document.querySelectorAll('.reminder-role-checkbox:checked').forEach(checkbox => {
                    targetRoles.push(checkbox.value);
                });

                if (!settings.customReminders) settings.customReminders = [];
                const newId = Math.max(...(settings.customReminders.map(r => r.id) || [0]), 0) + 1;

                settings.customReminders.push({
                    id: newId,
                    title,
                    message,
                    frequency,
                    targetRoles,
                    enabled: true
                });

                storage.setItem('settings', JSON.stringify(settings));
                showNotification('Rappel ajouté avec succès', 'success');
                modal.remove();
                appState.render();
            });
        }

        function deleteReminder(reminderId) {
            const settings = JSON.parse(storage.getItem('settings'));
            const reminder = settings.customReminders.find(r => r.id === reminderId);

            if (!reminder) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Supprimer le rappel</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        Êtes-vous sûr de vouloir supprimer le rappel "<strong>${reminder.title}</strong>" ?
                    </p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()"
                            class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                            Annuler
                        </button>
                        <button onclick="confirmDeleteReminder(${reminderId})"
                            class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition-all">
                            Supprimer
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function confirmDeleteReminder(reminderId) {
            const settings = JSON.parse(storage.getItem('settings'));
            settings.customReminders = settings.customReminders.filter(r => r.id !== reminderId);
            storage.setItem('settings', JSON.stringify(settings));

            document.querySelector('.fixed.inset-0').remove();
            showNotification('Rappel supprimé avec succès', 'success');
            appState.render();
        }

        function showRTTRemindersModal() {
            const settings = JSON.parse(storage.getItem('settings'));
            const rttReminders = settings.rttReminders || {
                enabled: true,
                startMonth: 9, // Septembre
                endMonth: 12,  // Décembre
                frequency: 'monthly' // monthly, weekly
            };

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Configuration des rappels RTT</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Configurez les rappels automatiques pour inciter les collaborateurs à poser leurs RTT</p>
                    </div>

                    <form id="rttRemindersForm" class="p-6 space-y-6">
                        <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <span class="text-gray-900 dark:text-white font-medium">Activer les rappels RTT automatiques</span>
                            <input type="checkbox" id="rttRemindersEnabled" ${rttReminders.enabled ? 'checked' : ''}
                                class="w-5 h-5 text-primary focus:ring-2 focus:ring-primary rounded">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mois de début</label>
                                <select id="rttStartMonth" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                    <option value="9" ${rttReminders.startMonth === 9 ? 'selected' : ''}>Septembre</option>
                                    <option value="10" ${rttReminders.startMonth === 10 ? 'selected' : ''}>Octobre</option>
                                    <option value="11" ${rttReminders.startMonth === 11 ? 'selected' : ''}>Novembre</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mois de fin</label>
                                <select id="rttEndMonth" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                    <option value="12" ${rttReminders.endMonth === 12 ? 'selected' : ''}>Décembre</option>
                                    <option value="11" ${rttReminders.endMonth === 11 ? 'selected' : ''}>Novembre</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fréquence des rappels</label>
                            <select id="rttFrequency" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                <option value="monthly" ${rttReminders.frequency === 'monthly' ? 'selected' : ''}>Mensuel (1er de chaque mois)</option>
                                <option value="weekly" ${rttReminders.frequency === 'weekly' ? 'selected' : ''}>Hebdomadaire (chaque lundi)</option>
                            </select>
                        </div>

                        <div class="p-4 bg-orange-50 dark:bg-orange-900 border border-orange-200 dark:border-orange-700 rounded-lg">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-orange-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                                <p class="text-sm text-orange-800 dark:text-orange-200">
                                    Les rappels seront envoyés à tous les collaborateurs ayant des RTT entre ${rttReminders.startMonth === 9 ? 'septembre' : 'octobre'} et ${rttReminders.endMonth === 12 ? 'décembre' : 'novembre'}.
                                </p>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()"
                                class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                                Annuler
                            </button>
                            <button type="submit"
                                class="px-6 py-3 bg-primary hover:bg-opacity-90 text-white font-semibold rounded-lg transition-all">
                                Enregistrer
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            document.getElementById('rttRemindersForm').addEventListener('submit', (e) => {
                e.preventDefault();

                settings.rttReminders = {
                    enabled: document.getElementById('rttRemindersEnabled').checked,
                    startMonth: parseInt(document.getElementById('rttStartMonth').value),
                    endMonth: parseInt(document.getElementById('rttEndMonth').value),
                    frequency: document.getElementById('rttFrequency').value
                };

                storage.setItem('settings', JSON.stringify(settings));
                showNotification('Configuration des rappels RTT enregistrée', 'success');
                modal.remove();
            });
        }

        function showAddDocumentModal() {
            const settings = JSON.parse(storage.getItem('settings'));

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Ajouter un nouveau document</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <form id="addDocTypeForm" class="p-6 space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom du document <span class="text-red-500">*</span></label>
                            <input type="text" id="newDocName" required
                                placeholder="Ex: Casier judiciaire, Permis de conduire..."
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Durée de validité (mois)</label>
                                <input type="number" id="newDocValidityMonths" min="0"
                                    placeholder="Laisser vide si illimitée"
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Destruction automatique (mois après expiration)</label>
                                <input type="number" id="newDocAutoDeleteMonths" min="0"
                                    placeholder="Laisser vide si manuelle"
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">À qui demander ce document <span class="text-red-500">*</span></label>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Sélectionnez les niveaux de responsabilité à qui ce document sera demandé</p>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="collaborateur" checked class="new-doc-role-checkbox w-4 h-4 text-primary rounded">
                                    <span class="text-gray-700 dark:text-gray-300">Collaborateur</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="manager" class="new-doc-role-checkbox w-4 h-4 text-primary rounded">
                                    <span class="text-gray-700 dark:text-gray-300">Manager</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="admin" class="new-doc-role-checkbox w-4 h-4 text-primary rounded">
                                    <span class="text-gray-700 dark:text-gray-300">Admin</span>
                                </label>
                            </div>
                        </div>

                        <div class="border-l-4 border-purple-500 bg-purple-50 dark:bg-purple-900 dark:bg-opacity-20 p-4 rounded-r-lg">
                            <label class="block text-sm font-medium text-gray-900 dark:text-white mb-3">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span>Validation du document <span class="text-red-500">*</span></span>
                                </div>
                            </label>
                            <div class="space-y-3">
                                <div>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" id="newDocValidationRequired" checked class="w-4 h-4 text-primary rounded">
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Ce document nécessite une validation</span>
                                    </label>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 ml-7 mt-1">Si décoché, le document est automatiquement validé dès le dépôt</p>
                                </div>
                                <div id="newDocValidationLevelSection">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Niveau de validation requis</label>
                                    <select id="newDocValidationLevel" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                        <option value="manager">👔 Manager (le manager du collaborateur peut valider)</option>
                                        <option value="admin">👑 Admin (seul l'administrateur peut valider)</option>
                                    </select>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                        💡 <strong>Manager</strong> : Le manager direct du collaborateur peut valider<br>
                                        💡 <strong>Admin</strong> : Seul l'administrateur peut valider (documents très sensibles)
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="border-l-4 border-yellow-500 bg-yellow-50 dark:bg-yellow-900 dark:bg-opacity-20 p-4 rounded-r-lg">
                            <label class="block text-sm font-medium text-gray-900 dark:text-white mb-3">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                    <span>Permissions d'accès par rôle <span class="text-red-500">*</span></span>
                                </div>
                            </label>
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-3 mb-4">
                                <p class="text-xs text-gray-700 dark:text-gray-300 font-medium mb-2">📋 Types de permissions :</p>
                                <ul class="text-xs text-gray-600 dark:text-gray-400 space-y-1 ml-4 list-disc">
                                    <li><strong>👁️ Consultation</strong> : Peut voir le contenu du document</li>
                                    <li><strong>📥 Téléchargement</strong> : Peut télécharger le fichier (nécessite Consultation)</li>
                                    <li><strong>📅 Date de dépôt</strong> : Voit uniquement "✓ Déposé le XX/XX" sans accès au fichier</li>
                                </ul>
                            </div>

                            <!-- Admin -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 mb-3 border-2 border-red-200 dark:border-red-800">
                                <div class="flex items-center space-x-2 mb-3">
                                    <span class="text-sm font-semibold text-gray-900 dark:text-white">👑 Admin</span>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" checked class="new-perm-admin-view w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">👁️ Consultation</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" checked class="new-perm-admin-download w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">📥 Téléchargement</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="new-perm-admin-date w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">📅 Date dépôt</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Manager -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 mb-3 border-2 border-blue-200 dark:border-blue-800">
                                <div class="flex items-center space-x-2 mb-3">
                                    <span class="text-sm font-semibold text-gray-900 dark:text-white">👔 Manager</span>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="new-perm-manager-view w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">👁️ Consultation</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="new-perm-manager-download w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">📥 Téléchargement</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" checked class="new-perm-manager-date w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">📅 Date dépôt</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Collaborateur -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border-2 border-green-200 dark:border-green-800">
                                <div class="flex items-center space-x-2 mb-3">
                                    <span class="text-sm font-semibold text-gray-900 dark:text-white">👤 Collaborateur (propriétaire)</span>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" checked class="new-perm-collab-view w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">👁️ Consultation</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" checked class="new-perm-collab-download w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">📥 Téléchargement</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="new-perm-collab-date w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">📅 Date dépôt</span>
                                    </label>
                                </div>
                            </div>

                            <p class="text-xs text-yellow-700 dark:text-yellow-400 mt-3 italic">
                                ⚠️ Les collaborateurs ne voient jamais les documents d'autres collaborateurs
                            </p>
                        </div>

                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()"
                                class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                                Annuler
                            </button>
                            <button type="submit"
                                class="px-6 py-3 bg-primary hover:bg-opacity-90 text-white font-semibold rounded-lg transition-all">
                                Ajouter
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            // Gérer l'affichage du niveau de validation
            const validationRequiredCheckbox = document.getElementById('newDocValidationRequired');
            const validationLevelSection = document.getElementById('newDocValidationLevelSection');

            validationRequiredCheckbox.addEventListener('change', (e) => {
                validationLevelSection.style.display = e.target.checked ? 'block' : 'none';
            });

            document.getElementById('addDocTypeForm').addEventListener('submit', (e) => {
                e.preventDefault();

                const name = document.getElementById('newDocName').value;
                const validityMonths = parseInt(document.getElementById('newDocValidityMonths').value) || null;
                const autoDeleteMonths = parseInt(document.getElementById('newDocAutoDeleteMonths').value) || null;

                const requiredForRoles = [];
                document.querySelectorAll('.new-doc-role-checkbox:checked').forEach(checkbox => {
                    requiredForRoles.push(checkbox.value);
                });

                if (requiredForRoles.length === 0) {
                    showNotification('Sélectionnez au moins un niveau à qui demander le document', 'error');
                    return;
                }

                // Récupérer les permissions granulaires
                const permissions = {
                    admin: {
                        canView: document.querySelector('.new-perm-admin-view').checked,
                        canDownload: document.querySelector('.new-perm-admin-download').checked,
                        canSeeDepositDate: document.querySelector('.new-perm-admin-date').checked
                    },
                    manager: {
                        canView: document.querySelector('.new-perm-manager-view').checked,
                        canDownload: document.querySelector('.new-perm-manager-download').checked,
                        canSeeDepositDate: document.querySelector('.new-perm-manager-date').checked
                    },
                    collaborateur: {
                        canView: document.querySelector('.new-perm-collab-view').checked,
                        canDownload: document.querySelector('.new-perm-collab-download').checked,
                        canSeeDepositDate: document.querySelector('.new-perm-collab-date').checked
                    }
                };

                // Validation : au moins une permission doit être accordée quelque part
                const hasAnyPermission = Object.values(permissions).some(role =>
                    role.canView || role.canDownload || role.canSeeDepositDate
                );

                if (!hasAnyPermission) {
                    showNotification('Accordez au moins une permission à un rôle', 'error');
                    return;
                }

                // Récupérer les infos de validation
                const validationRequired = document.getElementById('newDocValidationRequired').checked;
                const validationLevel = document.getElementById('newDocValidationLevel').value;

                const newId = Math.max(...settings.documentTypes.map(d => d.id), 0) + 1;
                settings.documentTypes.push({
                    id: newId,
                    name,
                    validityMonths,
                    autoDeleteMonths,
                    requiredForRoles,
                    permissions,
                    validationRequired,
                    validationLevel,
                    required: true
                });

                storage.setItem('settings', JSON.stringify(settings));
                showNotification('Document ajouté avec succès', 'success');
                modal.remove();
                appState.render();
            });
        }

        function deleteDocumentType(docId) {
            const settings = JSON.parse(storage.getItem('settings'));
            const doc = settings.documentTypes.find(d => d.id === docId);

            if (!doc) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Confirmer la suppression</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        Êtes-vous sûr de vouloir supprimer le document "<strong>${doc.name}</strong>" ?
                        Cette action est irréversible.
                    </p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()"
                            class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                            Annuler
                        </button>
                        <button onclick="confirmDeleteDocumentType(${docId})"
                            class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition-all">
                            Supprimer
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function confirmDeleteDocumentType(docId) {
            const settings = JSON.parse(storage.getItem('settings'));
            settings.documentTypes = settings.documentTypes.filter(d => d.id !== docId);
            storage.setItem('settings', JSON.stringify(settings));

            document.querySelector('.fixed.inset-0').remove();
            showNotification('Document supprimé avec succès', 'success');
            appState.render();
        }

        function editDocumentType(docId) {
            const settings = JSON.parse(storage.getItem('settings'));
            const doc = settings.documentTypes.find(d => d.id === docId);

            if (!doc) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10">
                        <div class="flex items-center justify-between">
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Modifier le document</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <form id="editDocTypeForm" class="p-6 space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom du document <span class="text-red-500">*</span></label>
                            <input type="text" id="editDocName" value="${doc.name}" required
                                placeholder="Ex: Casier judiciaire, Permis de conduire..."
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Durée de validité (mois)</label>
                                <input type="number" id="editDocValidityMonths" value="${doc.validityMonths || ''}" min="0"
                                    placeholder="Laisser vide si illimitée"
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Destruction automatique (mois après expiration)</label>
                                <input type="number" id="editDocAutoDeleteMonths" value="${doc.autoDeleteMonths || ''}" min="0"
                                    placeholder="Laisser vide si manuelle"
                                    class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">À qui demander ce document <span class="text-red-500">*</span></label>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Sélectionnez les niveaux de responsabilité à qui ce document sera demandé</p>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="collaborateur" ${(doc.requiredForRoles || ['collaborateur', 'manager', 'admin']).includes('collaborateur') ? 'checked' : ''}
                                        class="edit-doc-role-checkbox w-4 h-4 text-primary rounded">
                                    <span class="text-gray-700 dark:text-gray-300">Collaborateur</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="manager" ${(doc.requiredForRoles || ['collaborateur', 'manager', 'admin']).includes('manager') ? 'checked' : ''}
                                        class="edit-doc-role-checkbox w-4 h-4 text-primary rounded">
                                    <span class="text-gray-700 dark:text-gray-300">Manager</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="admin" ${(doc.requiredForRoles || ['collaborateur', 'manager', 'admin']).includes('admin') ? 'checked' : ''}
                                        class="edit-doc-role-checkbox w-4 h-4 text-primary rounded">
                                    <span class="text-gray-700 dark:text-gray-300">Admin</span>
                                </label>
                            </div>
                        </div>

                        <div class="border-l-4 border-purple-500 bg-purple-50 dark:bg-purple-900 dark:bg-opacity-20 p-4 rounded-r-lg">
                            <label class="block text-sm font-medium text-gray-900 dark:text-white mb-3">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span>Validation du document <span class="text-red-500">*</span></span>
                                </div>
                            </label>
                            <div class="space-y-3">
                                <div>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" id="editDocValidationRequired" ${doc.validationRequired !== false ? 'checked' : ''} class="w-4 h-4 text-primary rounded">
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Ce document nécessite une validation</span>
                                    </label>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 ml-7 mt-1">Si décoché, le document est automatiquement validé dès le dépôt</p>
                                </div>
                                <div id="editDocValidationLevelSection" style="display: ${doc.validationRequired !== false ? 'block' : 'none'}">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Niveau de validation requis</label>
                                    <select id="editDocValidationLevel" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                        <option value="manager" ${doc.validationLevel === 'manager' ? 'selected' : ''}>👔 Manager (le manager du collaborateur peut valider)</option>
                                        <option value="admin" ${doc.validationLevel === 'admin' || !doc.validationLevel ? 'selected' : ''}>👑 Admin (seul l'administrateur peut valider)</option>
                                    </select>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                        💡 <strong>Manager</strong> : Le manager direct du collaborateur peut valider<br>
                                        💡 <strong>Admin</strong> : Seul l'administrateur peut valider (documents très sensibles)
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="border-l-4 border-yellow-500 bg-yellow-50 dark:bg-yellow-900 dark:bg-opacity-20 p-4 rounded-r-lg">
                            <label class="block text-sm font-medium text-gray-900 dark:text-white mb-3">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                    <span>Permissions d'accès par rôle <span class="text-red-500">*</span></span>
                                </div>
                            </label>
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-3 mb-4">
                                <p class="text-xs text-gray-700 dark:text-gray-300 font-medium mb-2">📋 Types de permissions :</p>
                                <ul class="text-xs text-gray-600 dark:text-gray-400 space-y-1 ml-4 list-disc">
                                    <li><strong>👁️ Consultation</strong> : Peut voir le contenu du document</li>
                                    <li><strong>📥 Téléchargement</strong> : Peut télécharger le fichier (nécessite Consultation)</li>
                                    <li><strong>📅 Date de dépôt</strong> : Voit uniquement "✓ Déposé le XX/XX" sans accès au fichier</li>
                                </ul>
                            </div>

                            <!-- Admin -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 mb-3 border-2 border-red-200 dark:border-red-800">
                                <div class="flex items-center space-x-2 mb-3">
                                    <span class="text-sm font-semibold text-gray-900 dark:text-white">👑 Admin</span>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" ${doc.permissions?.admin?.canView !== false ? 'checked' : ''} class="edit-perm-admin-view w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">👁️ Consultation</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" ${doc.permissions?.admin?.canDownload !== false ? 'checked' : ''} class="edit-perm-admin-download w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">📥 Téléchargement</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" ${doc.permissions?.admin?.canSeeDepositDate ? 'checked' : ''} class="edit-perm-admin-date w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">📅 Date dépôt</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Manager -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 mb-3 border-2 border-blue-200 dark:border-blue-800">
                                <div class="flex items-center space-x-2 mb-3">
                                    <span class="text-sm font-semibold text-gray-900 dark:text-white">👔 Manager</span>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" ${doc.permissions?.manager?.canView ? 'checked' : ''} class="edit-perm-manager-view w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">👁️ Consultation</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" ${doc.permissions?.manager?.canDownload ? 'checked' : ''} class="edit-perm-manager-download w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">📥 Téléchargement</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" ${doc.permissions?.manager?.canSeeDepositDate !== false ? 'checked' : ''} class="edit-perm-manager-date w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">📅 Date dépôt</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Collaborateur -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border-2 border-green-200 dark:border-green-800">
                                <div class="flex items-center space-x-2 mb-3">
                                    <span class="text-sm font-semibold text-gray-900 dark:text-white">👤 Collaborateur (propriétaire)</span>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" ${doc.permissions?.collaborateur?.canView !== false ? 'checked' : ''} class="edit-perm-collab-view w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">👁️ Consultation</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" ${doc.permissions?.collaborateur?.canDownload !== false ? 'checked' : ''} class="edit-perm-collab-download w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">📥 Téléchargement</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" ${doc.permissions?.collaborateur?.canSeeDepositDate ? 'checked' : ''} class="edit-perm-collab-date w-4 h-4 text-primary rounded">
                                        <span class="text-xs text-gray-700 dark:text-gray-300">📅 Date dépôt</span>
                                    </label>
                                </div>
                            </div>

                            <p class="text-xs text-yellow-700 dark:text-yellow-400 mt-3 italic">
                                ⚠️ Les collaborateurs ne voient jamais les documents d'autres collaborateurs
                            </p>
                        </div>

                        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <span>Déposer un document template (optionnel)</span>
                                </div>
                            </label>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Vous pouvez déposer un document type/exemple pour ce type de document (ex: modèle vierge de formulaire)</p>
                            <div class="mt-2">
                                <input type="file" id="editDocTemplate" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                    class="w-full px-4 py-3 text-base rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-opacity-90 cursor-pointer">
                                <div id="editTemplatePreview" class="mt-3"></div>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 border-t border-gray-200 dark:border-gray-700 pt-6">
                            <button type="button" onclick="this.closest('.fixed').remove()"
                                class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                                Annuler
                            </button>
                            <button type="submit"
                                class="px-6 py-3 bg-primary hover:bg-opacity-90 text-white font-semibold rounded-lg transition-all">
                                Enregistrer les modifications
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            // Afficher le template existant s'il y en a un
            if (doc.templateFile) {
                const preview = document.getElementById('editTemplatePreview');
                preview.innerHTML = `
                    <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5 text-blue-600 dark:text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <div>
                                <p class="text-sm font-medium text-blue-900 dark:text-blue-100">Template actuel</p>
                                <p class="text-xs text-blue-700 dark:text-blue-300">${doc.templateFile.name}</p>
                            </div>
                        </div>
                        <button type="button" onclick="removeExistingTemplate(${docId})" class="text-red-500 hover:text-red-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `;
            }

            // Preview du nouveau fichier uploadé
            document.getElementById('editDocTemplate').addEventListener('change', (e) => {
                const file = e.target.files[0];
                const preview = document.getElementById('editTemplatePreview');

                if (file) {
                    preview.innerHTML = `
                        <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <svg class="w-5 h-5 text-green-600 dark:text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <p class="text-sm font-medium text-green-900 dark:text-green-100">Nouveau fichier sélectionné</p>
                                    <p class="text-xs text-green-700 dark:text-green-300">${file.name} (${(file.size / 1024).toFixed(2)} KB)</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            // Gérer l'affichage du niveau de validation dans le modal d'édition
            const editValidationRequiredCheckbox = document.getElementById('editDocValidationRequired');
            const editValidationLevelSection = document.getElementById('editDocValidationLevelSection');

            editValidationRequiredCheckbox.addEventListener('change', (e) => {
                editValidationLevelSection.style.display = e.target.checked ? 'block' : 'none';
            });

            document.getElementById('editDocTypeForm').addEventListener('submit', (e) => {
                e.preventDefault();

                const name = document.getElementById('editDocName').value;
                const validityMonths = parseInt(document.getElementById('editDocValidityMonths').value) || null;
                const autoDeleteMonths = parseInt(document.getElementById('editDocAutoDeleteMonths').value) || null;

                const requiredForRoles = [];
                document.querySelectorAll('.edit-doc-role-checkbox:checked').forEach(checkbox => {
                    requiredForRoles.push(checkbox.value);
                });

                if (requiredForRoles.length === 0) {
                    showNotification('Sélectionnez au moins un niveau à qui demander le document', 'error');
                    return;
                }

                // Récupérer les permissions granulaires
                const permissions = {
                    admin: {
                        canView: document.querySelector('.edit-perm-admin-view').checked,
                        canDownload: document.querySelector('.edit-perm-admin-download').checked,
                        canSeeDepositDate: document.querySelector('.edit-perm-admin-date').checked
                    },
                    manager: {
                        canView: document.querySelector('.edit-perm-manager-view').checked,
                        canDownload: document.querySelector('.edit-perm-manager-download').checked,
                        canSeeDepositDate: document.querySelector('.edit-perm-manager-date').checked
                    },
                    collaborateur: {
                        canView: document.querySelector('.edit-perm-collab-view').checked,
                        canDownload: document.querySelector('.edit-perm-collab-download').checked,
                        canSeeDepositDate: document.querySelector('.edit-perm-collab-date').checked
                    }
                };

                // Validation : au moins une permission doit être accordée quelque part
                const hasAnyPermission = Object.values(permissions).some(role =>
                    role.canView || role.canDownload || role.canSeeDepositDate
                );

                if (!hasAnyPermission) {
                    showNotification('Accordez au moins une permission à un rôle', 'error');
                    return;
                }

                const docIndex = settings.documentTypes.findIndex(d => d.id === docId);

                // Gérer le fichier template
                const fileInput = document.getElementById('editDocTemplate');
                const file = fileInput.files[0];

                let templateFile = doc.templateFile || null;
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        templateFile = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: event.target.result
                        };

                        saveDocumentChanges();
                    };
                    reader.readAsDataURL(file);
                } else {
                    saveDocumentChanges();
                }

                function saveDocumentChanges() {
                    // Récupérer les infos de validation
                    const validationRequired = document.getElementById('editDocValidationRequired').checked;
                    const validationLevel = document.getElementById('editDocValidationLevel').value;

                    settings.documentTypes[docIndex] = {
                        ...doc,
                        name,
                        validityMonths,
                        autoDeleteMonths,
                        requiredForRoles,
                        permissions,
                        validationRequired,
                        validationLevel,
                        templateFile
                    };

                    storage.setItem('settings', JSON.stringify(settings));
                    showNotification('Document mis à jour avec succès', 'success');
                    modal.remove();
                    appState.render();
                }
            });
        }

        function removeExistingTemplate(docId) {
            const settings = JSON.parse(storage.getItem('settings'));
            const docIndex = settings.documentTypes.findIndex(d => d.id === docId);

            if (docIndex !== -1) {
                delete settings.documentTypes[docIndex].templateFile;
                storage.setItem('settings', JSON.stringify(settings));
                document.getElementById('editTemplatePreview').innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 italic">Template supprimé</p>';
                showNotification('Template supprimé', 'success');
            }
        }

        function configureEventLeave() {
            const settings = JSON.parse(storage.getItem('settings'));
            const eventLeaveConfig = settings.eventLeaveConfig || {
                mariage: { label: 'Mariage', days: 4 },
                pacs: { label: 'PACS', days: 4 },
                naissance: { label: 'Naissance/Adoption', days: 3 },
                deces_enfant: { label: 'Décès d\'un enfant', days: 5 },
                deces_conjoint: { label: 'Décès du conjoint', days: 3 },
                deces_parent: { label: 'Décès d\'un parent', days: 3 },
                deces_frere_soeur: { label: 'Décès d\'un frère/sœur', days: 3 },
                demenagement: { label: 'Déménagement', days: 1 }
            };

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Configuration des congés pour événements familiaux</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Définissez le nombre de jours autorisés selon la convention collective</p>
                    </div>

                    <form id="eventLeaveConfigForm" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${Object.entries(eventLeaveConfig).map(([key, config]) => `
                                <div class="p-4 border border-gray-200 dark:border-gray-600 rounded-lg">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${config.label}</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="event_${key}" value="${config.days}" min="0" max="30"
                                            class="flex-1 px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                        <span class="text-sm text-gray-600 dark:text-gray-400">jour(s)</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                                <p class="text-sm text-blue-800 dark:text-blue-200">
                                    Ces valeurs seront automatiquement proposées lors de la demande de congé pour événement familial. Le salarié verra directement le nombre de jours auquel il a droit selon le type d'événement.
                                </p>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()"
                                class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                                Annuler
                            </button>
                            <button type="submit"
                                class="px-6 py-3 bg-primary hover:bg-opacity-90 text-white font-semibold rounded-lg transition-all">
                                Enregistrer la configuration
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            document.getElementById('eventLeaveConfigForm').addEventListener('submit', (e) => {
                e.preventDefault();

                const updatedConfig = {};
                Object.keys(eventLeaveConfig).forEach(key => {
                    const value = parseInt(document.getElementById(`event_${key}`).value);
                    updatedConfig[key] = {
                        label: eventLeaveConfig[key].label,
                        days: value
                    };
                });

                settings.eventLeaveConfig = updatedConfig;
                storage.setItem('settings', JSON.stringify(settings));

                showNotification('Configuration enregistrée avec succès', 'success');
                modal.remove();
            });
        }

        function deletePublicHoliday(date) {
            const settings = JSON.parse(storage.getItem('settings'));
            settings.publicHolidays = settings.publicHolidays.filter(d => d !== date);
            storage.setItem('settings', JSON.stringify(settings));
            appState.render();
        }

        function viewDocument(userId, documentId) {
            const users = JSON.parse(storage.getItem('users')) || [];
            const user = users.find(u => u.id === userId);

            if (!user) {
                showNotification('Utilisateur non trouvé', 'error');
                return;
            }

            const doc = user.documents?.find(d => d.id === documentId);

            if (!doc) {
                showNotification('Document non trouvé', 'error');
                return;
            }

            // Créer le modal de visualisation
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <!-- Header -->
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">${doc.type}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                Document de ${user.prenom} ${user.nom} • Déposé le ${new Date(doc.uploadDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}
                            </p>
                        </div>
                        <button onclick="this.closest('.fixed').remove()"
                            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Document viewer -->
                    <div class="flex-1 overflow-y-auto p-6 bg-gray-50 dark:bg-gray-900">
                        ${doc.fileData ? `
                            <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden">
                                ${doc.fileType && doc.fileType.startsWith('image/') ? `
                                    <img src="${doc.fileData}" alt="${doc.name}" class="w-full h-auto">
                                ` : doc.fileType === 'application/pdf' ? `
                                    <iframe src="${doc.fileData}" class="w-full h-[600px] border-0"></iframe>
                                ` : `
                                    <div class="p-12 text-center">
                                        <svg class="w-24 h-24 mx-auto text-gray-400 dark:text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <p class="text-lg font-semibold text-gray-900 dark:text-white mb-2">📄 ${doc.fileName || doc.name || doc.type}</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Type : ${doc.fileType || 'Non spécifié'}</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Taille : ${(doc.fileSize / 1024).toFixed(2)} Ko</p>
                                        <a href="${doc.fileData}" download="${doc.fileName || doc.name}"
                                           class="inline-block mt-4 px-6 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                                            📥 Télécharger le fichier
                                        </a>
                                    </div>
                                `}
                            </div>
                        ` : `
                            <div class="bg-white dark:bg-gray-800 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-600 p-12 text-center">
                                <svg class="w-24 h-24 mx-auto text-gray-400 dark:text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="text-lg font-semibold text-gray-900 dark:text-white mb-2">📄 ${doc.name || doc.type}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Type : ${doc.type}</p>
                                <div class="inline-block px-4 py-2 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg text-sm">
                                    📌 Document enregistré (aucun fichier uploadé)
                                </div>
                            </div>
                        `}

                        <!-- Informations complémentaires -->
                        <div class="mt-6 bg-white dark:bg-gray-800 rounded-xl p-6 space-y-4">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Informations du document</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p class="text-gray-500 dark:text-gray-400">Déposé par</p>
                                    <p class="font-medium text-gray-900 dark:text-white">${user.prenom} ${user.nom}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 dark:text-gray-400">Email</p>
                                    <p class="font-medium text-gray-900 dark:text-white">${user.email}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 dark:text-gray-400">Date de dépôt</p>
                                    <p class="font-medium text-gray-900 dark:text-white">${new Date(doc.uploadDate).toLocaleDateString('fr-FR')}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 dark:text-gray-400">Statut</p>
                                    <p class="font-medium ${doc.validationStatus === 'validated' ? 'text-green-600' : doc.validationStatus === 'rejected' ? 'text-red-600' : 'text-orange-600'}">
                                        ${doc.validationStatus === 'validated' ? '✓ Validé' : doc.validationStatus === 'rejected' ? '✗ Refusé' : '⏳ En attente'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer avec actions -->
                    <div class="p-6 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <button onclick="this.closest('.fixed').remove()"
                            class="px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors font-medium">
                            Fermer
                        </button>
                        ${doc.validationStatus === 'pending' ? `
                            <div class="flex space-x-3">
                                <button onclick="this.closest('.fixed').remove(); validateDocument(${userId}, ${documentId}, 'rejected')"
                                    class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    Refuser
                                </button>
                                <button onclick="this.closest('.fixed').remove(); validateDocument(${userId}, ${documentId}, 'validated')"
                                    class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Valider
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Fermer avec Échap
            const closeOnEscape = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', closeOnEscape);
                }
            };
            document.addEventListener('keydown', closeOnEscape);

            // Fermer en cliquant sur le fond
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    document.removeEventListener('keydown', closeOnEscape);
                }
            });
        }

        function validateDocument(userId, documentId, newStatus) {
            // Si c'est un rejet, demander un commentaire
            if (newStatus === 'rejected') {
                // Créer un modal pour le commentaire de rejet
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Motif de refus</h3>
                        </div>
                        <div class="p-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Indiquez le motif du refus (optionnel)
                            </label>
                            <textarea id="rejectionComment" rows="4"
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                                placeholder="Ex: Document illisible, informations manquantes..."></textarea>
                        </div>
                        <div class="p-6 bg-gray-50 dark:bg-gray-900 flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()"
                                class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                Annuler
                            </button>
                            <button onclick="confirmValidation(${userId}, ${documentId}, '${newStatus}', document.getElementById('rejectionComment').value); this.closest('.fixed').remove()"
                                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                Confirmer le refus
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                // Validation directe sans commentaire
                confirmValidation(userId, documentId, newStatus, null);
            }
        }

        function confirmValidation(userId, documentId, newStatus, comment) {
            const users = JSON.parse(storage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.id === userId);

            if (userIndex === -1) {
                showNotification('Utilisateur non trouvé', 'error');
                return;
            }

            const user = users[userIndex];
            const docIndex = user.documents.findIndex(d => d.id === documentId);

            if (docIndex === -1) {
                showNotification('Document non trouvé', 'error');
                return;
            }

            // Mettre à jour le document
            user.documents[docIndex].validationStatus = newStatus;
            user.documents[docIndex].validatedBy = appState.currentUser.id;
            user.documents[docIndex].validatedAt = new Date().toISOString();
            user.documents[docIndex].validationComment = comment;

            // Sauvegarder
            users[userIndex] = user;
            storage.setItem('users', JSON.stringify(users));

            // Notification
            const statusText = newStatus === 'validated' ? 'validé' : 'refusé';
            showNotification(`Document ${statusText} avec succès`, 'success');

            // Rafraîchir la vue
            appState.render();
        }

        function checkPendingDocumentsNotification() {
            const currentUser = appState.currentUser;
            if (!currentUser) return;

            const isAdmin = currentUser.roles && currentUser.roles.includes('admin');
            const isManager = currentUser.roles && currentUser.roles.includes('manager');

            if (!isAdmin && !isManager) return;

            const users = JSON.parse(storage.getItem('users')) || [];
            const settings = JSON.parse(storage.getItem('settings'));

            // Récupérer les collaborateurs sous responsabilité
            let managedUsers = [];
            if (isAdmin) {
                managedUsers = users.filter(u => u.id !== currentUser.id);
            } else if (isManager) {
                managedUsers = users.filter(u => u.managerId === currentUser.id);
            }

            // Compter les documents en attente de validation
            let pendingCount = 0;
            managedUsers.forEach(user => {
                if (user.documents && user.documents.length > 0) {
                    user.documents.forEach(doc => {
                        if (doc.validationStatus === 'pending') {
                            const documentType = settings.documentTypes.find(dt => dt.name === doc.type);
                            let canValidate = false;
                            if (documentType) {
                                if (isAdmin && documentType.validationLevel === 'admin') {
                                    canValidate = true;
                                } else if (isManager && documentType.validationLevel === 'manager') {
                                    canValidate = true;
                                }
                            }
                            if (canValidate) {
                                pendingCount++;
                            }
                        }
                    });
                }
            });

            // Afficher la notification seulement s'il y a des documents en attente
            if (pendingCount > 0) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full animate-bounce-in">
                        <div class="p-6 bg-gradient-to-r from-orange-500 to-red-500 rounded-t-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-white">Documents en attente</h3>
                                    <p class="text-white text-opacity-90 text-sm">Validation requise</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="text-center mb-6">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-orange-100 dark:bg-orange-900 rounded-full mb-4">
                                    <span class="text-4xl font-bold text-orange-600 dark:text-orange-400">${pendingCount}</span>
                                </div>
                                <p class="text-lg text-gray-700 dark:text-gray-300">
                                    ${pendingCount === 1 ? 'document nécessite' : 'documents nécessitent'} votre validation
                                </p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                                    Consultez la Gestion documentaire pour valider ou refuser les documents.
                                </p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="this.closest('.fixed').remove()"
                                    class="flex-1 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors font-medium">
                                    Plus tard
                                </button>
                                <button onclick="this.closest('.fixed').remove(); appState.setView('manager-space')"
                                    class="flex-1 px-4 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors font-medium">
                                    Voir maintenant
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function checkMissingDocumentsNotification() {
            const currentUser = appState.currentUser;
            if (!currentUser) return;

            // Cette notification est pour les collaborateurs uniquement
            const isCollaborateur = currentUser.roles && currentUser.roles.includes('collaborateur');
            if (!isCollaborateur) return;

            const settings = JSON.parse(storage.getItem('settings'));
            const userDocuments = currentUser.documents || [];

            // 1. Identifier les documents obligatoires manquants
            const requiredDocs = settings.documentTypes.filter(dt => {
                if (dt.requiredForRoles) {
                    return currentUser.roles?.some(role => dt.requiredForRoles.includes(role));
                }
                return dt.required === true;
            });

            const uploadedDocTypes = userDocuments.map(d => d.type);
            const missingDocs = requiredDocs.filter(dt => !uploadedDocTypes.includes(dt.name));

            // 2. Identifier les documents en attente ou refusés
            const pendingOrRejectedDocs = userDocuments.filter(d =>
                d.validationStatus === 'pending' || d.validationStatus === 'rejected'
            );

            // Si aucun document manquant ni en attente/refusé, ne rien afficher
            const totalIssues = missingDocs.length + pendingOrRejectedDocs.length;
            if (totalIssues === 0) return;

            // 3. Afficher la popup de rappel
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-bounce-in">
                    <!-- Header -->
                    <div class="p-6 bg-gradient-to-r from-orange-500 to-red-500 rounded-t-2xl">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">Documents incomplets</h3>
                                <p class="text-white text-opacity-90 text-sm">Action requise</p>
                            </div>
                        </div>
                    </div>

                    <!-- Body -->
                    <div class="flex-1 overflow-y-auto p-6">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-orange-100 dark:bg-orange-900 rounded-full mb-4">
                                <span class="text-4xl font-bold text-orange-600 dark:text-orange-400">${totalIssues}</span>
                            </div>
                            <p class="text-lg text-gray-700 dark:text-gray-300 mb-2">
                                ${totalIssues === 1 ? 'document nécessite' : 'documents nécessitent'} votre attention
                            </p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                Cliquez sur un document pour l'ajouter ou le mettre à jour
                            </p>
                        </div>

                        ${missingDocs.length > 0 ? `
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-900 dark:text-white mb-3 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Documents manquants (${missingDocs.length})
                                </h4>
                                <div class="space-y-2">
                                    ${missingDocs.map(docType => `
                                        <button onclick="this.closest('.fixed').remove(); uploadNewDocumentWithType('${docType.name.replace(/'/g, "\\'")}')"
                                            class="w-full text-left p-4 bg-red-50 dark:bg-red-900 dark:bg-opacity-20 border border-red-200 dark:border-red-700 rounded-lg hover:bg-red-100 dark:hover:bg-red-900 dark:hover:bg-opacity-30 transition-colors group">
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1">
                                                    <p class="font-semibold text-gray-900 dark:text-white">📄 ${docType.name}</p>
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                                        ${docType.validityMonths ? `Validité : ${docType.validityMonths} mois` : 'Validité permanente'}
                                                    </p>
                                                </div>
                                                <svg class="w-5 h-5 text-red-600 dark:text-red-400 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                </svg>
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${pendingOrRejectedDocs.length > 0 ? `
                            <div>
                                <h4 class="font-bold text-gray-900 dark:text-white mb-3 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Documents en attente ou refusés (${pendingOrRejectedDocs.length})
                                </h4>
                                <div class="space-y-2">
                                    ${pendingOrRejectedDocs.map(doc => `
                                        <button onclick="this.closest('.fixed').remove(); ${doc.validationStatus === 'rejected' ? `uploadNewDocumentWithType('${doc.type.replace(/'/g, "\\'")}')` : `appState.setView('user-profile'); setTimeout(() => showProfileTab('documents'), 300)`}"
                                            class="w-full text-left p-4 ${doc.validationStatus === 'rejected' ? 'bg-red-50 dark:bg-red-900 dark:bg-opacity-20 border-red-200 dark:border-red-700' : 'bg-orange-50 dark:bg-orange-900 dark:bg-opacity-20 border-orange-200 dark:border-orange-700'} border rounded-lg hover:bg-opacity-80 transition-colors group">
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1">
                                                    <p class="font-semibold text-gray-900 dark:text-white">📄 ${doc.name || doc.type}</p>
                                                    <div class="flex items-center space-x-2 mt-1">
                                                        <span class="text-xs px-2 py-0.5 rounded-full ${doc.validationStatus === 'rejected' ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' : 'bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200'}">
                                                            ${doc.validationStatus === 'rejected' ? '✗ Refusé' : '⏳ En attente'}
                                                        </span>
                                                        ${doc.validationComment ? `
                                                            <span class="text-xs text-gray-500 dark:text-gray-400">• ${doc.validationComment}</span>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                                <svg class="w-5 h-5 text-orange-600 dark:text-orange-400 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Footer -->
                    <div class="p-6 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex space-x-3">
                            <button onclick="this.closest('.fixed').remove()"
                                class="flex-1 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors font-medium">
                                Rappeler plus tard
                            </button>
                            <button onclick="this.closest('.fixed').remove(); appState.setView('user-profile'); setTimeout(() => showProfileTab('documents'), 300)"
                                class="flex-1 px-4 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors font-medium">
                                Voir mes documents
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function uploadNewDocumentWithType(preselectedType) {
            // Ouvrir le formulaire d'upload avec le type pré-sélectionné
            uploadNewDocument();

            // Attendre que le modal soit créé, puis sélectionner le type
            setTimeout(() => {
                const docTypeSelect = document.getElementById('docType');
                if (docTypeSelect) {
                    docTypeSelect.value = preselectedType;
                }
            }, 100);
        }

        function updatePublicHolidaysYear(year) {
            // Stocker l'année sélectionnée et rafraîchir l'affichage
            const settings = JSON.parse(storage.getItem('settings'));
            settings.selectedHolidayYear = year;
            storage.setItem('settings', JSON.stringify(settings));
            appState.render();
        }

        function loadDefaultHolidays() {
            const year = document.getElementById('yearSelector').value;
            const settings = JSON.parse(storage.getItem('settings'));

            // Jours fériés fixes en France
            const defaultHolidays = [
                `${year}-01-01`, // Jour de l'an
                `${year}-05-01`, // Fête du travail
                `${year}-05-08`, // Victoire 1945
                `${year}-07-14`, // Fête nationale
                `${year}-08-15`, // Assomption
                `${year}-11-01`, // Toussaint
                `${year}-11-11`, // Armistice 1918
                `${year}-12-25`  // Noël
            ];

            // Calcul de Pâques et jours mobiles
            const easter = calculateEaster(parseInt(year));
            const easterMonday = new Date(easter);
            easterMonday.setDate(easter.getDate() + 1);

            const ascension = new Date(easter);
            ascension.setDate(easter.getDate() + 39);

            const whitMonday = new Date(easter);
            whitMonday.setDate(easter.getDate() + 50);

            // Ajouter les jours mobiles
            defaultHolidays.push(formatDate(easterMonday)); // Lundi de Pâques
            defaultHolidays.push(formatDate(ascension));     // Jeudi de l'Ascension
            defaultHolidays.push(formatDate(whitMonday));    // Lundi de Pentecôte

            // Vérifier si des jours fériés existent déjà pour cette année
            const yearHolidaysExist = settings.publicHolidays.some(h => h.startsWith(year));

            if (yearHolidaysExist) {
                showNotification(`Les jours fériés ${year} sont déjà chargés`, 'warning');
                return;
            }

            // Ajouter uniquement les nouveaux jours fériés (garder toutes les années existantes)
            settings.publicHolidays = [...settings.publicHolidays, ...defaultHolidays].sort();
            storage.setItem('settings', JSON.stringify(settings));

            showNotification(`Jours fériés ${year} chargés avec succès`, 'success');
            appState.render();
        }

        function calculateEaster(year) {
            // Algorithme de Meeus/Jones/Butcher pour calculer Pâques
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31);
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(year, month - 1, day);
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateUserLeaveBalance(userId, newBalance, type) {
            const users = JSON.parse(storage.getItem('users'));
            const user = users.find(u => u.id === userId);
            if (user) {
                if (type === 'conges') {
                    user.soldeConges = parseInt(newBalance);
                } else if (type === 'rtt') {
                    user.soldeRTT = parseInt(newBalance);
                }
                storage.setItem('users', JSON.stringify(users));
            }
        }

        function toggleUserRTT(userId, hasRTT) {
            const users = JSON.parse(storage.getItem('users'));
            const user = users.find(u => u.id === userId);
            if (user) {
                user.hasRTT = hasRTT;
                if (!hasRTT) {
                    user.soldeRTT = 0;
                }
                storage.setItem('users', JSON.stringify(users));

                showNotification(hasRTT ? 'RTT activés pour cet utilisateur' : 'RTT désactivés pour cet utilisateur', 'success');
                appState.render();
            }
        }

        function resetUserPassword(userId) {
            const users = JSON.parse(storage.getItem('users'));
            const user = users.find(u => u.id === userId);
            if (user) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Réinitialiser le mot de passe</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            Le mot de passe de ${user.prenom} ${user.nom} sera réinitialisé à "user123"
                        </p>
                        <div class="flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()"
                                class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all">
                                Annuler
                            </button>
                            <button onclick="confirmPasswordReset(${userId}); this.closest('.fixed').remove()"
                                class="px-4 py-2 bg-primary hover:bg-opacity-90 text-white rounded-lg transition-all">
                                Confirmer
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function confirmPasswordReset(userId) {
            const users = JSON.parse(storage.getItem('users'));
            const user = users.find(u => u.id === userId);
            if (user) {
                user.password = 'user123';
                storage.setItem('users', JSON.stringify(users));

                const successModal = document.createElement('div');
                successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                successModal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Mot de passe réinitialisé</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-4">Le nouveau mot de passe est : user123</p>
                            <button onclick="this.closest('.fixed').remove()"
                                class="px-4 py-2 bg-primary hover:bg-opacity-90 text-white rounded-lg transition-all">
                                OK
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(successModal);
            }
        }

        function updateReferencePeriod(value) {
            const settings = JSON.parse(storage.getItem('settings'));
            settings.referencePeriod = value;
            storage.setItem('settings', JSON.stringify(settings));
            appState.render();
        }

        function updateUserRole(userId, role) {
            const users = JSON.parse(storage.getItem('users'));
            const user = users.find(u => u.id === userId);
            if (user) {
                user.role = role;
                storage.setItem('users', JSON.stringify(users));

                // Afficher une notification de succès
                const modal = document.createElement('div');
                modal.className = 'fixed top-4 right-4 z-50';
                modal.innerHTML = `
                    <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Rôle mis à jour avec succès</span>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => modal.remove(), 2000);
            }
        }

        function updateUserEntryDate(userId, date) {
            const users = JSON.parse(storage.getItem('users'));
            const user = users.find(u => u.id === userId);
            if (user) {
                user.dateEntree = date;
                storage.setItem('users', JSON.stringify(users));

                // Recalculer le solde de congés basé sur la date d'entrée
                const settings = JSON.parse(storage.getItem('settings'));
                const leaveInfo = calculateAcquiredLeave(date, settings.referencePeriod, settings.acquisitionPerMonth);
                if (leaveInfo.isFirstYear) {
                    user.soldeConges = leaveInfo.acquired;
                }
                storage.setItem('users', JSON.stringify(users));

                // Afficher une notification de succès
                const modal = document.createElement('div');
                modal.className = 'fixed top-4 right-4 z-50';
                modal.innerHTML = `
                    <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Date d'entrée mise à jour</span>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => modal.remove(), 2000);

                // Rafraîchir l'affichage
                appState.render();
            }
        }

        function filterHistory(status) {
            // Mettre à jour les boutons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });
            document.getElementById(`filter-${status}`).classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            document.getElementById(`filter-${status}`).classList.add('bg-primary', 'text-white');

            // Filtrer les demandes
            const allRequests = document.querySelectorAll('.request-item');
            allRequests.forEach(item => {
                if (status === 'all' || item.dataset.status === status) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Fonctions pour la gestion des onglets du profil
        function showProfileTab(tabName) {
            // Cacher tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Réinitialiser tous les boutons d'onglets
            document.querySelectorAll('.profile-tab').forEach(btn => {
                btn.classList.remove('border-primary', 'text-primary');
                btn.classList.add('border-transparent', 'text-gray-600', 'dark:text-gray-400');
            });

            // Afficher l'onglet sélectionné - avec vérification que l'élément existe
            const tabContent = document.getElementById(`tab-content-${tabName}`);
            const tabButton = document.getElementById(`tab-${tabName}`);

            if (tabContent && tabButton) {
                tabContent.classList.remove('hidden');
                tabButton.classList.remove('border-transparent', 'text-gray-600', 'dark:text-gray-400');
                tabButton.classList.add('border-primary', 'text-primary');
            }
        }

        // Fonction pour uploader un nouveau document
        function uploadNewDocument() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Ajouter un document</h3>
                    <form id="uploadDocForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type de document *</label>
                            <select id="docType" required
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                <option value="">-- Sélectionnez --</option>
                                <option value="Carte d'identité">Carte d'identité</option>
                                <option value="Carte vitale">Carte vitale</option>
                                <option value="RIB">RIB</option>
                                <option value="Attestation d'assurance">Attestation d'assurance</option>
                                <option value="Justificatif de domicile">Justificatif de domicile</option>
                                <option value="Diplôme">Diplôme</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom du fichier *</label>
                            <input type="text" id="docName" required
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                                placeholder="Ex: Carte d'identité 2024">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fichier *</label>
                            <div class="relative">
                                <input type="file" id="docFile" required
                                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif"
                                    class="w-full px-4 py-3 text-base rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-opacity-90 cursor-pointer">
                            </div>
                            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                                Formats acceptés: PDF, Word, Images (JPG, PNG, GIF). Taille max: 10 Mo
                            </p>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()"
                                class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all">
                                Annuler
                            </button>
                            <button type="submit"
                                class="px-4 py-2 bg-primary hover:bg-opacity-90 text-white rounded-lg transition-all">
                                Ajouter
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('uploadDocForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const docType = document.getElementById('docType').value;
                const docName = document.getElementById('docName').value;
                const fileInput = document.getElementById('docFile');
                const file = fileInput.files[0];

                if (!file) {
                    showNotification('Veuillez sélectionner un fichier', 'error');
                    return;
                }

                // Vérifier la taille du fichier (10 Mo max)
                const maxSize = 10 * 1024 * 1024; // 10 Mo en bytes
                if (file.size > maxSize) {
                    showNotification('Le fichier est trop volumineux (max 10 Mo)', 'error');
                    return;
                }

                // Convertir le fichier en base64
                const reader = new FileReader();
                reader.onload = function(event) {
                    const users = JSON.parse(storage.getItem('users'));
                    const user = users.find(u => u.id === appState.currentUser.id);

                    if (user) {
                        if (!user.documents) user.documents = [];

                        // Récupérer les infos du type de document pour déterminer le statut
                        const settings = JSON.parse(storage.getItem('settings'));
                        const documentType = settings.documentTypes.find(dt => dt.name === docType);

                        // Si le document ne nécessite pas de validation, il est automatiquement validé
                        const initialStatus = documentType && documentType.validationRequired === false ? 'validated' : 'pending';

                        const newDoc = {
                            id: Date.now(),
                            name: docName,
                            fileName: file.name,
                            fileType: file.type,
                            fileSize: file.size,
                            fileData: event.target.result, // Base64 data
                            type: docType,
                            uploadDate: new Date().toISOString(),
                            validationStatus: initialStatus,
                            validatedBy: initialStatus === 'validated' ? 'auto' : null,
                            validatedAt: initialStatus === 'validated' ? new Date().toISOString() : null,
                            validationComment: null,
                            status: 'pending' // Garde l'ancien champ pour compatibilité
                        };

                        user.documents.push(newDoc);
                        storage.setItem('users', JSON.stringify(users));

                        // Mettre à jour appState.currentUser
                        appState.currentUser = user;
                        storage.setItem('currentUser', JSON.stringify(user));

                        showNotification('Document ajouté avec succès', 'success');
                        modal.remove();
                        appState.render();
                    }
                };
                reader.onerror = function() {
                    showNotification('Erreur lors de la lecture du fichier', 'error');
                };
                reader.readAsDataURL(file);
            });
        }

        // Fonction pour upload en réponse à une demande
        function uploadDocumentForRequest(requestId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Déposer le document demandé</h3>
                    <form id="uploadReqDocForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom du fichier *</label>
                            <input type="text" id="reqDocName" required
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                                placeholder="Nom du document">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fichier *</label>
                            <div class="relative">
                                <input type="file" id="reqDocFile" required
                                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif"
                                    class="w-full px-4 py-3 text-base rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-opacity-90 cursor-pointer">
                            </div>
                            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                                Formats acceptés: PDF, Word, Images (JPG, PNG, GIF). Taille max: 10 Mo
                            </p>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()"
                                class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all">
                                Annuler
                            </button>
                            <button type="submit"
                                class="px-4 py-2 bg-primary hover:bg-opacity-90 text-white rounded-lg transition-all">
                                Déposer
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('uploadReqDocForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const docName = document.getElementById('reqDocName').value;
                const fileInput = document.getElementById('reqDocFile');
                const file = fileInput.files[0];

                if (!file) {
                    showNotification('Veuillez sélectionner un fichier', 'error');
                    return;
                }

                // Vérifier la taille du fichier (10 Mo max)
                const maxSize = 10 * 1024 * 1024; // 10 Mo en bytes
                if (file.size > maxSize) {
                    showNotification('Le fichier est trop volumineux (max 10 Mo)', 'error');
                    return;
                }

                // Convertir le fichier en base64
                const reader = new FileReader();
                reader.onload = function(event) {
                    const users = JSON.parse(storage.getItem('users'));
                    const user = users.find(u => u.id === appState.currentUser.id);

                    if (user) {
                        const request = user.documentRequests.find(r => r.id === requestId);
                        if (request) {
                            if (!user.documents) user.documents = [];

                            // Récupérer les infos du type de document pour déterminer le statut
                            const settings = JSON.parse(storage.getItem('settings'));
                            const documentType = settings.documentTypes.find(dt => dt.name === request.documentType);

                            // Si le document ne nécessite pas de validation, il est automatiquement validé
                            const initialStatus = documentType && documentType.validationRequired === false ? 'validated' : 'pending';

                            const newDoc = {
                                id: Date.now(),
                                name: docName,
                                fileName: file.name,
                                fileType: file.type,
                                fileSize: file.size,
                                fileData: event.target.result, // Base64 data
                                type: request.documentType,
                                uploadDate: new Date().toISOString(),
                                validationStatus: initialStatus,
                                validatedBy: initialStatus === 'validated' ? 'auto' : null,
                                validatedAt: initialStatus === 'validated' ? new Date().toISOString() : null,
                                validationComment: null,
                                status: 'pending',
                                requestId: requestId
                            };

                            user.documents.push(newDoc);
                            request.status = 'submitted';
                            request.submittedDate = new Date().toISOString();

                            storage.setItem('users', JSON.stringify(users));

                            // Mettre à jour appState.currentUser
                            appState.currentUser = user;
                            storage.setItem('currentUser', JSON.stringify(user));

                            showNotification('Document déposé avec succès', 'success');
                            modal.remove();
                            appState.render();
                        }
                    }
                };
                reader.onerror = function() {
                    showNotification('Erreur lors de la lecture du fichier', 'error');
                };
                reader.readAsDataURL(file);
            });
        }

        // Fonction pour demander un document à un utilisateur
        function requestDocumentFromUser(userId) {
            const settings = JSON.parse(storage.getItem('settings'));
            const users = JSON.parse(storage.getItem('users'));
            const user = users.find(u => u.id === userId);

            if (!user) {
                showNotification('Utilisateur non trouvé', 'error');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Demander un document à ${user.prenom} ${user.nom}</h3>
                    <form id="requestDocForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type de document <span class="text-red-500">*</span></label>
                            <select id="reqDocType" required
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                <option value="">Sélectionner un type de document...</option>
                                ${settings.documentTypes.map(dt => `
                                    <option value="${dt.name}">${dt.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description / Message (optionnel)</label>
                            <textarea id="reqDocDescription" rows="3"
                                class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                                placeholder="Ajoutez des instructions ou des précisions sur ce document..."></textarea>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20 border border-blue-200 dark:border-blue-700 rounded-lg p-3">
                            <p class="text-xs text-blue-800 dark:text-blue-300">
                                💡 <strong>Info :</strong> Une notification sera envoyée à ${user.prenom} ${user.nom} pour l'informer de votre demande. Le document apparaîtra dans son onglet "Documents" avec un bouton "Déposer".
                            </p>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()"
                                class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all">
                                Annuler
                            </button>
                            <button type="submit"
                                class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-all">
                                Envoyer la demande
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('requestDocForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const docType = document.getElementById('reqDocType').value;
                const description = document.getElementById('reqDocDescription').value;

                if (!docType) {
                    showNotification('Veuillez sélectionner un type de document', 'error');
                    return;
                }

                // Créer la demande de document
                if (!user.documentRequests) user.documentRequests = [];

                const newRequest = {
                    id: Date.now(),
                    documentType: docType,
                    description: description,
                    requestDate: new Date().toISOString(),
                    requestedBy: appState.currentUser.id,
                    requestedByName: `${appState.currentUser.prenom} ${appState.currentUser.nom}`,
                    status: 'pending'
                };

                user.documentRequests.push(newRequest);

                // Sauvegarder
                const userIndex = users.findIndex(u => u.id === userId);
                users[userIndex] = user;
                storage.setItem('users', JSON.stringify(users));

                showNotification(`Demande envoyée à ${user.prenom} ${user.nom}`, 'success');
                modal.remove();
                appState.render();
            });
        }

        // Fonction pour supprimer un document
        function deleteDocument(docId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Confirmer la suppression</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        Êtes-vous sûr de vouloir supprimer ce document ? Cette action est irréversible.
                    </p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()"
                            class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all">
                            Annuler
                        </button>
                        <button onclick="confirmDeleteDocument(${docId}); this.closest('.fixed').remove()"
                            class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">
                            Supprimer
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmDeleteDocument(docId) {
            const users = JSON.parse(storage.getItem('users'));
            const user = users.find(u => u.id === appState.currentUser.id);

            if (user && user.documents) {
                user.documents = user.documents.filter(d => d.id !== docId);
                storage.setItem('users', JSON.stringify(users));

                // Mettre à jour appState.currentUser
                appState.currentUser = user;
                storage.setItem('currentUser', JSON.stringify(user));

                appState.render();
            }
        }

        // Fonction pour mettre à jour la photo de profil
        function updateProfilePhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const users = JSON.parse(storage.getItem('users'));
                        const user = users.find(u => u.id === appState.currentUser.id);

                        if (user) {
                            user.photo = event.target.result;
                            storage.setItem('users', JSON.stringify(users));

                            appState.currentUser.photo = event.target.result;
                            storage.setItem('currentUser', JSON.stringify(appState.currentUser));

                            showNotification('Photo de profil mise à jour', 'success');
                            appState.render();
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // OPTIMISATION: Fonction de filtrage des documents dans la Gestion documentaire
        function filterDocuments() {
            const searchTerm = document.getElementById('searchDocuments')?.value.toLowerCase() || '';
            const filterType = document.getElementById('filterDocType')?.value.toLowerCase() || '';
            const documents = document.querySelectorAll('.document-item');

            let visibleCount = 0;

            documents.forEach(doc => {
                const userName = doc.dataset.userName || '';
                const docType = doc.dataset.docType || '';
                const status = doc.dataset.status || '';

                // Vérifier si le document correspond aux critères de recherche
                const matchesSearch = !searchTerm ||
                    userName.includes(searchTerm) ||
                    docType.includes(searchTerm);

                // Vérifier si le document correspond au filtre de type
                const matchesType = !filterType || docType === filterType;

                // Afficher ou masquer le document
                if (matchesSearch && matchesType) {
                    doc.style.display = 'block';
                    visibleCount++;
                } else {
                    doc.style.display = 'none';
                }
            });

            // Afficher un message si aucun résultat
            const documentsList = document.getElementById('documentsList');
            let noResultsMsg = document.getElementById('noResultsMessage');

            if (visibleCount === 0 && documentsList) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.id = 'noResultsMessage';
                    noResultsMsg.className = 'text-center py-8 text-gray-500 dark:text-gray-400';
                    noResultsMsg.innerHTML = `
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-lg font-medium">Aucun document trouvé</p>
                        <p class="text-sm mt-2">Essayez de modifier vos critères de recherche</p>
                    `;
                    documentsList.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }

        // OPTIMISATION: Fonction de filtrage par statut (clic sur les cartes de statistiques)
        function filterDocumentsByStatus(status) {
            // Réinitialiser les filtres de recherche et de type
            const searchInput = document.getElementById('searchDocuments');
            const typeFilter = document.getElementById('filterDocType');

            if (searchInput) searchInput.value = '';
            if (typeFilter) typeFilter.value = '';

            // Filtrer les documents par statut
            const documents = document.querySelectorAll('.document-item');
            let visibleCount = 0;

            documents.forEach(doc => {
                const docStatus = doc.dataset.status || '';

                if (docStatus === status) {
                    doc.style.display = 'block';
                    visibleCount++;
                } else {
                    doc.style.display = 'none';
                }
            });

            // Afficher un message si aucun résultat
            const documentsList = document.getElementById('documentsList');
            let noResultsMsg = document.getElementById('noResultsMessage');

            if (visibleCount === 0 && documentsList) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.id = 'noResultsMessage';
                    noResultsMsg.className = 'text-center py-8 text-gray-500 dark:text-gray-400';
                    documentsList.appendChild(noResultsMsg);
                }

                let statusText = '';
                switch(status) {
                    case 'pending':
                        statusText = 'en attente';
                        break;
                    case 'validated':
                        statusText = 'validés';
                        break;
                    case 'rejected':
                        statusText = 'rejetés';
                        break;
                }

                noResultsMsg.innerHTML = `
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p class="text-lg font-medium">Aucun document ${statusText}</p>
                `;
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }

            // Faire défiler jusqu'à la liste des documents
            const documentsSection = document.querySelector('#documentsList');
            if (documentsSection) {
                documentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Gestionnaire pour le formulaire de mise à jour du profil
        document.addEventListener('submit', (e) => {
            if (e.target.id === 'updateProfileForm') {
                e.preventDefault();
                const prenom = document.getElementById('updatePrenom').value;
                const nom = document.getElementById('updateNom').value;
                const phone = document.getElementById('updatePhone').value;
                const address = document.getElementById('updateAddress').value;
                const postalCode = document.getElementById('updatePostalCode').value;
                const city = document.getElementById('updateCity').value;

                const users = JSON.parse(storage.getItem('users'));
                const user = users.find(u => u.id === appState.currentUser.id);

                if (user) {
                    user.prenom = prenom;
                    user.nom = nom;
                    user.phone = phone;
                    user.address = address;
                    user.postalCode = postalCode;
                    user.city = city;
                    // Les champs poste, structure et typeContrat ne sont pas modifiés ici
                    // Ils sont gérés uniquement par l'admin dans la gestion des collaborateurs

                    storage.setItem('users', JSON.stringify(users));

                    // Mettre à jour appState.currentUser
                    appState.currentUser = user;
                    storage.setItem('currentUser', JSON.stringify(user));

                    // Afficher une notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 z-50 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
                    notification.textContent = 'Profil mis à jour avec succès !';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);

                    appState.render();
                }
            }

            // Formulaire d'ajout de récupération
            if (e.target.id === 'addRecoveryForm') {
                e.preventDefault();
                const hours = parseFloat(document.getElementById('recoveryHours').value);

                const users = JSON.parse(storage.getItem('users'));
                const user = users.find(u => u.id === appState.currentUser.id);

                if (user) {
                    if (!user.recoveryHours) user.recoveryHours = [];

                    const currentDate = new Date();
                    const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;

                    // Vérifier si une entrée existe déjà pour ce mois
                    const existingEntry = user.recoveryHours.find(r => r.month === monthKey);

                    if (existingEntry) {
                        existingEntry.hours = hours;
                        existingEntry.recordDate = new Date().toISOString();
                    } else {
                        user.recoveryHours.push({
                            month: monthKey,
                            hours: hours,
                            recordDate: new Date().toISOString(),
                            validated: false
                        });
                    }

                    storage.setItem('users', JSON.stringify(users));

                    // Mettre à jour appState.currentUser
                    appState.currentUser = user;
                    storage.setItem('currentUser', JSON.stringify(user));

                    // Afficher une notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 z-50 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
                    notification.textContent = 'Récupération enregistrée !';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);

                    appState.render();
                }
            }
        });

        // Rendu initial
        appState.render();
    </script>
</body>
</html>
