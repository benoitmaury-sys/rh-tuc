<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RH TUC - Gestion RH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <script src="config.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .transition-all {
            transition: all 0.3s ease;
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 260px;
            background: white;
            border-right: 1px solid #e5e7eb;
            z-index: 40;
            transition: transform 0.3s ease;
        }

        .dark .sidebar {
            background: #1f2937;
            border-right-color: #374151;
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 30;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Mobile: sidebar hidden by default */
        @media (max-width: 767px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
        }

        /* Desktop: sidebar always visible */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0) !important;
            }
            .sidebar-overlay {
                display: none !important;
            }
        }

        .main-content {
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }

        @media (min-width: 768px) {
            .main-content {
                margin-left: 260px;
            }
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: #f3f4f6;
            color: #111827;
        }

        .dark .nav-item:hover {
            background: #374151;
            color: #f9fafb;
        }

        .nav-item.active {
            background: #5D5CDE;
            color: white;
        }

        .nav-item.active:hover {
            background: #4a49c5;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5D5CDE;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div id="app"></div>

    <script>
        // ============================================
        // MODULE API CLIENT - Communication avec Railway
        // ============================================

        // Stockage en m√©moire pour le token (pas de localStorage/sessionStorage dans iframe)
        const memoryStorage = {
            authToken: null
        };

        const ApiClient = {
            baseURL: API_CONFIG.baseURL,
            token: memoryStorage.authToken || null,

            setToken(token) {
                this.token = token;
                if (token) {
                    memoryStorage.authToken = token;
                } else {
                    memoryStorage.authToken = null;
                }
            },

            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (this.token) {
                    headers['Authorization'] = `Bearer ${this.token}`;
                }

                const config = {
                    ...options,
                    headers
                };

                try {
                    const response = await fetch(url, config);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || data.message || 'Erreur r√©seau');
                    }

                    return data;
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            },

            // Auth endpoints
            async login(email, password) {
                const data = await this.request('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                if (data.token) {
                    this.setToken(data.token);
                }

                return data;
            },

            async register(userData) {
                const data = await this.request('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });

                if (data.token) {
                    this.setToken(data.token);
                }

                return data;
            },

            async getCurrentUser() {
                return await this.request('/auth/me');
            },

            // Users endpoints
            async getUsers() {
                return await this.request('/users');
            },

            async getUser(id) {
                return await this.request(`/users/${id}`);
            },

            async updateUser(id, userData) {
                return await this.request(`/users/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(userData)
                });
            },

            async deleteUser(id) {
                return await this.request(`/users/${id}`, {
                    method: 'DELETE'
                });
            }
        };

        // ============================================
        // SYST√àME DE STOCKAGE HYBRIDE
        // ============================================

        // Stockage en m√©moire uniquement (pas de localStorage dans iframe)
        const storage = {
            data: {},

            getItem(key) {
                return this.data[key] || null;
            },

            setItem(key, value) {
                this.data[key] = value;
            },

            removeItem(key) {
                delete this.data[key];
            }
        };

        // Initialisation du mode sombre
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // ============================================
        // FONCTIONS UTILITAIRES (Jours f√©ri√©s, calculs)
        // ============================================

        function getFrenchPublicHolidays(year) {
            const holidays = [];
            holidays.push(`${year}-01-01`);
            holidays.push(`${year}-05-01`);
            holidays.push(`${year}-05-08`);
            holidays.push(`${year}-07-14`);
            holidays.push(`${year}-08-15`);
            holidays.push(`${year}-11-01`);
            holidays.push(`${year}-11-11`);
            holidays.push(`${year}-12-25`);

            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31);
            const day = ((h + l - 7 * m + 114) % 31) + 1;

            const easter = new Date(year, month - 1, day);
            const easterMonday = new Date(easter);
            easterMonday.setDate(easter.getDate() + 1);
            holidays.push(easterMonday.toISOString().split('T')[0]);

            const ascension = new Date(easter);
            ascension.setDate(easter.getDate() + 39);
            holidays.push(ascension.toISOString().split('T')[0]);

            const pentecostMonday = new Date(easter);
            pentecostMonday.setDate(easter.getDate() + 50);
            holidays.push(pentecostMonday.toISOString().split('T')[0]);

            return holidays.sort();
        }

        function calculateWorkingDays(startDate, endDate, duration = 'full') {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let workingDays = 0;
            const startYear = start.getFullYear();
            const endYear = end.getFullYear();
            let publicHolidays = [];

            for (let year = startYear; year <= endYear; year++) {
                publicHolidays = publicHolidays.concat(getFrenchPublicHolidays(year));
            }

            const currentDate = new Date(start);
            // eslint-disable-next-line no-unmodified-loop-condition
            while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay();
                const dateStr = currentDate.toISOString().split('T')[0];
                if (dayOfWeek !== 0 && dayOfWeek !== 6 && !publicHolidays.includes(dateStr)) {
                    workingDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (duration === 'morning' || duration === 'afternoon') {
                workingDays = workingDays * 0.5;
            }

            return workingDays;
        }

        function calculateBusinessDays(startDate, endDate, duration = 'full') {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let businessDays = 0;
            const startYear = start.getFullYear();
            const endYear = end.getFullYear();
            let publicHolidays = [];

            for (let year = startYear; year <= endYear; year++) {
                publicHolidays = publicHolidays.concat(getFrenchPublicHolidays(year));
            }

            const currentDate = new Date(start);
            // eslint-disable-next-line no-unmodified-loop-condition
            while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay();
                const dateStr = currentDate.toISOString().split('T')[0];
                if (dayOfWeek !== 0 && !publicHolidays.includes(dateStr)) {
                    businessDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (duration === 'morning' || duration === 'afternoon') {
                businessDays = businessDays * 0.5;
            }

            return businessDays;
        }

        function calculateAcquiredLeave(dateEntree, referencePeriod = 'september-august', acquisitionPerMonth = 2.5) {
            if (!dateEntree) return { acquired: 30, acquiredN1: 0, acquiredN: 30, total: 30, isFirstYear: false };

            const entryDate = new Date(dateEntree);
            const today = new Date();
            const currentYear = today.getFullYear();
            const refYear = today.getMonth() >= 8 ? currentYear : currentYear - 1;
            const periodNStart = new Date(refYear, 8, 1);
            const periodNEnd = new Date(refYear + 1, 7, 31);
            const periodN1End = new Date(refYear, 7, 31);

            let acquiredN1 = 0;
            if (entryDate <= periodN1End) {
                const endDateN1 = today < periodN1End ? today : periodN1End;
                const monthsWorkedN1 = Math.max(0, (endDateN1 - entryDate) / (1000 * 60 * 60 * 24 * 30.44));
                acquiredN1 = Math.min(30, Math.round(monthsWorkedN1 * acquisitionPerMonth * 100) / 100);
            }

            let acquiredN = 0;
            if (today >= periodNStart) {
                const startDate = entryDate > periodNStart ? entryDate : periodNStart;
                const endDate = today < periodNEnd ? today : periodNEnd;
                const monthsWorkedN = Math.max(0, (endDate - startDate) / (1000 * 60 * 60 * 24 * 30.44));
                acquiredN = Math.min(30, Math.round(monthsWorkedN * acquisitionPerMonth * 100) / 100);
            }

            const isFirstYear = entryDate >= periodNStart;

            return {
                acquired: acquiredN1 + acquiredN,
                acquiredN1,
                acquiredN,
                total: 30,
                isFirstYear,
                monthsWorked: Math.floor((today - entryDate) / (1000 * 60 * 60 * 24 * 30.44))
            };
        }

        // ============================================
        // GESTION DE L'√âTAT DE L'APPLICATION
        // ============================================

        class AppState {
            constructor() {
                this.currentUser = null;
                this.currentView = 'login';
                this.viewMode = null;
                this.isLoading = false;
                this.init();
            }

            async init() {
                // Initialiser les settings par d√©faut
                this.initializeDefaultSettings();

                // V√©rifier si un token existe
                const token = ApiClient.token;
                if (token) {
                    try {
                        this.showLoading();
                        const userData = await ApiClient.getCurrentUser();
                        this.currentUser = this.convertBackendUserToFrontend(userData);
                        storage.setItem('currentUser', JSON.stringify(this.currentUser));
                        this.viewMode = this.currentUser.role;
                        this.currentView = this.currentUser.role === 'admin' ? 'admin-dashboard' : 'user-dashboard';

                        // Charger les utilisateurs depuis l'API
                        await this.syncUsersFromAPI();
                    } catch (error) {
                        console.error('Error loading user:', error);
                        ApiClient.setToken(null);
                        this.currentUser = null;
                        this.currentView = 'login';
                    } finally {
                        this.hideLoading();
                    }
                }

                this.render();
            }

            initializeDefaultSettings() {
                if (!storage.getItem('leaveRequests')) {
                    storage.setItem('leaveRequests', JSON.stringify([]));
                }

                if (!storage.getItem('settings')) {
                    const defaultSettings = {
                        leaveTypes: [
                            { id: 1, name: 'Cong√©s pay√©s', color: '#5D5CDE', category: 'regular', requiresDocument: false, isConventionCollective: false },
                            { id: 2, name: 'RTT', color: '#10B981', category: 'regular', requiresDocument: false, isConventionCollective: false },
                            { id: 3, name: 'Cong√© Maladie', color: '#EF4444', category: 'special', requiresDocument: true, isConventionCollective: false },
                            { id: 4, name: 'Cong√© Sans Solde', color: '#F59E0B', category: 'special', requiresDocument: false, isConventionCollective: false },
                            { id: 5, name: 'Cong√© Maternit√©/Paternit√©', color: '#EC4899', category: 'special', requiresDocument: true, isConventionCollective: false },
                            { id: 6, name: 'Cong√©s pour √©v√©nement familial', color: '#8B5CF6', category: 'special', requiresDocument: true, isConventionCollective: true }
                        ],
                        eventLeaveConfig: {
                            mariage: { label: 'Mariage', days: 4 },
                            pacs: { label: 'PACS', days: 4 },
                            naissance: { label: 'Naissance/Adoption', days: 3 },
                            deces_enfant: { label: 'D√©c√®s d\'un enfant', days: 5 },
                            deces_conjoint: { label: 'D√©c√®s du conjoint', days: 3 },
                            deces_parent: { label: 'D√©c√®s d\'un parent', days: 3 },
                            deces_frere_soeur: { label: 'D√©c√®s d\'un fr√®re/s≈ìur', days: 3 },
                            demenagement: { label: 'D√©m√©nagement', days: 1 }
                        },
                        publicHolidays: ['2024-01-01', '2024-05-01', '2024-05-08', '2024-07-14', '2024-08-15', '2024-11-01', '2024-11-11', '2024-12-25'],
                        annualLeaveDays: 30,
                        referencePeriod: 'september-august',
                        acquisitionPerMonth: 2.5,
                        extraHolidays: [],
                        doubleValidation: false,
                        documentTypes: [
                            { id: 1, name: 'Carte d\'identit√©', validityMonths: 120, required: true },
                            { id: 2, name: 'Carte vitale', validityMonths: 12, required: true },
                            { id: 3, name: 'RIB', validityMonths: null, required: true },
                            { id: 4, name: 'Attestation d\'assurance', validityMonths: 12, required: true },
                            { id: 5, name: 'Justificatif de domicile', validityMonths: 3, required: true },
                            { id: 6, name: 'Dipl√¥me', validityMonths: null, required: true }
                        ],
                        contractConfigs: {
                            permanent_tuc: {
                                label: 'Permanent TUC',
                                hasLeave: true,
                                hasRTT: true,
                                hasRecovery: false,
                                requiredDocuments: [1, 2, 3, 4, 5, 6]
                            },
                            permanent_tuc_vacances: {
                                label: 'Permanent TUC VACANCES',
                                hasLeave: false,
                                hasRTT: false,
                                hasRecovery: true,
                                requiredDocuments: [1, 2, 3, 4, 5, 6]
                            }
                        },
                        reminders: {
                            email: true,
                            app: true
                        },
                        rttReminders: {
                            enabled: true,
                            startMonth: 9,
                            endMonth: 12,
                            frequency: 'monthly'
                        }
                    };
                    storage.setItem('settings', JSON.stringify(defaultSettings));
                }
            }

            // Convertir utilisateur backend en format frontend
            convertBackendUserToFrontend(backendUser) {
                return {
                    id: backendUser.id,
                    email: backendUser.email,
                    nom: backendUser.lastName,
                    prenom: backendUser.firstName,
                    role: backendUser.roles && backendUser.roles[0] ? backendUser.roles[0] : 'collaborateur',
                    roles: backendUser.roles || ['collaborateur'],
                    phone: backendUser.phone || '',
                    address: backendUser.address || '',
                    poste: backendUser.position || '',
                    department: backendUser.department || '',
                    managerId: backendUser.managerId || null,
                    contractType: 'permanent_tuc',
                    dateEntree: backendUser.joinDate ? backendUser.joinDate.split('T')[0] : null,
                    soldeConges: backendUser.remainingLeave || 25,
                    soldeRTT: 0,
                    hasRTT: false,
                    documents: [],
                    documentRequests: [],
                    showEmail: true,
                    showPhone: true,
                    teams: []
                };
            }

            // Synchroniser les utilisateurs depuis l'API
            async syncUsersFromAPI() {
                try {
                    const backendUsers = await ApiClient.getUsers();
                    const frontendUsers = backendUsers.map(u => this.convertBackendUserToFrontend(u));
                    storage.setItem('users', JSON.stringify(frontendUsers));
                    return frontendUsers;
                } catch (error) {
                    console.error('Error syncing users:', error);
                    // En cas d'erreur, utiliser les donn√©es en cache
                    return JSON.parse(storage.getItem('users') || '[]');
                }
            }

            async login(email, password) {
                try {
                    this.showLoading();
                    const data = await ApiClient.login(email, password);

                    this.currentUser = this.convertBackendUserToFrontend(data.user);
                    storage.setItem('currentUser', JSON.stringify(this.currentUser));
                    this.viewMode = this.currentUser.role;
                    this.currentView = this.currentUser.role === 'admin' ? 'admin-dashboard' : 'user-dashboard';

                    // Charger les utilisateurs depuis l'API
                    await this.syncUsersFromAPI();

                    return true;
                } catch (error) {
                    console.error('Login error:', error);
                    return false;
                } finally {
                    this.hideLoading();
                }
            }

            logout() {
                this.currentUser = null;
                this.viewMode = null;
                ApiClient.setToken(null);
                storage.removeItem('currentUser');
                this.currentView = 'login';
                this.render();
            }

            switchViewMode(mode) {
                if (this.currentUser && this.currentUser.role === 'admin') {
                    this.viewMode = mode;
                    this.currentView = mode === 'admin' ? 'admin-dashboard' : 'user-dashboard';
                    this.render();
                }
            }

            setView(view) {
                this.currentView = view;
                this.render();
            }

            toggleSidebar() {
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            }

            showLoading() {
                this.isLoading = true;
            }

            hideLoading() {
                this.isLoading = false;
            }

            renderSidebar() {
                if (!this.currentUser) return '';

                const roles = this.currentUser.roles || [];
                const isAdmin = roles.includes('admin');
                const isManager = roles.includes('manager');

                const navItems = [
                    {
                        id: 'dashboard',
                        label: 'Tableau de bord',
                        icon: `<svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>`,
                        view: isAdmin ? 'admin-dashboard' : 'user-dashboard',
                        show: true
                    },
                    {
                        id: 'leave-management',
                        label: 'Gestion des cong√©s',
                        icon: `<svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>`,
                        view: 'user-dashboard',
                        show: true
                    }
                ];

                return `
                    <div class="sidebar-overlay" onclick="appState.toggleSidebar()"></div>
                    <aside class="sidebar">
                        <div class="flex flex-col h-full">
                            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <svg class="w-16 h-16" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="50" cy="50" r="45" fill="#5D5CDE"/>
                                            <text x="50" y="60" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="white" text-anchor="middle">TUC</text>
                                        </svg>
                                        <div>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Gestion RH</p>
                                        </div>
                                    </div>
                                    <button onclick="appState.toggleSidebar()" class="md:hidden text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <nav class="flex-1 overflow-y-auto py-4">
                                ${navItems.filter(item => item.show).map(item => `
                                    <div onclick="appState.setView('${item.view}')"
                                         class="nav-item ${this.currentView === item.view ? 'active' : ''}">
                                        ${item.icon}
                                        <span>${item.label}</span>
                                    </div>
                                `).join('')}
                            </nav>
                            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-semibold">
                                            ${this.currentUser.prenom[0]}${this.currentUser.nom[0]}
                                        </div>
                                        <div class="overflow-hidden">
                                            <p class="text-sm font-medium text-gray-900 dark:text-white truncate">${this.currentUser.prenom} ${this.currentUser.nom}</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${this.currentUser.email}</p>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="appState.logout()"
                                    class="w-full px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-all flex items-center justify-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    <span>D√©connexion</span>
                                </button>
                            </div>
                        </div>
                    </aside>
                `;
            }

            renderLoginView() {
                return `
                    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary/10 to-purple-100 dark:from-gray-900 dark:to-gray-800 p-4">
                        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md fade-in">
                            <div class="text-center mb-8">
                                <svg class="w-20 h-20 mx-auto mb-4" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="50" cy="50" r="45" fill="#5D5CDE"/>
                                    <text x="50" y="60" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="white" text-anchor="middle">TUC</text>
                                </svg>
                                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">RH TUC</h1>
                                <p class="text-gray-600 dark:text-gray-400 mt-2">Bienvenue sur la plateforme RH</p>
                            </div>

                            <form id="loginForm" class="space-y-6">
                                <div id="loginError" class="hidden bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg text-sm"></div>

                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Email
                                    </label>
                                    <input
                                        type="email"
                                        id="email"
                                        name="email"
                                        required
                                        class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all"
                                        placeholder="votre.email@exemple.fr"
                                    />
                                </div>

                                <div>
                                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Mot de passe
                                    </label>
                                    <input
                                        type="password"
                                        id="password"
                                        name="password"
                                        required
                                        class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    />
                                </div>

                                <button
                                    type="submit"
                                    class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-4 rounded-lg transition-all transform hover:scale-105 flex items-center justify-center space-x-2"
                                    ${this.isLoading ? 'disabled' : ''}
                                >
                                    ${this.isLoading ? `
                                        <div class="loading-spinner border-white" style="width: 20px; height: 20px; border-width: 2px;"></div>
                                        <span>Connexion...</span>
                                    ` : `
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                                        </svg>
                                        <span>Se connecter</span>
                                    `}
                                </button>
                            </form>

                            <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg">
                                <p class="text-sm text-blue-700 dark:text-blue-300 font-medium mb-2">üí° Connexion avec votre compte Railway</p>
                                <p class="text-xs text-blue-600 dark:text-blue-400">Utilisez les identifiants cr√©√©s sur la base de donn√©es PostgreSQL</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderUserDashboard() {
                return `
                    <div class="max-w-7xl mx-auto p-4 md:p-6 fade-in">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">
                            Bonjour ${this.currentUser.prenom} ! üëã
                        </h1>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Mes informations</h2>
                            <div class="space-y-3">
                                <p class="text-gray-700 dark:text-gray-300"><strong>Nom :</strong> ${this.currentUser.nom}</p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>Pr√©nom :</strong> ${this.currentUser.prenom}</p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>Email :</strong> ${this.currentUser.email}</p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>D√©partement :</strong> ${this.currentUser.department || 'Non d√©fini'}</p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>Poste :</strong> ${this.currentUser.poste || 'Non d√©fini'}</p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>R√¥le(s) :</strong> ${this.currentUser.roles.join(', ')}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderAdminDashboard() {
                return `
                    <div class="max-w-7xl mx-auto p-4 md:p-6 fade-in">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">
                            Tableau de bord Administrateur
                        </h1>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl shadow-lg text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-blue-100 text-sm">Collaborateurs</p>
                                        <p class="text-3xl font-bold mt-2">-</p>
                                    </div>
                                    <svg class="w-12 h-12 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                    </svg>
                                </div>
                            </div>

                            <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl shadow-lg text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-green-100 text-sm">Demandes en attente</p>
                                        <p class="text-3xl font-bold mt-2">-</p>
                                    </div>
                                    <svg class="w-12 h-12 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>

                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl shadow-lg text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-purple-100 text-sm">Documents √† valider</p>
                                        <p class="text-3xl font-bold mt-2">-</p>
                                    </div>
                                    <svg class="w-12 h-12 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Informations du compte</h2>
                            <div class="space-y-3">
                                <p class="text-gray-700 dark:text-gray-300"><strong>Nom complet :</strong> ${this.currentUser.prenom} ${this.currentUser.nom}</p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>Email :</strong> ${this.currentUser.email}</p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>D√©partement :</strong> ${this.currentUser.department || 'Direction'}</p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>Poste :</strong> ${this.currentUser.poste || 'Administrateur'}</p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>R√¥le(s) :</strong> ${this.currentUser.roles.join(', ')}</p>
                                <div class="mt-4 p-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg">
                                    <p class="text-sm text-green-700 dark:text-green-300 font-medium">‚úÖ Connect√© √† la base de donn√©es Railway PostgreSQL</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            render() {
                const app = document.getElementById('app');

                let content = '';

                if (this.currentView === 'login') {
                    content = this.renderLoginView();
                } else {
                    const sidebar = this.renderSidebar();
                    let mainContent = '';

                    if (this.currentView === 'user-dashboard') {
                        mainContent = this.renderUserDashboard();
                    } else if (this.currentView === 'admin-dashboard') {
                        mainContent = this.renderAdminDashboard();
                    }

                    content = `
                        ${sidebar}
                        <div class="main-content">
                            <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3 md:hidden">
                                <button onclick="appState.toggleSidebar()" class="text-gray-600 dark:text-gray-400">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                    </svg>
                                </button>
                            </header>
                            ${mainContent}
                        </div>
                    `;
                }

                app.innerHTML = content;

                // Attacher les event listeners
                this.attachEventListeners();
            }

            attachEventListeners() {
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const email = document.getElementById('email').value;
                        const password = document.getElementById('password').value;
                        const errorDiv = document.getElementById('loginError');

                        const success = await this.login(email, password);
                        if (success) {
                            this.render();
                        } else {
                            errorDiv.textContent = 'Email ou mot de passe incorrect';
                            errorDiv.classList.remove('hidden');
                        }
                    });
                }
            }
        }

        // Initialiser l'application
        const appState = new AppState();
    </script>
</body>
</html>
